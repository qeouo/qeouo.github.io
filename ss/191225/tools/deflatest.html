<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="ja" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<title>Deflatest</title>
<style>
.len{
	color:red;
}
.dist{
	color:green;
}
</style>
</head>
<script type="text/javascript" src="../lib/inherits.js"></script>
<script type="text/javascript" src="../lib/util.js"></script>
<script type="text/javascript">
"use strict"
var ctx,canvas;

var demo=function(){
	output_str="";
	var str = src.value;

	if(str.length===0){
		//ãªã‚“ã‚‚å…¥åŠ›ã•ã‚Œã¦ãªã‹ã£ãŸã‚‰ãªã‚“ã‚‚ã—ãªã„
		output.innerHTML=output_str;
		return;
	}
	output_str+="â†“ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰\n"

	//å…¥åŠ›æ–‡å­—åˆ—ã‚’UTF-8ã«å¤‰æ›
	var utf8array=[];
	var utf8str = unescape(encodeURIComponent(str));
	for(var i=0;i<utf8str.length;i++){
		utf8array.push(utf8str.charCodeAt(i));
	}
	output_str+="UTF8("+utf8array.length+"byte):"+format(utf8array)+"\n";

	//deflateåœ§ç¸®ã‚’è¡Œã†
	var encoded =encodeDeflate(utf8array);

	//deflateä¼¸é•·ã‚’è¡Œã†
   	var decode = decodeDeflate(encoded);

	var str ="";
	for(var i=0;i<decode.length;i++){
		str +=String.fromCharCode(decode[i]);
	}
	var utf16str = decodeURIComponent(escape(str));	
	output_str+="å¾©å·çµæœ:"+utf16str+"\n";

	output.innerHTML = output_str;
}
var onloadfunc=function(e){
	var src = document.getElementById("src");
	var output= document.getElementById("output");

	src.addEventListener("input",function(evt){
		demo();
	});
	document.getElementById("comp_mode").addEventListener("change",function(evt){
		demo();
	});

	demo();
}

 var encodeDeflate=function(src){
	//deflateåœ§ç¸®ã‚’è¡Œã†

	//å‡ºåŠ›å…ˆã‚’ç©ºã«ã—ã¦åˆæœŸåŒ–
	output_index=0;
	output_buffer=[];


	//ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆ
	var comp_mode= parseInt(document.getElementById("comp_mode").value);
	encBlock(src,1,comp_mode);

	return  output_buffer;
}

var compressLZ77=function(utf8array){
	//LZ77ã§åœ§ç¸®ã™ã‚‹
	var result=[];

	output_str+="LZ77ç¬¦å·åŒ–:"
	for(var i=0;i<utf8array.length;i++){
		var dist=0;
		var len_max=2;
		for(var j=Math.max(0,i-32767);j<i;j++){
			if(utf8array[i] === utf8array[j]){
				var k=0;
				for(; k<=285;k++){
					if(utf8array[i+k] !== utf8array[j+k] ){
						break;
					}
				}
				if(k>len_max){
					dist=i-j
					len_max=k;
				}
			}
		}
		if(len_max>2){
			result.push({len:len_max,dist:dist});
			i+=len_max-1;

			output_str+="&lt;<span class='len'>"+len_max+"</span>,<span class='dist'>"+dist+"</span>&gt;,"
		}else{
			result.push(utf8array[i]);

			output_str+=utf8array[i]+","
		}
	}
	output_str=output_str.slice(0,-1) + "\n";

	return result;
}

var encBlock=function(src,final,comp_type){
	//1ãƒ–ãƒ­ãƒƒã‚¯åˆ†å‡ºåŠ›ã™ã‚‹

	var lit_list = [];
	var dist_list = [];
	var clen_list = [];

	//BFINAL
	outputBit(final);
	//complession type
	outputBits(comp_type,2);

	output_str+="\n";
	output_str += "BFINALãƒ“ãƒƒãƒˆ:"+final+",åœ§ç¸®ãƒ¢ãƒ¼ãƒ‰ãƒ“ãƒƒãƒˆ:" + ("00"+comp_type.toString(2)).slice(-2);

	if(comp_type===0b00){
		//ç„¡åœ§ç¸®ãƒ¢ãƒ¼ãƒ‰

		//ãƒã‚¤ãƒˆé ­ã¾ã§ç§»å‹•
		if(output_index&7){
			output_index = (output_index&~7)+8;
		}else{
			output_index = (output_index&~7);
		}
		var len=src.length;
		outputBits(len,16);
		outputBits(~len,16);
		for(var i=0;i<src.length;i++){
			outputBits(src[i],8);
		}
		output_str += ",ãƒ‡ãƒ¼ã‚¿é•·:"+len+",ãƒ‡ãƒ¼ã‚¿é•·è£œæ•°:"+(~len);

		output_str+="\n";
	}else{

		output_str += "\n";
		//LZ77åœ§ç¸®ã‚’è¡Œã†
		src = compressLZ77(src);

		if(comp_type===0b01){
			//å›ºå®šãƒãƒ•ãƒãƒ³ç¬¦å·åœ§ç¸®

			//ãƒªãƒ†ãƒ©ãƒ«/é•·ã•ç”¨ã®ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½œã‚‹ãŸã‚ã®ç¬¦å·é•·ãƒªã‚¹ãƒˆ
			for(var i=0;i<=143;i++){ lit_list[i]=8;}
			for(var i=144;i<=255;i++){ lit_list[i]=9;}
			for(var i=256;i<=279;i++){ lit_list[i]=7;}
			for(var i=280;i<=287;i++){ lit_list[i]=8;}

			//è·é›¢ç”¨ã®ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½œã‚‹ãŸã‚ã®ç¬¦å·é•·ãƒªã‚¹ãƒˆ
			for(var i=0;i<=31;i++){ dist_list[i]=5;}

			output_str+="\n";

		}else if(comp_type===0b10){
			//ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ•ãƒãƒ³ç¬¦å·åœ§ç¸®

			//ç¬¦å·é•·ç”¨ã®ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½œã‚‹ãŸã‚ã®ç¬¦å·é•·ãƒªã‚¹ãƒˆ
			for(var i=0;i<19;i++){
				clen_list.push(5);
			}
			//ç¬¦å·é•·ç”¨ã®ãƒãƒ•ãƒãƒ³ç¬¦å·ãƒªã‚¹ãƒˆã‚’ä½œæˆ
			clen_huffmans = createHuffmans(clen_list);

			//ãƒªãƒ†ãƒ©ãƒ«/é•·ã•ç”¨ã®ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½œã‚‹ãŸã‚ã®ç¬¦å·é•·ãƒªã‚¹ãƒˆ
			for(var i=0;i<=143;i++){ lit_list[i]=9;}
			for(var i=144;i<=255;i++){ lit_list[i]=8;}
			for(var i=256;i<=279;i++){ lit_list[i]=8;}
			for(var i=280;i<=287;i++){ lit_list[i]=7;}

			//è·é›¢ç”¨ã®ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½œã‚‹ãŸã‚ã®ç¬¦å·é•·ãƒªã‚¹ãƒˆ
			for(var i=0;i<=10;i++){ dist_list[i]=4;}
			for(var i=11;i<=20;i++){ dist_list[i]=5;}
			for(var i=21;i<=31;i++){ dist_list[i]=6;}

			//ãƒªãƒ†ãƒ©ãƒ«/é•·ã•ç”¨ç¬¦å·é•·ãƒªã‚¹ãƒˆè¦ç´ æ•°ã‚’å‡ºåŠ›
			outputBits(lit_list.length-257,5);
			//è·é›¢ç”¨ç¬¦å·é•·ãƒªã‚¹ãƒˆè¦ç´ æ•°ã‚’å‡ºåŠ›
			outputBits(dist_list.length-1,5);
			//ç¬¦å·é•·ãƒãƒ•ãƒãƒ³ç¬¦å·ç”¨ç¬¦å·é•·ãƒªã‚¹ãƒˆè¦ç´ æ•°ã‚’å‡ºåŠ›
			outputBits(clen_list.length-4,4);
			output_str+=",ãƒªãƒ†ãƒ©ãƒ«/é•·ã•ç¬¦å·é•·æ•°:"+lit_list.length+"-257"
				+ ",è·é›¢ç¬¦å·é•·æ•°:"+dist_list.length +"-1"
				+ ",ç¬¦å·é•·ç¬¦å·é•·æ•°:"+clen_list.length +"-4\n" ;


			output_str+="ç¬¦å·é•·ç¬¦å·é•·ãƒªã‚¹ãƒˆ:"
			//ç¬¦å·é•·ãƒªã‚¹ãƒˆã‹ã‚‰ç¬¦å·é•·ç”¨ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½œæˆ
			for(var i=0;i<clen_list.length;i++){
				outputBits(clen_list[i],3);
				output_str+=clen_list[i]+",";
			}
			output_str=output_str.slice(0,-1)+"\n";

			output_str+="ç¬¦å·é•·ãƒãƒ•ãƒãƒ³ç¬¦å·:"+formatHuffmans(clen_huffmans.enc_huffmans)+"â€¦(ç•¥)\n";

			output_str+="ãƒªãƒ†ãƒ©ãƒ«/é•·ã•ç¬¦å·é•·ãƒªã‚¹ãƒˆ(0ã€œ287):"+lit_list+"\n";
			output_str+="è·é›¢ç¬¦å·é•·ãƒªã‚¹ãƒˆ(0ã€œ31):"+dist_list+"\n";

			//ç¬¦å·é•·ç”¨ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ç”¨ã„ã¦ãƒªãƒ†ãƒ©ãƒ«/é•·ã•ç¬¦å·é•·ãƒªã‚¹ãƒˆã‚’å‡ºåŠ›
			var enc = encodeClen(lit_list,clen_huffmans);
			outputClen(enc,clen_huffmans);

			//ç¬¦å·é•·ç”¨ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ç”¨ã„ã¦è·é›¢ç¬¦å·é•·ãƒªã‚¹ãƒˆã‚’å‡ºåŠ›
			enc = encodeClen(dist_list,clen_huffmans);
			outputClen(enc,clen_huffmans);
		}
		//ç¬¦å·é•·ãƒªã‚¹ãƒˆã‹ã‚‰ãƒªãƒ†ãƒ©ãƒ«/é•·ã•ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½œæˆ
		lit_huffmans = createHuffmans(lit_list);
		output_str+="ãƒªãƒ†ãƒ©ãƒ«/é•·ã•ãƒãƒ•ãƒãƒ³ç¬¦å·:"+formatHuffmans(lit_huffmans.enc_huffmans)+"â€¦(ç•¥)\n";

		//ç¬¦å·é•·ãƒªã‚¹ãƒˆã‹ã‚‰è·é›¢ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½œæˆ
		dist_huffmans = createHuffmans(dist_list);
		output_str+="è·é›¢ãƒãƒ•ãƒãƒ³ç¬¦å·:"+formatHuffmans(dist_huffmans.enc_huffmans)+"â€¦(ç•¥)\n";

		//LZ77ã§åœ§ç¸®ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ•ãƒãƒ³ç¬¦å·åŒ–ã—å‡ºåŠ›
		output_str+="LZ77ç¬¦å·åŒ–æƒ…å ±ã‚’ç¬¦å·+æ‹¡å¼µæƒ…å ±åŒ–:";
		for(var i=0;i<src.length;i++){
			if(!isNaN(src[i])){
				//ãƒªãƒ†ãƒ©ãƒ«ã®å ´åˆã€ãƒªãƒ†ãƒ©ãƒ«/é•·ã•ç”¨ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½¿ã£ã¦å‡ºåŠ›
				outputHuffman(src[i],lit_huffmans);
				output_str+=src[i]+",";
			}else{
				//ç¹°ã‚Šè¿”ã—æƒ…å ±ã®å ´åˆã€é•·ã•ã€è·é›¢ã‚’ç¬¦å·+æ‹¡å¼µæƒ…å ±ã®å½¢ã«å¤‰ãˆãŸå¾Œ
				//ãã‚Œãã‚Œã®ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½¿ã£ã¦å‡ºåŠ›
				
				//é•·ã•ã‚’ç¬¦å·+æ‹¡å¼µæƒ…å ±åŒ–
				var code = src[i].len ;
				var extra_bits=((Math.log2(Math.max(src[i].len-3,4)))|0)-2;
				code =extra_bits*4+((src[i].len-3)>>extra_bits) + 257;
				var extra_data=(src[i].len-3) & ((1<<extra_bits)-1);

				//é•·ã•ç¬¦å·ã‚’ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½¿ã£ã¦å‡ºåŠ›
				outputHuffman(code,lit_huffmans);
				//æ‹¡å¼µæƒ…å ±ã¯ãã®ã¾ã¾å‡ºåŠ›
				outputBits(extra_data,extra_bits);
				output_str+="&lt;<span class='len'>"+code;
				if(extra_bits){
					output_str+="ex"+extra_data
				}
				output_str+="</span>,"
			
				//è·é›¢ã‚’ç¬¦å·+æ‹¡å¼µæƒ…å ±åŒ–
				code = src[i].dist ;
				extra_bits=((Math.log2(Math.max(src[i].dist-1,2)))|0)-1;
				code =extra_bits*2+((src[i].dist-1)>>extra_bits) ;
				var extra_data=(src[i].dist-1) & ((1<<extra_bits)-1);

				//è·é›¢ç¬¦å·ã‚’ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½¿ã£ã¦å‡ºåŠ›
				outputHuffman(code,dist_huffmans);
				///æ‹¡å¼µæƒ…å ±ã¯ãã®ã¾ã¾å‡ºåŠ›
				outputBits(extra_data,extra_bits);

				output_str+="<span class='dist'>"+code;
				if(extra_bits){
					output_str+="ex"+extra_data
				}
				output_str+="</span>,"
				output_str=output_str.slice(0,-1)+"&gt;,";
			}
		}
		output_str=output_str.slice(0,-1)+"\n";
		//ãƒ–ãƒ­ãƒƒã‚¯çµ‚äº†ç¬¦å·(256)ã‚’ãƒªãƒ†ãƒ©ãƒ«/é•·ã•ãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ä½¿ã£ã¦å‡ºåŠ›
		outputHuffman(256,lit_huffmans);
		output_str+="\nä¸Šè¨˜æƒ…å ±ã‚’ãƒãƒ•ãƒãƒ³ç¬¦å·åŒ–ã—ã¦";
	}

	output_str+="å…¨éƒ¨åˆã‚ã›ãŸæœ€çµ‚çµæœ("+ output_buffer.length+"byte):\n"+formatBinary()+"\n";
}

var expandLZ77=function(data){
	//LZ77åœ§ç¸®ãƒ‡ãƒ¼ã‚¿ã‚’ä¼¸é•·ã™ã‚‹
	var decode=[];
	for(var i=0;i<data.length;i++){
		if(!isNaN(data[i])){
			//ãƒªãƒ†ãƒ©ãƒ«ã®å ´åˆãã®ã¾ã¾å‡ºåŠ›
			decode.push(data[i]);
		}else{
			//ç¹°ã‚Šè¿”ã—ã®å ´åˆãã‚Œã‚’å‡ºåŠ›
			var idx=decode.length-data[i].dist;
			for(var j=0;j<data[i].len;j++){
				decode.push(decode[idx+j]);
			}
		}
	}
	return decode;

}

var clen_huffmans=[]; //ãƒ‡ãƒ¼ã‚¿é•·ãƒ‡ãƒ¼ã‚¿ç”¨ãƒãƒ•ãƒãƒ³ç¬¦å·æƒ…å ±
var lit_huffmans=[]; //ãƒªãƒ†ãƒ©ãƒ«/é•·ã•ç”¨ãƒãƒ•ãƒãƒ³ç¬¦å·æƒ…å ±
var dist_huffmans=[];//è·é›¢ç”¨ãƒãƒ•ãƒãƒ³ç¬¦å·æƒ…å ±
const MAX_BITS=15; //ãƒãƒ•ãƒãƒ³ç¬¦å·ã«ä½¿ã†æœ€å¤§ãƒ“ãƒƒãƒˆé•·

var createHuffmans=function(lenlist){
	//ãƒ“ãƒƒãƒˆé•·ãƒªã‚¹ãƒˆã‹ã‚‰ãƒãƒ•ãƒãƒ³ç¬¦å·æƒ…å ±ã‚’ä½œæˆã™ã‚‹
	var enc_huffmans=[];
	var max_bits=0;
	for(var i=0;i<lenlist.length;i++){
		var t = {};
		t.Len = lenlist[i];
		t.Code  = 0;
		enc_huffmans.push(t);

		if(max_bits<lenlist[i]){
			max_bits = lenlist[i];
		}
	}


	var bl_count=new Array(max_bits+1);
	for(var i=0;i<bl_count.length;i++){
		bl_count[i]=0;
	}
	for(var i=0;i<enc_huffmans.length;i++){
		bl_count[enc_huffmans[i].Len]++;
	}
   var code = 0;
   var next_code = new Array(max_bits+1);
   for (var bits = 1; bits <next_code.length; bits++) {
       code = (code + bl_count[bits-1]) << 1;
       next_code[bits] = code;
   }
   for (var n = 0; n < enc_huffmans.length; n++) {
       var len = enc_huffmans[n].Len;
       if (len != 0) {
           enc_huffmans[n].Code = next_code[len];
           next_code[len]++;
       }
   }

	var dec_huffmans={};
	for(var i=0;i<enc_huffmans.length;i++){
		dec_huffmans[enc_huffmans[i].Code]=i;
	}

	var huffmans={};
	huffmans.enc_huffmans=enc_huffmans;
	huffmans.dec_huffmans=dec_huffmans;

	return huffmans;
}

var output_str=""; //ç”»é¢å‡ºåŠ›ç”¨
var output_buffer=[]; //åœ§ç¸®æƒ…å ±å‡ºåŠ›å…ˆ
var output_index=0; //output_bufferã®æ›¸ãè¾¼ã¿/èª­ã¿è¾¼ã¿ä½ç½®ã‚’ç¤ºã™å¤‰æ•°

var outputBit=function(bit){ 
	//1ãƒ“ãƒƒãƒˆouput_bufferã«æ›¸ãè¾¼ã‚€
	//æ›¸ãè¾¼ã‚“ã ã‚ã¨indexã‚’1ãƒ“ãƒƒãƒˆã™ã™ã‚ã‚‹
	output_buffer[output_index>>3] &=  ~(1<<(output_index&7));
	output_buffer[output_index>>3] |=bit<<(output_index&7);

	output_index++;
}
var outputBits=function(bits,len){
	//ãƒ“ãƒƒãƒˆåˆ—ã‚’output_bufferã«æ›¸ãè¾¼ã‚€
	for(var i=0;i<len;i++){
		outputBit((bits>>i)&1);
	}
}
var outputBitsReverse=function(bits,len){
	//ãƒ“ãƒƒãƒˆåˆ—ã‚’é€†é †(ä¸Šä½ãƒ“ãƒƒãƒˆã‹ã‚‰é †ç•ª)ã«output_bufferã«æ›¸ãè¾¼ã‚€
	//ãƒãƒ•ãƒãƒ³ç¬¦å·æ ¼ç´ç”¨

	for(var i=len-1;i>=0;i--){
		outputBit((bits>>i)&1);
	}
}

var outputHuffman=function(value,tree){
	//å€¤ã‚’ãƒãƒ•ãƒãƒ³ç¬¦å·åŒ–ã—output_bufferã«æ›¸ãè¾¼ã‚€
	var t = tree.enc_huffmans[value];
	outputBitsReverse(t.Code,t.Len);
}

var outputClen=function(src,tree){
	//ã‚³ãƒ¼ãƒ‰é•·ã‚’ãƒãƒ•ãƒãƒ³ç¬¦å·åŒ–ã—output_bufferã«æ›¸ãè¾¼ã‚€
	for(var i=0;i<src.length;i++){
		var value = src[i];
		if(value<=15){
			outputHuffman(value,tree);
		}else if(value===16){
				outputHuffman(value,tree);
				i++;
				outputBits(src[i],2);
	}else if(value===17){
				outputHuffman(value,tree);
				i++;
				outputBits(src[i],3);
	}else if(value===18){
				outputHuffman(value,tree);
				i++;
				outputBits(src[i],7);
			}
		}
}

var readBit=function(){
	//åœ§ç¸®æƒ…å ±output_bufferã‹ã‚‰output_indexã®ä½ç½®ã®ãƒ“ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿
	//èª­ã¿è¾¼ã‚“ã ã‚ã¨output_indexã‚’1ã¤ã™ã™ã‚ã‚‹
	var bit=(output_buffer[output_index>>3] >> (output_index&7))&1;
	output_index++;
	return bit;

}

var readBits=function(len){
	//output_bufferã‹ã‚‰lenåˆ†èª­ã¿è¾¼ã¿
	var bits=0;
	for(var i=0;i<len;i++){
		bits=bits | (readBit()<<i);
	}
	return bits;
}

var readBitsReverse=function(len){
	//output_bufferã‹ã‚‰lenåˆ†èª­ã¿è¾¼ã¿
	//èª­ã¿è¾¼ã‚“ã ãƒ“ãƒƒãƒˆã¯é«˜æ¬¡ãƒ“ãƒƒãƒˆã‹ã‚‰æ ¼ç´ã•ã‚Œã‚‹
	//ãƒãƒ•ãƒãƒ³ç¬¦å·èª­ã¿è¾¼ã¿ç”¨
	var bits=0;
	for(var i=0;i<len;i++){
		bits=(bits<<1) | readBit();
	}
	return bits;
}

var readHuffman = function(tree){
	//ãƒãƒ•ãƒãƒ³ç¬¦å·ã®ã©ã‚Œã‹ã«ä¸€è‡´ã™ã‚‹ã¾ã§
	//output_bufferã‹ã‚‰1ãƒã‚¤ãƒˆãšã¤èª­ã¿ã“ã¿
	//ä¸€è‡´ã—ãŸãƒãƒ•ãƒãƒ³ç¬¦å·ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸå€¤ã‚’è¿”ã™

	var dec_huffmans=tree.dec_huffmans;
	var enc_huffmans=tree.enc_huffmans;
	for(var i=1;i<=MAX_BITS;i++){
		var value =readBitsReverse(i); 
		var deccode = dec_huffmans[value];
		if(deccode != null){
			if(enc_huffmans[deccode].Len === i){
				return deccode;
			}
		}
		
		output_index-=i;
	}
	return null;
}

var encodeClen=function(lenlist){
	//ç¬¦å·é•·ãƒªã‚¹ãƒˆã‚’0~18ã®ç¬¦å·åˆ—ã«å¤‰æ›ã™ã‚‹

	var clen=[];
	for(var i=0;i<lenlist.length;i++){
		var target = lenlist[i];
		var count=1;
		for(;count+i<lenlist.length && target===lenlist[i+count];count++){ }
		i+=count-1;
		if(target===0){
			while(count){
				if(count<3){
					clen.push(0);
					count-=1;
				}else if(count<11){
					clen.push(17);
					clen.push(count-3);
					count=0;
				}else if(count<139){
					clen.push(18);
					clen.push(count-11);
					count=0;
				}else{
					clen.push(18);
					clen.push(127);
					count-=138;
				}
			}
		}else{
			clen.push(target);
			count-=1;
			while(count){
				if(count<3){
					clen.push(target);
					count-=1;
				}else if(count<7){
					clen.push(16);
					clen.push(count-3);
					count=0;
				}else{
					clen.push(16);
					clen.push(3);
					count-=6;
				}
			}
		}
		
	}
	return clen;



}
var decodeClen=function(size,clen_huffmans){
	//ãƒãƒ•ãƒãƒ³ç¬¦å·åŒ–ã•ã‚ŒãŸ0~18ã®ç¬¦å·åˆ—ã‹ã‚‰
	//ç¬¦å·é•·ãƒªã‚¹ãƒˆã‚’å¾©å…ƒã™ã‚‹

	var lenlist=[];
	while(1){
		if(lenlist.length>=size){
			break;
		}
		var value = readHuffman(clen_huffmans);
		if(value<=15){
			lenlist.push(value);
		}else if(value===16){
			//ç›´å‰å€¤3~6ã‚³ãƒ”ãƒ¼
			var extra = readBits(2);
			var org = lenlist[lenlist.length-1];
			
			for(var j=0;j<extra+3;j++){
				lenlist.push(org);
			}
		}else if(value===17){
			//3~10ã‚¼ãƒ­åŸ‹ã‚
			var extra = readBits(3);
			
			for(var j=0;j<extra+3;j++){
				lenlist.push(0);
			}
		}else if(value===18){
			//11~138ã‚¼ãƒ­åŸ‹ã‚
			var extra = readBits(7);
			
			for(var j=0;j<extra+11;j++){
				lenlist.push(0);
			}
		}
		
	}
	return lenlist;

}

var decBlock=function(){
	//Deflateåœ§ç¸®ã•ã‚ŒãŸæƒ…å ±ã‚’ä¼¸é•·ã™ã‚‹

	var decdata=[];
	var bfinal = 0;

	//æœ€çµ‚ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¼¸é•·ã—ãŸå¾Œã¯ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
	while(!bfinal){

		bfinal =readBit();
		var compless_type=readBits(2);

		if(compless_type===0b00){
			//ç„¡åœ§ç¸®
			if(output_index&7){
				output_index = (output_index&~7)+8;
			}else{
				output_index = (output_index&~7);
			}
			var len=readBits(16);
			readBits(16);
			for(var i=0;i<len;i++){
				decdata.push(readBits(8));
			}
			output_index+=len*8;
		}else if(compless_type === 0b01 || compless_type===0b10){
			var lenlist =[];
			if(compless_type===0b01){
				//å›ºå®šãƒãƒ•ãƒãƒ³
				for(var i=0;i<=143;i++){ lenlist[i]=8;}
				for(var i=144;i<=255;i++){ lenlist[i]=9;}
				for(var i=256;i<=279;i++){ lenlist[i]=7;}
				for(var i=280;i<=287;i++){ lenlist[i]=8;}
				lit_huffmans = createHuffmans(lenlist);

				lenlist =[];
				for(var i=0;i<=31;i++){ lenlist[i]=5;}
				dist_huffmans = createHuffmans(lenlist);
			}else{
				//ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒãƒ•ãƒãƒ³
				var hlit = readBits(5);
				var hdist = readBits(5);
				var hclen = readBits(4);

				//ã‚³ãƒ¼ãƒ‰é•·ã‚³ãƒ¼ãƒ‰å¾©å·
				var idx = [16, 17, 18, 0, 8, 7, 9, 6, 10, 5, 11, 4, 12, 3, 13, 2, 14, 1, 15];
			
				for(var i=0;i<idx.length;i++){
					if(i<hclen+4){
						lenlist[idx[i]]=readBits(3);
					}else{
						lenlist[idx[i]]=0;
					}
				}
				var clen_huffmans = createHuffmans(lenlist);

				//é•·ã•ãƒ“ãƒƒãƒˆé•·ãƒªã‚¹ãƒˆå¾©å…ƒ
				lenlist = decodeClen(hlit+257,clen_huffmans);
				lit_huffmans = createHuffmans(lenlist);

				//è·é›¢ãƒ“ãƒƒãƒˆé•·ãƒªã‚¹ãƒˆå¾©å…ƒ
				lenlist = decodeClen(hlit+1,clen_huffmans);
				dist_huffmans = createHuffmans(lenlist);
			}

			while(1){
				var value = readHuffman(lit_huffmans);

				if(value <256){
					//ãƒªãƒ†ãƒ©ãƒ«
					decdata.push(value);
				}else{
					if(value ==256){
						//çµ‚äº†ç¬¦å·
						break;
					}
					var a ={};

					//é•·ã•
					var extra_bits = value-261;
					if(extra_bits>=0){
						extra_bits = extra_bits>>2;
						value =value-257;
						var offset = 4+(extra_bits*4);
						var extra_data = readBits(extra_bits);
						value =((value -offset)<<extra_bits) + (4<<extra_bits) + extra_data;
					}else{
						value =value -257;
					}
					a.len=value+3;


					//è·é›¢
					value = readHuffman(dist_huffmans);
					//value = readBitsReverse(5);
					extra_bits = value -2;
					if(extra_bits>=0){
						extra_bits = extra_bits>>1;
						var offset = 2+(extra_bits*2);
						var extra_data = readBits(extra_bits);
						value =((value -offset)<<extra_bits) + (2<<extra_bits) + extra_data;
					}
					a.dist=value+1;
					decdata.push(a);
				}
			}

			output_str+="ãƒãƒ•ãƒãƒ³å¾©å·åŒ–:"+format(decdata)+"\n";

			decdata =expandLZ77(decdata);
			output_str+="LZ77å¾©å·åŒ–:"+format(decdata)+"\n";
		}
	}

	return decdata;

}

var format=function(src){
	//
	var result="";
	for(var i=0;i<src.length;i++){
		if(i!==0){
			result+=",";
		}

		if(isNaN(src[i])){
	 		result+="&lt;"+src[i].len.toString(10)+","+src[i].dist.toString(10)+"&gt;";
		}else{
			result+=src[i].toString(10);
		}
	}
	return result;
}
var formatBinary=function(){
	var result="";
	for(var i=0;i<output_buffer.length;i++){
		if(i!==0){
			result+=",";
		}
		result+=('00000000' +output_buffer[i].toString(2)).slice(-8);
	}
	return result;
}
var formatHuffmans=function(huffmans){
	var result="";
	for(var i=0;i<huffmans.length && i<3 ;i++){
		if(i!==0){
			result+=",";
		}
		result+=('0000000000' +huffmans[i].Code.toString(2)).slice(-huffmans[i].Len);
	}
	return result;
}


	 var decodeDeflate=function(src){
		output_index=0;
		output_str+="\n\nâ†“ã“ã£ã‹ã‚‰ãƒ‡ã‚³ãƒ¼ãƒ‰\n"

		var result =decBlock(src);


	 	return result;
	 }

</script>

<body onLoad="onloadfunc(event)">

å…ƒãƒ†ã‚­ã‚¹ãƒˆ<input type="text" id ="src" size="128" value="ã†ã‚‰ã«ã‚ã«ã¯ã«ã‚ã«ã‚ã«ã¯ã«ã‚ã«ã‚ã¨ã‚ŠãŒã„ã‚‹ğŸ”ğŸ”ğŸ”ğŸŠğŸ”ğŸŠğŸ”ğŸŠğŸ”ğŸŠ"><br>
åœ§ç¸®ãƒ¢ãƒ¼ãƒ‰<select id="comp_mode">
<option value="0">ç„¡åœ§ç¸®</option>
<option value="1" >å›ºå®šãƒãƒ•ãƒãƒ³ç¬¦å·</option>
<option value="2" selected>ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ•ãƒãƒ³ç¬¦å·</option>
<select>
<div id="output" style="white-space:pre;"><div>
</body>
</html>

