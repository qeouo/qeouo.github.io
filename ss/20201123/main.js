!function(){var e={10:function(){Command.resizeLayer=function(e,t){var n=e.param;if(-1===n.layer_id){for(var r=[],a=Layer.layerArray(),i=0;i<a.length;i++)if((s=a[i])!==root_layer){var o=new CommandLog;o.command="resizeLayer",o.param={layer_id:s.id,width:n.width,height:n.height},r.push(o)}return e.command="multiCommand",e.param={logs:r},void Command[e.command](e)}var s,l=(s=Layer.findById(n.layer_id)).img;if(l){var u=l.width,c=l.height,f=n.width,d=n.height;if(t&&(f=e.undo_data.width,d=e.undo_data.height),!e.undo_data){e.undo_data={width:u,height:c};var h,p=u-f,v=c-d;e.undo_data.difs=[],p>0&&(h=Hdrpaint.createDif(s,f,0,p,c),e.undo_data.difs.push(h)),v>0&&(h=Hdrpaint.createDif(s,0,d,u,v),e.undo_data.difs.push(h))}var m=l;s.img=new Img(f,d),s.size[0]=f,s.size[1]=d,Img.copy(s.img,0,0,m,0,0,m.width,m.height),s.refreshDiv(),s.registRefreshThumbnail(),s.parent&&s.parent.bubbleComposite()}}},776:function(e){function t(e){return Promise.resolve().then((function(){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}))}t.keys=function(){return[]},t.resolve=t,t.id=776,e.exports=t}},t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={exports:{}};return e[r](a,a.exports,n),a.exports}n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},function(){"use strict";function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var t,r,i,o,s,l,u,c,f,d,h,p,v,m,y,g,b,w,_,x,k=((t=function(){this[0]=0,this[1]=0}).copy=function(e,t){e[0]=t[0],e[1]=t[1]},t.scalar=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])},t.scalar2=function(e){return e[0]*e[0]+e[1]*e[1]},t.set=function(e,t,n){e[0]=t,e[1]=n},t.add=function(e,t,n){e[0]=t[0]+n[0],e[1]=t[1]+n[1]},t.sub=function(e,t,n){e[0]=t[0]-n[0],e[1]=t[1]-n[1]},t.mul=function(e,t,n){e[0]=t[0]*n,e[1]=t[1]*n},t.madd=function(e,t,n,r){e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r},t.len=function(e,t){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))},t.len2=function(e,t){return(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])},t.nrm=function(e,t){var n=Math.sqrt(t[0]*t[0]+t[1]*t[1]);n=1/n,isFinite(n)&&(e[0]*=n,e[1]*=n)},t.norm=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]);t=1/t,isFinite(t)&&(e[0]*=t,e[1]*=t)},t.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},t.cross=function(e,t){return e[0]*t[1]-e[1]*t[0]},t),M=function(){var e=function(){var e=new Float32Array(3);return e[0]=0,e[1]=0,e[2]=0,e},t=e;t.ZERO=new e,t.set=function(e,t,n,r){e[0]=t,e[1]=n,e[2]=r},t.copy=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2]},t.add=function(e,t,n){e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2]},t.sub=function(e,t,n){e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2]},t.copy=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2]},t.mult=function(e,t,n){e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n},t.mul=function(e,t,n){e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n},t.madd=function(e,t,n,r){e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r},t.len=function(e,t){var n=e[0]-t[0],r=e[1]-t[1],a=e[2]-t[2];return Math.sqrt(n*n+r*r+a*a)},t.len2=function(e,t){var n=e[0]-t[0],r=e[1]-t[1],a=e[2]-t[2];return n*n+r*r+a*a},t.scalar=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},t.scalar2=function(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]},t.nrm=function(e,t){var n=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);0!=n&&(n=1/n,e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n)},t.norm=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);0!=t&&(t=1/t,e[0]*=t,e[1]*=t,e[2]*=t)},t.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},t.vecmul=function(e,t,n){e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2]},t.cross=function(e,t,n){var r=t[1]*n[2]-t[2]*n[1],a=t[2]*n[0]-t[0]*n[2],i=t[0]*n[1]-t[1]*n[0];e[0]=r,e[1]=a,e[2]=i};var n=new e,r=new e;return t.cross3=function(t,a,i,o,s){e.sub(n,i,a),e.sub(r,s,o),e.cross(t,n,r)},t.cross2=function(e,n,r,a){t.cross3(e,n,r,n,a)},t}(),I=function(){var e,t,n,r,a,i,o,s,l,u,c,f,d,h,p,v,m,y,g,b,w,_=function(){var e=new Float32Array(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},x=_;return x.set=function(e,t,n,r,a){e[0]=t,e[1]=n,e[2]=r,e[3]=a},x.copy=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]},x.add=function(e,t,n){e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3]},x.sub=function(e,t,n){e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3]},x.mul=function(e,t,n){e[0]*=n,e[1]*=n,e[2]*=n,e[3]*=n},x.set=function(e,t,n,r,a){e[0]=t,e[1]=n,e[2]=r,e[3]=a},x.qdot=function(a,i,o){e=i[0]*o[0]-i[1]*o[1]-i[2]*o[2]-i[3]*o[3],t=i[0]*o[1]+o[0]*i[1]+i[2]*o[3]-i[3]*o[2],n=i[0]*o[2]+o[0]*i[2]+i[3]*o[1]-i[1]*o[3],r=i[0]*o[3]+o[0]*i[3]+i[1]*o[2]-i[2]*o[1],a[0]=e,a[1]=t,a[2]=n,a[3]=r},x.qmul=function(e,t,n){if(1==t[0])return e[0]=t[0],e[1]=t[1],e[2]=t[2],void(e[3]=t[3]);var r=Math.acos(t[0]),a=Math.sin(r*n)/Math.sin(r);e[0]=Math.cos(r*n),e[1]=t[1]*a,e[2]=t[2]*a,e[3]=t[3]*a},x.qmdot=function(a,i,o){e=i[0]*o[0]+i[1]*o[1]+i[2]*o[2]+i[3]*o[3],t=-i[0]*o[1]+o[0]*i[1]-i[2]*o[3]+i[3]*o[2],n=-i[0]*o[2]+o[0]*i[2]-i[3]*o[1]+i[1]*o[3],r=-i[0]*o[3]+o[0]*i[3]-i[1]*o[2]+i[2]*o[1],a[0]=Math.min(1,Math.max(-1,e)),a[1]=t,a[2]=n,a[3]=r},x.fromRotVector=function(e,t,n,r,a){var i=Math.sin(.5*t);e[0]=Math.cos(.5*t),e[1]=i*n,e[2]=i*r,e[3]=i*a},x.toTorque=function(e,t){var n=2*Math.acos(t[0]);0!==n?n/=Math.sin(.5*n):n=0,e[0]=t[1]*n,e[1]=t[2]*n,e[2]=t[3]*n},x.rotVec3=function(a,i,o){e=-i[1]*o[0]-i[2]*o[1]-i[3]*o[2],t=i[0]*o[0]+i[2]*o[2]-i[3]*o[1],n=i[0]*o[1]+i[3]*o[0]-i[1]*o[2],r=i[0]*o[2]+i[1]*o[1]-i[2]*o[0],a[0]=-e*i[1]+i[0]*t-n*i[3]+r*i[2],a[1]=-e*i[2]+i[0]*n-r*i[1]+t*i[3],a[2]=-e*i[3]+i[0]*r-t*i[2]+n*i[1]},x.toMat33=function(e,t){a=t[1]*t[1]*2,i=t[2]*t[2]*2,o=t[3]*t[3]*2,s=t[1]*t[2]*2,l=t[2]*t[3]*2,u=t[3]*t[1]*2,c=t[1]*t[0]*2,f=t[2]*t[0]*2,d=t[3]*t[0]*2,e[0]=1-i-o,e[1]=s+d,e[2]=u-f,e[3]=s-d,e[4]=1-o-a,e[5]=l+c,e[6]=u+f,e[7]=l-c,e[8]=1-a-i},x.toMat43=x.qTOm=function(e,t){a=t[1]*t[1]*2,i=t[2]*t[2]*2,o=t[3]*t[3]*2,s=t[1]*t[2]*2,l=t[2]*t[3]*2,u=t[3]*t[1]*2,c=t[1]*t[0]*2,f=t[2]*t[0]*2,d=t[3]*t[0]*2,e[0]=1-i-o,e[1]=s+d,e[2]=u-f,e[3]=s-d,e[4]=1-o-a,e[5]=l+c,e[6]=u+f,e[7]=l-c,e[8]=1-a-i,e[9]=e[10]=e[11]=0},x.slerp=function(e,t,n,r){h=t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3],p=1-h*h,v=0,h<0&&(v=1,h*=-1),p<=0?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]):(m=Math.sqrt(p),y=Math.acos(h),g=y*r,b=Math.sin(g)/m,w=Math.sin(y-g)/m,v&&(b*=-1),e[0]=t[0]*w+n[0]*b,e[1]=t[1]*w+n[1]*b,e[2]=t[2]*w+n[2]*b,e[3]=t[3]*w+n[3]*b)},x.fromMat44=function(e,t){var n=E.poolAlloc();n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[4],n[4]=t[5],n[5]=t[6],n[6]=t[8],n[7]=t[9],n[8]=t[10],E.rotToQuat(e,n),E.poolFree(1)},x.fromMat33=function(e,t){var n=1/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),r=1/Math.sqrt(t[3]*t[3]+t[4]*t[4]+t[5]*t[5]),a=1/Math.sqrt(t[6]*t[6]+t[7]*t[7]+t[8]*t[8]),i=E.poolAlloc();i[0]=t[0]*n,i[1]=t[1]*n,i[2]=t[2]*n,i[3]=t[3]*r,i[4]=t[4]*r,i[5]=t[5]*r,i[6]=t[6]*a,i[7]=t[7]*a,i[8]=t[8]*a,E.getRotVec(e,i);var o=M.scalar(e);0!==o?(M.mul(e,e,1/o),_.fromRotVector(e,o,e[0],e[1],e[2])):_.set(e,0,0,0,1),E.poolFree(1)},x}(),E=function(){var e=function e(){var t=new Float32Array(9);return e.setInit(t),t},t=e;t.setInit=function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},t.ZERO=new e,t.ZERO[0]=0,t.ZERO[4]=0,t.ZERO[8]=0;var n=new e;return new M,t.set=function(e,t,n,r,a,i,o,s,l,u){e[0]=t,e[1]=n,e[2]=r,e[3]=a,e[4]=i,e[5]=o,e[6]=s,e[7]=l,e[8]=u},t.copy=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8]},t.add=function(e,t,n){e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e[8]=t[8]+n[8]},t.madd=function(e,t,n,r){e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e[4]=t[4]+n[4]*r,e[5]=t[5]+n[5]*r,e[6]=t[6]+n[6]*r,e[7]=t[7]+n[7]*r,e[8]=t[8]+n[8]*r},t.sub=function(e,t,n){e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e[6]=t[6]-n[6],e[7]=t[7]-n[7],e[8]=t[8]-n[8]},t.mul=function(e,t,n){e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n},t.dotVec3=function(e,t,n){var r=n[0],a=n[1],i=n[2];e[0]=t[0]*r+t[3]*a+t[6]*i,e[1]=t[1]*r+t[4]*a+t[7]*i,e[2]=t[2]*r+t[5]*a+t[8]*i},t.dot=function(e,t,r){n[0]=t[0]*r[0]+t[3]*r[1]+t[6]*r[2],n[1]=t[1]*r[0]+t[4]*r[1]+t[7]*r[2],n[2]=t[2]*r[0]+t[5]*r[1]+t[8]*r[2],n[3]=t[0]*r[3]+t[3]*r[4]+t[6]*r[5],n[4]=t[1]*r[3]+t[4]*r[4]+t[7]*r[5],n[5]=t[2]*r[3]+t[5]*r[4]+t[8]*r[5],n[6]=t[0]*r[6]+t[3]*r[7]+t[6]*r[8],n[7]=t[1]*r[6]+t[4]*r[7]+t[7]*r[8],n[8]=t[2]*r[6]+t[5]*r[7]+t[8]*r[8],e.set(n)},t.fromRotVector=function(e,t,n,r,a){var i=Math.sin(t),o=Math.cos(t);e[0]=n*n*(1-o)+o,e[3]=n*r*(1-o)-a*i,e[6]=a*n*(1-o)+r*i,e[1]=n*r*(1-o)+a*i,e[4]=r*r*(1-o)+o,e[7]=r*a*(1-o)-n*i,e[2]=a*n*(1-o)-r*i,e[5]=r*a*(1-o)+n*i,e[8]=a*a*(1-o)+o},t.getRotVec=function(e,t){var n=.5*(t[0]+t[4]+t[8]-1);if(n*n>=1)M.set(e,0,0,0);else{var r=Math.acos(n),a=Math.sin(r);e[0]=t[5]-t[7],e[1]=t[6]-t[2],e[2]=t[1]-t[3],M.mul(e,e,r/(2*a))}},t.rotToQuat=function(e,t){e[1]=t[0]-t[4]-t[8]+1,e[2]=-t[0]+t[4]-t[8]+1,e[3]=-t[0]-t[4]+t[8]+1,e[0]=t[0]+t[4]+t[8]+1;for(var n=0,r=1;r<4;r++)e[r]>e[n]&&(n=r);if(!(e[n]<0)){var a=.5*Math.sqrt(e[n]);e[n]=a;var i=.25/a;switch(n){case 1:e[2]=(t[1]+t[3])*i,e[3]=(t[2]+t[6])*i,e[0]=(t[5]-t[7])*i;break;case 2:e[1]=(t[1]+t[3])*i,e[3]=(t[7]+t[5])*i,e[0]=(t[6]-t[2])*i;break;case 3:e[1]=(t[7]+t[5])*i,e[2]=(t[2]+t[6])*i,e[0]=(t[1]-t[3])*i;break;case 0:e[1]=(t[5]-t[7])*i,e[2]=(t[6]-t[2])*i,e[3]=(t[1]-t[3])*i}}},t.getRotQuat=function(t,n){return e.rotToQuat(t,n)},t.getEulerXYZ=function(e,t){e[1]=Math.asin(t[2]),1==t[2]||-1==t[2]?(e[0]=0,e[2]=Math.atan2(-t[3],[4])):(e[0]=Math.atan2(t[5],t[8]),e[2]=Math.atan2(t[1],t[0]))},t.getEuler=function(e,t){e[2]=Math.asin(t[1]),1==t[1]||-1==t[1]?(e[0]=0,e[1]=Math.atan2(t[8],[6])):(e[0]=Math.atan2(-t[7],t[4]),e[1]=Math.atan2(-t[2],t[0]))},t.getInv=function(e,t){var n=t[0]*t[4]*t[8]+t[3]*t[7]*t[2]+t[6]*t[1]*t[5]-t[6]*t[4]*t[2]-t[3]*t[1]*t[8]-t[0]*t[7]*t[5];if(n){n=1/n;var r=(t[4]*t[8]-t[7]*t[5])*n,a=(t[7]*t[2]-t[1]*t[8])*n,i=(t[1]*t[5]-t[4]*t[2])*n,o=(t[6]*t[5]-t[3]*t[8])*n,s=(t[0]*t[8]-t[6]*t[2])*n,l=(t[3]*t[2]-t[0]*t[5])*n,u=(t[3]*t[7]-t[6]*t[4])*n,c=(t[6]*t[1]-t[0]*t[7])*n,f=(t[0]*t[4]-t[3]*t[1])*n;e[0]=r,e[1]=a,e[2]=i,e[3]=o,e[4]=s,e[5]=l,e[6]=u,e[7]=c,e[8]=f}else this.mul(t,t,0)},t.calcTranspose=function(e,t){var n;n=t[1],e[1]=t[3],e[3]=n,n=t[2],e[2]=t[6],e[6]=n,n=t[5],e[5]=t[7],e[7]=n},t.rotate=function(e,t,n,r,a){var i=Math.sin(t),o=Math.cos(t);e[0]=n*n*(1-o)+o,e[3]=n*r*(1-o)-a*i,e[6]=a*n*(1-o)+r*i,e[1]=n*r*(1-o)+a*i,e[4]=r*r*(1-o)+o,e[7]=r*a*(1-o)-n*i,e[2]=a*n*(1-o)-r*i,e[5]=r*a*(1-o)+n*i,e[8]=a*a*(1-o)+o},t}(),L=function(){var e=function e(){var t=new Float32Array(12);return e.setInit(t),t},t=e,n=new Float32Array(12);return t.setInit=function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e[9]=0,e[10]=0,e[11]=0},t.set=function(e,t,n,r,a,i,o,s,l,u,c,f,d){e[0]=t,e[1]=n,e[2]=r,e[3]=a,e[4]=i,e[5]=o,e[6]=s,e[7]=l,e[8]=u,e[9]=c,e[10]=f,e[11]=d},t.copy=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11]},t.copyMat44=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e[9]=t[12],e[10]=t[13],e[11]=t[14]},t.mul=function(e,t,n){e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n},t.dotVec3=function(e,t,n){var r=n[0],a=n[1],i=n[2];e[0]=t[0]*r+t[3]*a+t[6]*i+t[9],e[1]=t[1]*r+t[4]*a+t[7]*i+t[10],e[2]=t[2]*r+t[5]*a+t[8]*i+t[11]},t.dotMat33Vec3=function(e,t,n){var r=n[0],a=n[1],i=n[2];e[0]=t[0]*r+t[3]*a+t[6]*i,e[1]=t[1]*r+t[4]*a+t[7]*i,e[2]=t[2]*r+t[5]*a+t[8]*i},t.dotVec4=function(e,t,n){var r=n[0],a=n[1],i=n[2],o=n[3];e[0]=t[0]*r+t[3]*a+t[6]*i+t[9]*o,e[1]=t[1]*r+t[4]*a+t[7]*i+t[10]*o,e[2]=t[2]*r+t[5]*a+t[8]*i+t[11]*o,e[3]=o},t.dot=function(e,t,r){n[0]=t[0]*r[0]+t[3]*r[1]+t[6]*r[2],n[1]=t[1]*r[0]+t[4]*r[1]+t[7]*r[2],n[2]=t[2]*r[0]+t[5]*r[1]+t[8]*r[2],n[3]=t[0]*r[3]+t[3]*r[4]+t[6]*r[5],n[4]=t[1]*r[3]+t[4]*r[4]+t[7]*r[5],n[5]=t[2]*r[3]+t[5]*r[4]+t[8]*r[5],n[6]=t[0]*r[6]+t[3]*r[7]+t[6]*r[8],n[7]=t[1]*r[6]+t[4]*r[7]+t[7]*r[8],n[8]=t[2]*r[6]+t[5]*r[7]+t[8]*r[8],n[9]=t[0]*r[9]+t[3]*r[10]+t[6]*r[11]+t[9],n[10]=t[1]*r[9]+t[4]*r[10]+t[7]*r[11]+t[10],n[11]=t[2]*r[9]+t[5]*r[10]+t[8]*r[11]+t[11],e.set(n)},t.dotMat44Mat43=function(e,t,n){var r=t[0]*n[0]+t[4]*n[1]+t[8]*n[2],a=t[1]*n[0]+t[5]*n[1]+t[9]*n[2],i=t[2]*n[0]+t[6]*n[1]+t[10]*n[2],o=t[0]*n[3]+t[4]*n[4]+t[8]*n[5],s=t[1]*n[3]+t[5]*n[4]+t[9]*n[5],l=t[2]*n[3]+t[6]*n[4]+t[10]*n[5],u=t[0]*n[6]+t[4]*n[7]+t[8]*n[8],c=t[1]*n[6]+t[5]*n[7]+t[9]*n[8],f=t[2]*n[6]+t[6]*n[7]+t[10]*n[8],d=t[0]*n[9]+t[4]*n[10]+t[8]*n[11]+t[12],h=t[1]*n[9]+t[5]*n[10]+t[9]*n[11]+t[13],p=t[2]*n[9]+t[6]*n[10]+t[10]*n[11]+t[14];e[0]=r,e[1]=a,e[2]=i,e[3]=o,e[4]=s,e[5]=l,e[6]=u,e[7]=c,e[8]=f,e[9]=d,e[10]=h,e[11]=p},t.fromRotVector=function(e,t,n,r,a){var i=Math.sin(t),o=Math.cos(t);e[0]=n*n*(1-o)+o,e[3]=n*r*(1-o)-a*i,e[6]=a*n*(1-o)+r*i,e[1]=n*r*(1-o)+a*i,e[4]=r*r*(1-o)+o,e[7]=r*a*(1-o)-n*i,e[2]=a*n*(1-o)-r*i,e[5]=r*a*(1-o)+n*i,e[8]=a*a*(1-o)+o,e[9]=e[10]=e[11]=0},t.getRotVector=function(e,t){var n=this.poolAlloc(),r=t[0],a=t[1],i=t[2],o=Math.atan2(a,i)+Math.PI,s=Math.atan2(r,i);this.fromRotVector(e,-0,0,0,1),this.fromRotVector(n,-o,1,0,0),this.dot(e,e,n),this.fromRotVector(n,-s,0,1,0),this.dot(e,e,n),this.poolFree(1)},t.getInv=function(e,t){var n=t[0]*t[4]*t[8]+t[3]*t[7]*t[2]+t[6]*t[1]*t[5]-t[0]*t[7]*t[5]-t[3]*t[1]*t[8]-t[6]*t[4]*t[2];if(!(Math.abs(n)<1e-4)){n=1/n;var r=t[0],a=t[1],i=t[2],o=t[3],s=t[4],l=t[5],u=t[6],c=t[7],f=t[8],d=t[9],h=t[10],p=t[11];e[0]=(s*f-c*l)*n,e[1]=(i*c-a*f)*n,e[2]=(a*l-s*i)*n,e[3]=(u*l-o*f)*n,e[4]=(r*f-u*i)*n,e[5]=(o*i-r*l)*n,e[6]=(o*c-s*u)*n,e[7]=(u*a-r*c)*n,e[8]=(r*s-o*a)*n,e[9]=(o*h*f+u*s*p+d*c*l-o*c*p-u*h*l-d*s*f)*n,e[10]=(r*c*p+u*h*i+d*a*f-r*h*f-u*a*p-d*c*i)*n,e[11]=(r*h*l+o*a*p+d*s*i-r*s*p-o*h*i-d*a*l)*n}},t.fromQuat=function(e,t){var n=t[1]*t[1]*2,r=t[2]*t[2]*2,a=t[3]*t[3]*2,i=t[1]*t[2]*2,o=t[2]*t[3]*2,s=t[3]*t[1]*2,l=t[1]*t[0]*2,u=t[2]*t[0]*2,c=t[3]*t[0]*2;e[0]=1-r-a,e[1]=i+c,e[2]=s-u,e[3]=i-c,e[4]=1-a-n,e[5]=o+l,e[6]=s+u,e[7]=o-l,e[8]=1-n-r,e[9]=e[10]=e[11]=0},t.fromEuler=function(n,r){var a=e.poolAlloc();t.fromRotVector(n,r[0],1,0,0),t.fromRotVector(a,r[2],0,0,1),e.dot(n,a,n),t.fromRotVector(a,r[1],0,1,0),e.dot(n,a,n),e.poolFree(1)},t.fromLSE=function(t,n,r,a){e.fromEuler(t,a),t[0]*=r[0],t[1]*=r[0],t[2]*=r[0],t[3]*=r[1],t[4]*=r[1],t[5]*=r[1],t[6]*=r[2],t[7]*=r[2],t[8]*=r[2],t[9]=n[0],t[10]=n[1],t[11]=n[2]},t.fromLSR=function(t,n,r,a){e.fromQuat(t,a),t[0]*=r[0],t[1]*=r[0],t[2]*=r[0],t[3]*=r[1],t[4]*=r[1],t[5]*=r[1],t[6]*=r[2],t[7]*=r[2],t[8]*=r[2],t[9]=n[0],t[10]=n[1],t[11]=n[2]},t.toLSR=function(e,t,n,r){M.set(e,r[9],r[10],r[11]),M.set(t,Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),Math.sqrt(r[3]*r[3]+r[4]*r[4]+r[5]*r[5]),Math.sqrt(r[6]*r[6]+r[7]*r[7]+r[8]*r[8]));var a=1/t[0],i=1/t[1],o=1/t[2],s=new E;s[0]=r[0]*a,s[1]=r[1]*a,s[2]=r[2]*a,s[3]=r[3]*i,s[4]=r[4]*i,s[5]=r[5]*i,s[6]=r[6]*o,s[7]=r[7]*o,s[8]=r[8]*o,E.getRotQuat(n,s)},t.toLSE=function(e,t,n,r){M.set(e,r[9],r[10],r[11]),M.set(t,Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),Math.sqrt(r[3]*r[3]+r[4]*r[4]+r[5]*r[5]),Math.sqrt(r[6]*r[6]+r[7]*r[7]+r[8]*r[8]));var a=1/t[0],i=1/t[1],o=1/t[2],s=new E;s[0]=r[0]*a,s[1]=r[1]*a,s[2]=r[2]*a,s[3]=r[3]*i,s[4]=r[4]*i,s[5]=r[5]*i,s[6]=r[6]*o,s[7]=r[7]*o,s[8]=r[8]*o,E.getEuler(n,s)},t}(),C=(new Float32Array(16),function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var e=new Float32Array(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}var n,a;return n=t,a=[{key:"setInit",value:function(){mat[0]=1,mat[1]=0,mat[2]=0,mat[3]=0,mat[4]=0,mat[5]=1,mat[6]=0,mat[7]=0,mat[8]=0,mat[9]=0,mat[10]=1,mat[11]=0,mat[12]=0,mat[13]=0,mat[14]=0,mat[15]=1}},{key:"set",value:function(e,t,n,r,a,i,o,s,l,u,c,f,d,h,p,v,m){e[0]=t,e[1]=n,e[2]=r,e[3]=a,e[4]=i,e[5]=o,e[6]=s,e[7]=l,e[8]=u,e[9]=c,e[10]=f,e[11]=d,e[12]=h,e[13]=p,e[14]=v,e[15]=m}},{key:"copy",value:function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]}},{key:"copyMat43",value:function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=t[9],e[13]=t[10],e[14]=t[11],e[15]=1}},{key:"mul",value:function(e,t,n){e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12]*n,e[13]=t[13]*n,e[14]=t[14]*n,e[15]=t[15]*n}},{key:"dotVec3",value:function(e,t,n){r=n[0],i=n[1],o=n[2],e[0]=t[0]*r+t[4]*i+t[8]*o+t[12],e[1]=t[1]*r+t[5]*i+t[9]*o+t[13],e[2]=t[2]*r+t[6]*i+t[10]*o+t[14]}},{key:"dotMat33Vec3",value:function(e,t,n){r=n[0],i=n[1],o=n[2],e[0]=t[0]*r+t[4]*i+t[8]*o,e[1]=t[1]*r+t[5]*i+t[9]*o,e[2]=t[2]*r+t[6]*i+t[10]*o}},{key:"dotVec4",value:function(e,t,n){r=n[0],i=n[1],o=n[2],s=n[3],e[0]=t[0]*r+t[4]*i+t[8]*o+t[12]*s,e[1]=t[1]*r+t[5]*i+t[9]*o+t[13]*s,e[2]=t[2]*r+t[6]*i+t[10]*o+t[14]*s,e[3]=t[3]*r+t[7]*i+t[11]*o+t[15]*s}},{key:"dot",value:function(e,t,n){e==t?(r=t[0],i=t[1],o=t[2],s=t[3],l=t[4],u=t[5],c=t[6],f=t[7],d=t[8],h=t[9],p=t[10],v=t[11],m=t[12],y=t[13],g=t[14],b=t[15],e[0]=r*n[0]+l*n[1]+d*n[2]+m*n[3],e[1]=i*n[0]+u*n[1]+h*n[2]+y*n[3],e[2]=o*n[0]+c*n[1]+p*n[2]+g*n[3],e[3]=s*n[0]+f*n[1]+v*n[2]+b*n[3],e[4]=r*n[4]+l*n[5]+d*n[6]+m*n[7],e[5]=i*n[4]+u*n[5]+h*n[6]+y*n[7],e[6]=o*n[4]+c*n[5]+p*n[6]+g*n[7],e[7]=s*n[4]+f*n[5]+v*n[6]+b*n[7],e[8]=r*n[8]+l*n[9]+d*n[10]+m*n[11],e[9]=i*n[8]+u*n[9]+h*n[10]+y*n[11],e[10]=o*n[8]+c*n[9]+p*n[10]+g*n[11],e[11]=s*n[8]+f*n[9]+v*n[10]+b*n[11],e[12]=r*n[12]+l*n[13]+d*n[14]+m*n[15],e[13]=i*n[12]+u*n[13]+h*n[14]+y*n[15],e[14]=o*n[12]+c*n[13]+p*n[14]+g*n[15],e[15]=s*n[12]+f*n[13]+v*n[14]+b*n[15]):(r=n[0],i=n[1],o=n[2],s=n[3],l=n[4],u=n[5],c=n[6],f=n[7],d=n[8],h=n[9],p=n[10],v=n[11],m=n[12],y=n[13],g=n[14],b=n[15],e[0]=t[0]*r+t[4]*i+t[8]*o+t[12]*s,e[1]=t[1]*r+t[5]*i+t[9]*o+t[13]*s,e[2]=t[2]*r+t[6]*i+t[10]*o+t[14]*s,e[3]=t[3]*r+t[7]*i+t[11]*o+t[15]*s,e[4]=t[0]*l+t[4]*u+t[8]*c+t[12]*f,e[5]=t[1]*l+t[5]*u+t[9]*c+t[13]*f,e[6]=t[2]*l+t[6]*u+t[10]*c+t[14]*f,e[7]=t[3]*l+t[7]*u+t[11]*c+t[15]*f,e[8]=t[0]*d+t[4]*h+t[8]*p+t[12]*v,e[9]=t[1]*d+t[5]*h+t[9]*p+t[13]*v,e[10]=t[2]*d+t[6]*h+t[10]*p+t[14]*v,e[11]=t[3]*d+t[7]*h+t[11]*p+t[15]*v,e[12]=t[0]*m+t[4]*y+t[8]*g+t[12]*b,e[13]=t[1]*m+t[5]*y+t[9]*g+t[13]*b,e[14]=t[2]*m+t[6]*y+t[10]*g+t[14]*b,e[15]=t[3]*m+t[7]*y+t[11]*g+t[15]*b)}},{key:"dotMat43",value:function(e,t,n){r=t[0]*n[0]+t[4]*n[1]+t[8]*n[2],i=t[1]*n[0]+t[5]*n[1]+t[9]*n[2],o=t[2]*n[0]+t[6]*n[1]+t[10]*n[2],s=t[3]*n[0]+t[7]*n[1]+t[11]*n[2],l=t[0]*n[3]+t[4]*n[4]+t[8]*n[5],u=t[1]*n[3]+t[5]*n[4]+t[9]*n[5],c=t[2]*n[3]+t[6]*n[4]+t[10]*n[5],f=t[3]*n[3]+t[7]*n[4]+t[11]*n[5],d=t[0]*n[6]+t[4]*n[7]+t[8]*n[8],h=t[1]*n[6]+t[5]*n[7]+t[9]*n[8],p=t[2]*n[6]+t[6]*n[7]+t[10]*n[8],v=t[3]*n[6]+t[7]*n[7]+t[11]*n[8],m=t[0]*n[9]+t[4]*n[10]+t[8]*n[11]+t[12],y=t[1]*n[9]+t[5]*n[10]+t[9]*n[11]+t[13],g=t[2]*n[9]+t[6]*n[10]+t[10]*n[11]+t[14],b=t[3]*n[9]+t[7]*n[10]+t[11]*n[11]+t[15],e[0]=r,e[1]=i,e[2]=o,e[3]=s,e[4]=l,e[5]=u,e[6]=c,e[7]=f,e[8]=d,e[9]=h,e[10]=p,e[11]=v,e[12]=m,e[13]=y,e[14]=g,e[15]=b}},{key:"getRotVector",value:function(e,t){L.getRotVector.call(this,e,t)}},{key:"getInv",value:function(e,t){var n=t[0]*t[5]*t[10]*t[15]+t[0]*t[9]*t[14]*t[7]+t[0]*t[13]*t[6]*t[11]+t[4]*t[1]*t[14]*t[11]+t[4]*t[9]*t[2]*t[15]+t[4]*t[13]*t[10]*t[3]+t[8]*t[1]*t[6]*t[15]+t[8]*t[5]*t[14]*t[3]+t[8]*t[13]*t[2]*t[7]+t[12]*t[1]*t[10]*t[7]+t[12]*t[5]*t[2]*t[11]+t[12]*t[9]*t[6]*t[3]-t[0]*t[5]*t[14]*t[11]-t[0]*t[9]*t[6]*t[15]-t[0]*t[13]*t[10]*t[7]-t[4]*t[1]*t[10]*t[15]-t[4]*t[9]*t[14]*t[3]-t[4]*t[13]*t[2]*t[11]-t[8]*t[1]*t[14]*t[7]-t[8]*t[5]*t[2]*t[15]-t[8]*t[13]*t[6]*t[3]-t[12]*t[1]*t[6]*t[11]-t[12]*t[5]*t[10]*t[3]-t[12]*t[9]*t[2]*t[7];Math.abs(n)<1e-12||(n=1/n,r=t[0],i=t[1],o=t[2],s=t[3],l=t[4],u=t[5],c=t[6],f=t[7],d=t[8],h=t[9],p=t[10],v=t[11],m=t[12],y=t[13],g=t[14],b=t[15],e[0]=(u*p*b+h*g*f+y*c*v-u*g*v-h*c*b-y*p*f)*n,e[4]=(l*g*v+d*c*b+m*p*f-l*p*b-d*g*f-m*c*v)*n,e[8]=(l*h*b+d*y*f+m*u*v-l*y*v-d*u*b-m*h*f)*n,e[12]=(l*y*p+d*u*g+m*h*c-l*h*g-d*y*c-m*u*p)*n,e[1]=(i*g*v+h*o*b+y*p*s-i*p*b-h*g*s-y*o*v)*n,e[5]=(r*p*b+d*g*s+m*o*v-r*g*v-d*o*b-m*p*s)*n,e[9]=(r*y*v+d*i*b+m*h*s-r*h*b-d*y*s-m*i*v)*n,e[13]=(r*h*g+d*y*o+m*i*p-r*y*p-d*i*g-m*h*o)*n,e[2]=(i*c*b+u*g*s+y*o*f-i*g*f-u*o*b-y*c*s)*n,e[6]=(r*g*f+l*o*b+m*c*s-r*c*b-l*g*s-m*o*f)*n,e[10]=(r*u*b+l*y*s+m*i*f-r*y*f-l*i*b-m*u*s)*n,e[14]=(r*y*c+l*i*g+m*u*o-r*u*g-l*y*o-m*i*c)*n,e[3]=(i*p*f+u*o*v+h*c*s-i*c*v-u*p*s-h*o*f)*n,e[7]=(r*c*v+l*p*s+d*o*f-r*p*f-l*o*v-d*c*s)*n,e[11]=(r*h*f+l*i*v+d*u*s-r*u*v-l*h*s-d*i*f)*n,e[15]=(r*u*p+l*h*o+d*i*c-r*h*c-l*i*p-d*u*o)*n)}}],null&&e(n.prototype,null),a&&e(n,a),t}());function O(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function B(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}x=function(e,t,n,r,a){var i=Math.sin(t),o=Math.cos(t);e[0]=n*n*(1-o)+o,e[4]=n*r*(1-o)-a*i,e[8]=a*n*(1-o)+r*i,e[1]=n*r*(1-o)+a*i,e[5]=r*r*(1-o)+o,e[9]=r*a*(1-o)-n*i,e[2]=a*n*(1-o)-r*i,e[6]=r*a*(1-o)+n*i,e[10]=a*a*(1-o)+o,e[3]=e[7]=e[11]=e[12]=e[13]=e[14]=0,e[15]=1},(_="fromRotVector")in(w=C)?Object.defineProperty(w,_,{value:x,enumerable:!0,configurable:!0,writable:!0}):w[_]=x,function(){for(var e=[k,M,I,E,L,C],t=0;t<e.length;t++){var n=e[t];n.poolIndex=0,n.pool=[];for(var r=0;r<256;r++)n.pool.push(new n);n.poolAlloc=function(){return this.poolIndex++,this.pool[this.poolIndex-1]},n.poolFree=function(e){this.poolIndex-=e}}}(),window.globalParam={},document.all,window.navigator.userAgent.toLowerCase().indexOf(!0)&&(globalParam.windows=1);var A,P,R,T,U,V=0,j=30,S=0,D=0,F=0,N=0,q=0,z=new Array(256);z[37]=q++,z[38]=q++,z[39]=q++,z[40]=q++,z[" ".charCodeAt(0)]=q++,z["X".charCodeAt(0)]=q++,z["C".charCodeAt(0)]=q++,z["V".charCodeAt(0)]=q++,z["A".charCodeAt(0)]=q++,z["W".charCodeAt(0)]=q++,z["D".charCodeAt(0)]=q++,z["S".charCodeAt(0)]=q++,z["F".charCodeAt(0)]=q++,z["G".charCodeAt(0)]=q++,z["H".charCodeAt(0)]=q++,z["J".charCodeAt(0)]=q++;var X=null,Y=null,H=null,W=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"getLoadingCount",value:function(){return V}},{key:"mainloop",value:function(){var e,t,n;for(util.tap=0,util.pressOn?(util.pressCount=util.pressCount+1,1==util.pressCount&&(util.oldcursorX2=util.cursorX,util.oldcursorY2=util.cursorY,util.oldcursorX=util.cursorX,util.oldcursorY=util.cursorY)):util.pressCount>0?(e=util.cursorX-util.oldcursorX2,t=util.cursorY-util.oldcursorY2,util.pressCount<10&&e*e+t*t<16&&(util.tap=1),util.pressCount=-1):util.pressCount=0,util.pressOnRight?util.pressCountRight+=1:util.pressCountRight=0,0==V&&R(),util.oldcursorX=util.cursorX,util.oldcursorY=util.cursorY,n=util.keyflag.length;n--;)util.keyflagOld[n]=util.keyflag[n]}},{key:"loadImage",value:function(t,n,r){var a=new Image,i=!0;if(globalParam.files)for(var o,s=0;o=globalParam.files[s];s++)if(escape(o.name)==t){var l=new FileReader;l.onload=function(e){a.src=e.target.result},l.readAsDataURL(o),i=!1;break}return i&&(a.src=t),V++,a.onerror=function(){V--},console.log("load start",t),a.addEventListener("load",(function(t){a.pat||(console.log("load end",a),V--,a.pat=n?e.ctx.createPattern(a,"no-repeat"):e.ctx.createPattern(a,"repeat"),P.clearRect(0,0,A.width,A.height),P.drawImage(a,0,0),P.getImageData&&(a.imagedata=P.getImageData(0,0,a.width,a.height))),r&&r(a)})),a}},{key:"loadText",value:function(t,n){var r=!0,a=t.match("([^/]+?)([?#;].*)?$")[1];if(globalParam.files)for(var i,o=0;i=globalParam.files[o];o++)if(escape(i.name)==a){var s=new FileReader;s.onload=function(e){var t=e.target.result;n&&n(t)},s.readAsText(i),r=!1;break}if(r){var l=e.createXMLHttpRequest();l.open("GET",t,!0),l.onload=function(e){if(200==l.status||304==l.status){var t=l.responseText;n&&n(t)}V--,console.log("loadtext end",V)},console.log("loadtext start",t),V++,l.send("")}return null}},{key:"loadFile",value:function(e,t){var n=new FileReader;n.onload=function(e){t&&t(e.target.result)},n.readAsDataURL(e)}},{key:"loadBinary",value:function(t,n){if("string"!=typeof t)return e.loadFile(t,(function(t){e.loadBinary(t,n)})),null;var r=n;console.log("loadbinary start"),V++;var a=e.createXMLHttpRequest();a.open("GET",t,!0),a.responseType="arraybuffer",a.onload=function(e){var t;t=a.response,r&&r(t),V--,console.log("loadbinary end",V)},a.send("")}},{key:"rgb",value:function(e,t,n){return e=(256|255*e).toString(16),t=(256|255*t).toString(16),n=(256|255*n).toString(16),"#"+e.slice(-2)+t.slice(-2)+n.slice(-2)}},{key:"hex2rgb",value:function(e,t){return t+="000000",e[0]=parseInt(t.slice(0,2),16)/255,e[1]=parseInt(t.slice(2,4),16)/255,e[2]=parseInt(t.slice(4,6),16)/255,e}},{key:"rgba",value:function(e,t,n,r){return"rgba("+e+","+t+","+n+","+r+")"}},{key:"hsv2rgb",value:function(e,t){var n,r,a,i,o=t[2],s=t[0],l=t[1];switch(r=o*(1-l),a=o*(1-l*(n=6*s-(6*s|0))),i=o*(1-l*(1-n)),(6*s|0)%6){case 0:e[0]=o,e[1]=i,e[2]=r;break;case 1:e[0]=a,e[1]=o,e[2]=r;break;case 2:e[0]=r,e[1]=o,e[2]=i;break;case 3:e[0]=r,e[1]=a,e[2]=o;break;case 4:e[0]=i,e[1]=r,e[2]=o;break;case 5:e[0]=o,e[1]=r,e[2]=a}return e}},{key:"rgb2hsv",value:function(e,t){var n=Math.max(t[0],Math.max(t[1],t[2])),r=Math.min(t[0],Math.min(t[1],t[2]));return n==r?e[0]=0:n==t[0]?e[0]=1/6*(t[1]-t[2])/(n-r)+1:n==t[1]?e[0]=1/6*(t[2]-t[0])/(n-r)+2/6:n==t[2]&&(e[0]=1/6*(t[0]-t[1])/(n-r)+4/6),e[0]-=0|e[0],e[1]=0==n?0:(n-r)/n,e[2]=n,e}},{key:"init",value:function(t,n,r){if(e.canvasgl=n,e.canvas=t,!e.canvas||!e.canvas.getContext)return!1;T=e.canvas.getAttribute("width"),U=e.canvas.getAttribute("height"),e.ctx=e.canvas.getContext("2d"),e.ctx.clearRect(0,0,T,U),A=e.createCanvas(1024,1024),P=A.getContext("2d");var a=r;a&&(a.onselect=function(){return!1},a.onselectstart=function(){return!1});var i=function(t,n){var r=e.canvasgl,a=r.width/r.clientWidth,i=r.height/r.clientHeight;e.cursorX=(t-r.offsetLeft)*a,e.cursorY=(n-r.offsetTop)*i},o=function(e){if(e.currentTarget.getBoundingClientRect){var t=e.currentTarget.getBoundingClientRect();e.relativeX=e.clientX-t.left,e.relativeY=e.clientY-t.top}},s=function(e,t){e.pageX=t.pageX,e.pageY=t.pageY,e.layerX=t.layerX,e.layerY=t.layerY,e.clientX=t.clientX,e.clientY=t.clientY};e.mouseMove=function(e,t){e&&(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/Android/i)?e.addEventListener("touchmove",(function(e){s(e,e.touches[0]),o(e),t(e)})):e.addEventListener("mousemove",(function(e){e=e||window.event,o(e),t(e)}),!1))},e.mouseDown=function(e,t){e&&(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/Android/i)?e.addEventListener("touchstart",(function(e){s(e,e.touches[0]),o(e),e.button=0,t(e)})):e.addEventListener("mousedown",(function(e){e=e||window.event,o(e),t(e)})))},e.mouseUp=function(e,t){navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/Android/i)?e.addEventListener("touchend",(function(e){s(e,e.changedTouches[0]),o(e),e.button=0,t(e)})):e.addEventListener("mouseup",(function(e){e=e||window.event,o(e),t(e)}))},e.mouseMove(a,(function(t){if(i(t.pageX,t.pageY),"block"===X.style.display){t.currentTarget,e.padX=(t.relativeX-X.offsetLeft)/X.offsetWidth*2-1,e.padY=(t.relativeY-X.offsetTop)/X.offsetHeight*2-1;var n=e.padX*e.padX+e.padY*e.padY;n>1&&(n=Math.sqrt(n),e.padX=e.padX/n,e.padY=e.padY/n,X.style.left=t.relativeX-e.padX*X.offsetWidth*.5+"px",X.style.top=t.relativeY-e.padY*X.offsetHeight*.5+"px"),l()}})),e.mouseDown(a,(function(t){switch(i(t.pageX,t.pageY),t.button){case 0:e.pressOn=1;break;case 2:e.pressOnRight=1}})),e.mouseUp(window,(function(t){switch(i(t.pageX,t.pageY),t.button){case 0:e.pressOn=0,e.padX=0,e.padY=0,X.style.display="none";break;case 2:e.pressOnRight=0}e.keyflag[4]=0}));var l=function(){Y.style.left=50*(e.padX+1)+"%",Y.style.top=50*(e.padY+1)+"%"},u=document.getElementById("vertualPadArea");if(e.mouseDown(u,(function(t){switch(t.button){case 0:X.style.display="block",e.padX=0,e.padY=0,X.style.left=t.relativeX+"px",X.style.top=t.relativeY+"px",l(),t.stopPropagation()}})),navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/Android/i));else{var c=function(t){(t=t||window.event).wheelDelta?(e.wheelDelta=t.wheelDelta/120,window.opera&&(e.wheelDelta=-e.wheelDelta)):t.detail&&(e.wheelDelta=-t.detail/3),t.preventDefault&&t.preventDefault()};window.addEventListener?window.addEventListener("DOMMouseScroll",c,{passive:!0}):document.attachEvent?document.attachEvent("onmousewheel",c):a&&(a.onmousewheel=c),document.body.onkeydown=function(t){var r=(t=t||window.event).keyCode;null!=e.keymap[r]&&(e.keyflag[e.keymap[r]]=1),13==r&&(e.canvasgl.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT),window.parent.screen.width/e.canvasgl.width>window.parent.screen.height/e.canvasgl.height?(n.style.width="auto",n.style.height="100%"):(n.style.width="100%",n.style.height="auto"))},document.body.onkeyup=function(t){var n=(t=t||window.event).keyCode;null!=e.keymap[n]&&(e.keyflag[e.keymap[n]]=0)},document.body.onblur=function(t){(t=t||window.event).keyCode;for(var n=0;n<e.keyflag.length;n++)e.keyflag[n]=0}}(X=document.createElement("div")).style.backgroundColor="#ff0000",X.style.opacity="0.3",X.style.width="256px",X.style.height="256px",X.style.position="absolute",X.style.left="10px",X.style.top="10px",X.style.borderRadius="50%",X.style.zIndex="10",X.style.display="none",X.style.marginLeft="-128px",X.style.marginTop="-128px",a&&a.appendChild(X),(Y=document.createElement("div")).style.backgroundColor="#00ff00",Y.style.width="32px",Y.style.height="32px",Y.style.position="absolute",Y.style.borderRadius="50%",Y.style.marginLeft="-16px",Y.style.marginTop="-16px",X.appendChild(Y),(H=document.createElement("div")).style.backgroundColor="#0000ff",H.style.opacity="0.25",H.style.width="256px",H.style.height="256px",H.style.position="absolute",H.style.right="10%",H.style.bottom="20%",H.style.borderRadius="50%",H.style.zIndex="100",H.style.display="none",H.innerHTML="jump",a&&a.appendChild(H),e.enableVirtualBtn&&(H.style.display="inline"),navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/Android/i)?(H.addEventListener("touchstart",(function(t){t=t||window.event,e.keyflag[4]=1}),!1),window.addEventListener("touchend",(function(t){t=t||window.event,e.keyflag[4]=0}),!1),H.addEventListener("touchmove",(function(e){}),!1),H.addEventListener("touchend",(function(t){e.keyflag[4]=0}),!1)):(H.onmousedown=function(t){t=t||window.event,e.keyflag[4]=1},H.onmouseup=function(t){t=t||window.event,e.keyflag[4]=0})}},{key:"setFps",value:function(t,n){S=1e3/(j=0|t)|0,F=0,N=1e3%j,D=performance.now(),R=n,e.pressCount=0}},{key:"drawText",value:function(e,t,n,r,a,i,o){var s,l,u,c,f=t,d=n;for(s=0,l=r.length;s<l;s++)c=((u=r.charCodeAt(s)-32)>>4)*i,u=(15&u)*o,e.drawImage(a,u,c,i,o,f,d,i,o),f+=i}},{key:"convertURLcode",value:function(e){var t,n,r,a,i=e.length,o="%".charCodeAt(0),s="";for(n=0;n<i;n++){if((a=e.charCodeAt(n))==o)for(n++,224==(240&(a=parseInt(e.slice(n,n+2),16)))?(t=2,a&=15):192==(224&a)?(t=1,a&=31):t=0,n+=1,r=0;r<t;r++)n+=2,a<<=6,a|=63&parseInt(e.slice(n,n+2),16),n+=1;s+=String.fromCharCode(a)}return s}},{key:"fireEvent",value:function(e,t,n){document.all?e.fireEvent("on"+t):(n||(n=document.createEvent("Event")),n.initEvent(t,!0,!0),e.dispatchEvent(n))}},{key:"setText",value:function(e,t){e.innerText=t}},{key:"getText",value:function(e){return e.textContent?e.textContent:e.innerText}},{key:"getLoadingCount",value:function(){return V}},{key:"stringToUtf8",value:function(e){for(var t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length),r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return n}},{key:"utf8ToString",value:function(e){for(var t="",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return decodeURIComponent(escape(t))}}],null&&O(t.prototype,null),n&&O(t,n),e}();function G(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}B(W,"ctx",null),B(W,"canvas",null),B(W,"canvasgl",null),B(W,"cursorX",0),B(W,"cursorY",0),B(W,"padX",0),B(W,"padY",0),B(W,"wheelDelta",0),B(W,"pressOn",0),B(W,"pressCount",0),B(W,"pressOnRight",0),B(W,"pressCountRight",0),B(W,"oldcursorX",0),B(W,"oldcursorY",0),B(W,"screenscale",1),B(W,"tap",0),B(W,"keyflag",[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),B(W,"keyflagOld",[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),B(W,"keymap",z),B(W,"enablePad",1),B(W,"createCanvas",(function(e,t){var n=document.createElement("canvas");return"undefined"!=typeof G_vmlCanvasManager&&(n=G_vmlCanvasManager.initElement(n)),n.setAttribute("width",e),n.setAttribute("height",t),n})),B(W,"createXMLHttpRequest",(function(){if(window.XMLHttpRequest)return new XMLHttpRequest;if(!window.ActiveXObject)return null;try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){return null}}})),B(W,"fpsman",(function(){var e=performance.now(),t=D-e;t>S&&(t=S),t<-S&&(t=-S),(F+=N)>=j&&(F-=j,t+=1),D=e+S+t,mainloop(),e=performance.now(),(t=D-e)<=0&&(t=1),setTimeout(fpsman,t)})),B(W,"getCurrent",(function(){var e="/";if(document.currentScript)e=document.currentScript.src;else{var t=document.getElementsByTagName("script"),n=t[t.length-1];n.src&&(e=n.src)}return e.substring(0,e.lastIndexOf("/")+1)})),B(W,"loadJs",(function(e,t){V++;var r=t;n(776)(e).then((function(){V--,r&&r()})).catch((function(){V--}))}));var Q=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.byteBuffer="number"==typeof t?new Uint8Array(t):r?new Uint8Array(t,n,r):new Uint8Array(t),this.dv=new DataView(this.byteBuffer.buffer,this.byteBuffer.byteOffset,this.byteBuffer.byteLength),this.idx=0}var t,n;return t=e,(n=[{key:"getByteIndex",value:function(){return this.idx>>>3}},{key:"fill",value:function(e,t){for(var n=0;n<t;n++)this.setUint8(e)}},{key:"setInt32",value:function(e,t){this.dv.setInt32(this.idx>>3,e,t),this.idx+=32}},{key:"getInt32",value:function(e){var t=this.dv.getInt32(this.idx>>3,e);return this.idx+=32,t}},{key:"setUint8",value:function(e){this.dv.setUint8(this.idx>>3,e),this.idx+=8}},{key:"getUint8",value:function(e){var t=this.dv.getUint8(this.idx>>3,e);return this.idx+=8,t}},{key:"setUint32",value:function(e,t){this.dv.setUint32(this.idx>>3,e,t),this.idx+=32}},{key:"getUint32",value:function(e){var t=this.dv.getUint32(this.idx>>3,e);return this.idx+=32,t}},{key:"setUint16",value:function(e,t){this.dv.setUint16(this.idx>>3,e,t),this.idx+=16}},{key:"getUint16",value:function(e){var t=this.dv.getUint16(this.idx>>3,e);return this.idx+=16,t}},{key:"setUint64",value:function(e,t){var n=e/4294967296|0,r=4294967295&e;t?(this.setUint32(r,t),this.setUint32(n,t)):(this.setUint32(n,t),this.setUint32(r,t))}},{key:"getUint64",value:function(e){var t=this.getUint32(e),n=this.getUint32(e);return e?(n<<32)+t:(t<<32)+n}},{key:"setFloat32",value:function(e,t){this.dv.setFloat32(this.idx>>3,e,t),this.idx+=32}},{key:"getFloat32",value:function(e){var t=this.dv.getFloat32(this.idx>>3,e);return this.idx+=32,t}},{key:"setBytes",value:function(e){for(var t=0;t<e.length;t++)this.setUint8(e[t])}},{key:"getBytes",value:function(e){for(var t=new Uint8Array(e),n=0;n<e;n++)t[n]=this.getUint8();return t}},{key:"setTextBuf",value:function(e,t){for(var n=W.stringToUtf8(e),r=(this.dv,0);r<n.length;r++)this.setUint8(n[r]);t&&this.setUint8(0)}},{key:"readTextBuf",value:function(){for(var e,t=this.dv,n=[];0!==(e=t.getUint8(this.idx>>3));)n.push(e),this.idx+=8;return this.idx+=8,W.utf8ToString(n)}},{key:"setFloat16",value:function(e,t){this.dv;var n=1-Math.sign(e)>>1,r=Math.abs(e),a=Math.floor(Math.log2(r)),i=n<<15|a+15<<10|1024*(r=r/Math.pow(2,a)-1)&1023;this.setUint16(i,t)}},{key:"readFloat16",value:function(e){this.dv;var t=this.getUint16(e);if(0===t)return 0;var n=t>>15&1,r=(t>>10&31)-15;return(n=1-2*n)*(1*(1023&t)/1024+1)*Math.pow(2,r)}},{key:"outputBit",value:function(e){this.byteBuffer[this.idx>>3]&=~(1<<(7&this.idx)),this.byteBuffer[this.idx>>3]|=e<<(7&this.idx),this.idx++}},{key:"outputBits",value:function(e,t){for(var n=0;n<t;n++)this.outputBit(e>>n&1)}},{key:"outputBitsReverse",value:function(e,t){for(var n=t-1;n>=0;n--)this.outputBit(e>>n&1)}},{key:"readBit",value:function(){var e=this.byteBuffer[this.idx>>3]>>(7&this.idx)&1;return this.idx++,e}},{key:"readBits",value:function(e){for(var t=0,n=0;n<e;n++)t|=this.readBit()<<n;return t}},{key:"readBitsReverse",value:function(e){for(var t=0,n=0;n<e;n++)t=t<<1|this.readBit();return t}}])&&G(t.prototype,n),e}();function Z(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function J(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function K(e,t,n){return t&&J(e.prototype,t),n&&J(e,n),e}var $=[],ee=[],te=[],ne=function(){function e(){Z(this,e)}return K(e,null,[{key:"setQuality",value:function(e){e=Math.max(0,Math.min(8,e))}},{key:"compress",value:function(e,t,n){var r;if(n){r=[];for(var i=0;i<e.length;){var o=Math.min(n,e.length-i);i+o>=e.length?final=1:final=0,a=re(e,i,o,final,t),r=r.concat(a),i+=o}}else r=re(e,0,e.length,1,t);return r}},{key:"expand",value:function(e,t,n){for(var r=new Q(e,t,n),a=[],i=0;!i;){i=r.readBit();var o=r.readBits(2);if(0===o){7&r.idx?r.idx=8+(-8&r.idx):r.idx=-8&r.idx;var s=r.readBits(16);r.readBits(16);for(var l=0;l<s;l++)a.push(r.readBits(8))}else if(1===o||2===o){var u=[];if(1===o){for(l=0;l<=143;l++)u[l]=8;for(l=144;l<=255;l++)u[l]=9;for(l=256;l<=279;l++)u[l]=7;for(l=280;l<=287;l++)u[l]=8;for(ee=ae(u),u=[],l=0;l<=31;l++)u[l]=5;te=ae(u)}else{var c=r.readBits(5),f=r.readBits(5),d=r.readBits(4),h=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];for(l=0;l<h.length;l++)u[h[l]]=l<d+4?r.readBits(3):0;var p=ae(u),v=se(r,c+f+258,p);u=v.slice(0,c+257),ee=ae(u),u=v.slice(c+257),te=ae(u)}for(;;){var m=ie(r,ee);if(m<256)a.push(m);else{if(256==m)break;if(285===m)m=255;else{var y=m-261;y>=0?m=((m-=257)-(t=4+4*(y>>=2))<<y)+(4<<y)+r.readBits(y):m-=257}a.push(-(m+3)),(y=(m=ie(r,te))-2)>=0&&(m=(m-(t=2+2*(y>>=1))<<y)+(2<<y)+r.readBits(y)),a.push(m+1)}}a=pe(a)}}return a}}]),e}(),re=function(e,t,n,r,a){var i=new Q(new ArrayBuffer(2*n));if(i.outputBit(r),i.outputBits(a,2),0===a){7&i.idx?i.idx=8+(-8&i.idx):i.idx=-8&dx.idx;var o=n;i.outputBits(o,16),i.outputBits(~o,16);for(var s=0;s<e.length;s++)i.outputBits(e[s+t],8)}else{var l=[],u=[],c=[],f=he(e,t,n);if(1===a){for(s=0;s<=143;s++)l[s]=8;for(s=144;s<=255;s++)l[s]=9;for(s=256;s<=279;s++)l[s]=7;for(s=280;s<=287;s++)l[s]=8;for(s=0;s<=31;s++)u[s]=5}else if(2===a){for(s=0;s<19;s++)c.push(5);for($=ae(c),s=0;s<=143;s++)l[s]=9;for(s=144;s<=255;s++)l[s]=8;for(s=256;s<=279;s++)l[s]=8;for(s=280;s<=287;s++)l[s]=7;for(s=0;s<=31;s++)u[s]=5;for(i.outputBits(l.length-257,5),i.outputBits(u.length-1,5),i.outputBits(c.length-4,4),s=0;s<c.length;s++)i.outputBits(c[s],3);var d=oe(l,$);ue(i,d,$),d=oe(u,$),ue(i,d,$)}for(ee=ae(l),te=ae(u),s=0;s<f.length;s++)if(f[s]>=0)le(i,f[s],ee);else{o=-f[s];var h=f[++s],p=0,v=0,m=285;o<258&&(m=4*(p=(0|Math.log2(Math.max(o-3,4)))-2)+(o-3>>p)+257,v=o-3&(1<<p)-1),le(i,m,ee),i.outputBits(v,p),v=h-1&(1<<(p=(0|Math.log2(Math.max(h-1,2)))-1))-1,le(i,m=2*p+(h-1>>p),te),i.outputBits(v,p)}le(i,256,ee)}return Array.from(i.byteBuffer).slice(0,Math.ceil(i.idx/8))},ae=function(e){for(var t=[],n=0,r=0;r<e.length;r++){var a={};a.Len=e[r],a.Code=0,t.push(a),n<e[r]&&(n=e[r])}var i=new Array(n+1);for(r=0;r<i.length;r++)i[r]=0;for(r=0;r<t.length;r++)i[t[r].Len]++;var o=0,s=new Array(n+1);i[0]=0;for(var l=1;l<s.length;l++)o=o+i[l-1]<<1,s[l]=o;for(var u=0;u<t.length;u++){var c=t[u].Len;0!=c&&(t[u].Code=s[c],s[c]++)}var f={};for(r=0;r<t.length;r++)t[r].Len&&(f[t[r].Code]=r);var d={};return d.enc_huffmans=t,d.dec_huffmans=f,d},ie=function(e,t){for(var n=t.dec_huffmans,r=t.enc_huffmans,a=1;a<=15;a++){var i=n[e.readBitsReverse(a)];if(null!=i&&r[i].Len===a)return i;e.idx-=a}return null},oe=function(e){for(var t=[],n=0;n<e.length;n++){for(var r=e[n],a=1;a+n<e.length&&r===e[n+a];a++);if(n+=a-1,0===r)for(;a;)a<3?(t.push(0),a-=1):a<11?(t.push(17),t.push(a-3),a=0):a<139?(t.push(18),t.push(a-11),a=0):(t.push(18),t.push(127),a-=138);else for(t.push(r),a-=1;a;)a<3?(t.push(r),a-=1):a<7?(t.push(16),t.push(a-3),a=0):(t.push(16),t.push(3),a-=6)}return t},se=function(e,t,n){for(var r=[];!(r.length>=t);){var a=ie(e,n);if(a<=15)r.push(a);else if(16===a)for(var i=e.readBits(2),o=r[r.length-1],s=0;s<i+3;s++)r.push(o);else if(17===a)for(i=e.readBits(3),s=0;s<i+3;s++)r.push(0);else if(18===a)for(i=e.readBits(7),s=0;s<i+11;s++)r.push(0)}return r},le=function(e,t,n){var r=n.enc_huffmans[t];e.outputBitsReverse(r.Code,r.Len)},ue=function(e,t,n){for(var r=0;r<t.length;r++){var a=t[r];a<=15?le(e,a,n):16===a?(le(e,a,n),r++,e.outputBits(t[r],2)):17===a?(le(e,a,n),r++,e.outputBits(t[r],3)):18===a&&(le(e,a,n),r++,e.outputBits(t[r],7))}},ce=function(){function e(){Z(this,e),this.front=[],this.behind=[]}return K(e,[{key:"push",value:function(e){this.front.push(e)}},{key:"shift",value:function(){if(0===this.behind.length){var e=this.behind;this.behind=this.front,this.front=e,this.behind.reverse()}return this.behind.pop()}},{key:"each",value:function(e){for(var t=this.behind.length;t--;)if(e(this.behind[t]))return;for(t=0;t<this.front.length;t++)if(e(this.front[t]))return}},{key:"each_inv1",value:function(e){var t=this.front.length;for(t>0&&t--;t--;)if(e(this.front[t]))return;for(t=0,0===this.front.length&&(t=1);t<this.behind.length;t++)if(e(this.behind[t]))return}},{key:"each_inv",value:function(e){for(var t=this.front.length;t--;)if(e(this.front[t]))return;for(t=0;t<this.behind.length;t++)if(e(this.behind[t]))return}}]),e}(),fe=function(e,t,n){var r=(t[n]<<16)+(t[n+1]<<8)+t[n+2];r in e||(e[r]=new ce),e[r].push(n)},de=function(e,t,n){e[(t[n]<<16)+(t[n+1]<<8)+t[n+2]].shift()},he=function(e,t,n){for(var r=new Array(n),a=0,i={},o=new DataView(e.buffer),s=Math.max(0,t-32768);s<t;s++)fe(i,e,s);var l=n-2;for(s=0;s<l;s++){var u=t+s,c=0,f=2,d=Math.min(n-s,258),h=u+d,p=u+d-12,v=i[(e[u]<<16)+(e[u+1]<<8)+e[u+2]];if(v&&v.each_inv((function(e){for(var t=u-e,n=u;n<p&&o.getUint32(n)===o.getUint32(n-t);n+=4);for(;n<h&&o.getUint8(n)===o.getUint8(n-t);n++);return!(n-u<=f)&&(c=t,(f=n-u)===d||void 0)})),c){for(r[a]=-f,r[++a]=c,s+=f-1,y=0;y<f;y++)fe(i,e,y+u);var m=u-32768+f;for(y=Math.max(0,u-32768);y<m;y++)de(i,e,y)}else{r[a]=e[u],fe(i,e,u);var y=u-32768;y>=0&&de(i,e,y)}a++}for(;s<n;s++)r[a]=e[t+s],a++;return r.length=a,r},pe=function(e,t){var n;n=t||[];for(var r=0;r<e.length;r++)if(e[r]>=0)n.push(e[r]);else for(var a=-e[r],i=e[++r],o=n.length-i,s=0;s<a;s++)n.push(n[o+s]);return n};function ve(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var me=function(e){for(var t=1,n=0,r=e.length,a=0;a<r;){for(var i=Math.min(5550,r-a),o=0;o<i;o++,a++)n+=t+=e[a];t%=65521,n%=65521}return 65536*n+t},ye=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"compress",value:function(e,t,n){var r=[];r[0]=120,r[1]=128,r[1]+=31-((r[0]<<8)+r[1])%31;var a=Array.from(ne.compress(e,t,n)),i=me(e),o=new DataView(new ArrayBuffer(4));return o.setUint32(0,i),o=Array.from(new Uint8Array(o.buffer)),r.concat(a).concat(Array.from(o))}},{key:"expand",value:function(e,t,n){var r=new DataView(e),a=(r.getUint16(0),r.getUint32(t+(n-4)),ne.expand(e,t+2,n-6));return me(a),a}}],null&&ve(t.prototype,null),n&&ve(t,n),e}();function ge(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var be,we,_e=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"toArrayBuffer",value:function(e){var t=e.attributes.channels,n=e.attributes.dataWindow.xMax-e.attributes.dataWindow.xMin+1,r=e.attributes.dataWindow.yMax-e.attributes.dataWindow.yMin+1,a=new Q(r*(16+2*n*t.length)+400);a.setUint32(20000630,!0),a.setUint16(2,!0),a.setUint16(0,!0);for(var i=e.attributes,o=Object.keys(i),s=0;s<o.length;s++){var l=o[s],u=i[l];a.setTextBuf(l,!0);var c,f="";switch(l){case"channels":f="chlist";break;case"compression":f="compression";break;case"dataWindow":case"displayWindow":f="box2i";break;case"lineOrder":f="lineOrder";break;case"pixelAspectRatio":f="float";break;case"screenWindowCenter":f="v2f";break;case"screenWindowWidth":f="float";break;case"chromaticities":f="chromaticities"}if(a.setTextBuf(f,!0),c=a.idx,a.idx+=32,"box2i"===f)a.setInt32(u.xMin,!0),a.setInt32(u.yMin,!0),a.setInt32(u.xMax,!0),a.setInt32(u.yMax,!0);else if("box2f"===f)a.setFloat32(u.xMin,!0),a.setFloat32(u.yMin,!0),a.setFloat32(u.xMax,!0),a.setFloat32(u.yMax,!0);else if("chlist"===f){t=u;for(var d=0;d<t.length;d++){var h=t[d];a.setTextBuf(h.name,!0),a.setInt32(h.pixel_type,!0),a.setUint8(h.pLiner,!0),a.setUint8(0,!0),a.setUint8(0,!0),a.setUint8(0,!0),a.setInt32(h.xSampling,!0),a.setInt32(h.ySampling,!0)}a.setTextBuf("",!0)}else if("compression"===f)a.setUint8(u);else if("double"===f)a.setFloat64(u,!0);else if("float"===f)a.setFloat32(u,!0);else if("int"===f)a.setInt32(u,!0);else if("lineOrder"===f)a.getUint8(0,!0);else if("string"===f)a.setTextBuf(u,!0);else if("v2i"===f)a.setInt32(u[0],!0),a.setInt32(u[1],!0);else if("v2f"===f)a.setFloat32(u[0],!0),a.setFloat32(u[1],!0);else if("chromaticities"===f)for(var p=0;p<8;p++)a.setFloat32(u[p],!0);var v=a.idx;a.idx=c,a.setUint32((v-c>>3)-4,!0),a.idx=v}a.setTextBuf("",!0);var m=a.idx;a.idx+=64*e.height;var y=a.idx,g=2*e.width*t.length,b=1;3===e.attributes.compression&&(b=16);for(var w=new Q(new ArrayBuffer(g*b)),_=0;_<r;){y=a.idx,a.idx=m,a.setUint64(y>>3,!0),m=a.idx,a.idx=y,a.setUint32(_,!0),w.idx=0;for(var x=Math.min(b,r-_),k=0;k<x;k++){var M=_*n;for(d=0;d<t.length;d++)for(var I=t[d].data,E=0;E<n;E++)w.setFloat16(I[M+E],!0);_++}var L=new Uint8Array(w.dv.buffer,0,x*g);if(e.attributes.compression){for(var C=L.length>>1,O=new Uint8Array(L.length),B=0;B<C;B++)O[B]=L[B<<1],O[B+C]=L[1+(B<<1)];for(B=O.length-1;B>0;B--)O[B]=O[B]-O[B-1]+128&255;ne.setQuality(2),L=ye.compress(O,1)}a.setUint32(L.length,!0),a.setBytes(L)}return a.byteBuffer.buffer.slice(0,a.idx>>3)}},{key:"fromArrayBuffer",value:function(e,t){var n=new Q(t),r=n.getUint32(!0);if(20000630===r){r=n.getUint16(!0),n.getUint16(!0);for(var a=[];;){var i=n.readTextBuf();if(""===i)break;var o=n.readTextBuf(),s=null,l=n.getUint32(!0),u=n.idx;if("box2i"===o)(s={}).xMin=n.getInt32(!0),s.yMin=n.getInt32(!0),s.xMax=n.getInt32(!0),s.yMax=n.getInt32(!0);else if("box2f"===o)(s={}).xMin=n.getFloat32(!0),s.yMin=n.getFloat32(!0),s.xMax=n.getFloat32(!0),s.yMax=n.getFloat32(!0);else if("chlist"===o)for(s=[];;){var c=[];if(c.name=n.readTextBuf(),""===c.name)break;c.pixel_type=n.getInt32(!0),c.pLinear=n.getUint8(!0),c.reserved=n.getUint8(!0),n.idx+=16,c.xSampling=n.getInt32(!0),c.ySampling=n.getInt32(!0),s.push(c)}else if("compression"===o)s=n.getUint8(!0);else if("double"===o)s=n.getFloat64(!0);else if("float"===o)s=n.getFloat32(!0);else if("int"===o)s=n.getInt32(!0);else if("lineOrder"===o)s=n.getUint8(!0);else if("string"===o){s="";for(var f=0;f<l;f++)s+=String.fromCharCode(n.getUint8(!0))}else if("v2i"===o)(s=[]).push(n.getInt32(!0)),s.push(n.getInt32(!0));else if("v2f"===o)(s=[]).push(n.getFloat32(!0)),s.push(n.getFloat32(!0));else if("chromaticities"===o){s=[];for(var d=0;d<8;d++)s.push(n.getFloat32(!0))}a[i]=s,n.idx=u+(l<<3)}var h=a.channels;e.width=a.dataWindow.xMax-a.dataWindow.xMin+1,e.height=a.dataWindow.yMax-a.dataWindow.yMin+1;var p=e.width*e.height;for(f=0;f<h.length;f++)0===(E=h[f]).pixel_type&&(E.data=new Uint8Array(p)),1===E.pixel_type&&(E.data=new Float32Array(p)),2===E.pixel_type&&(E.data=new Float32Array(p));for(f=0;f<e.height;f++){var v=n.getUint64(!0),m=n.idx;n.idx=v<<3;var y,g=n.getUint32(!0),b=n.getUint32(!0),w=1;if(0===a.compression&&(y=new Q(n.dv.buffer,n.idx>>3,b)),2===a.compression||3===a.compression)var _=ye.expand(n.dv.buffer,n.idx>>3,b);if(3===a.compression&&(w=Math.min(e.height-g,16)),3===a.compression||2===a.compression){for(var x=new Uint8Array(_.length),k=1;k<_.length;k++)_[k]=_[k-1]-128+_[k]&255;for(v=_.length>>1,k=0;k<v;k++)x[k<<1]=_[k],x[1+(k<<1)]=_[k+v];y=new Q(x.buffer)}for(var M=0;M<w;M++)for(var I=0;I<h.length;I++){_=(E=h[I]).data;var E,L=(g+M)*e.width;if(0==E.pixel_type)for(var C=0;C<e.width;C++)E.data[L+C]=y.getUint8(!0);else if(1==E.pixel_type)for(C=0;C<e.width;C++)E.data[L+C]=y.readFloat16(!0);else if(2==E.pixel_type)for(C=0;C<e.width;C++)E.data[L+C]=y.getFloat32(!0)}n.idx=m,f+=w-1}e.attributes=a}else alert("exrファイルのマジックナンバーと違う")}}],null&&ge(t.prototype,null),n&&ge(t,n),e}();function xe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ke(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}(we=document.createElement("canvas")).width=1,we.height=1,(be=we.getContext("2d")).createImageData(we.width,we.height),new I;var Me=function(){function e(t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ke(this,"toDataURL",(function(e,t){return this.toCanvas().toDataURL(e,t)})),ke(this,"toBlob",(function(e,t,n){return this.toCanvas().toBlob(e,t,n)})),ke(this,"toBMP",(function(){var e=this.height,t=this.width,n=e*(4*t+1>>>2<<2)*2+14+40,r=new DataStream(n);r.setTextBuf("BM",0),r.setUint32(n,!0),r.setUint16(0,!0),r.setUint16(0,!0),r.setUint32(54,!0),r.setUint32(40,!0),r.setUint32(this.width,!0),r.setUint32(this.height,!0),r.setUint16(1,!0),r.setUint16(32,!0),r.setUint32(0,!0),r.setUint32(this.data.length,!0),r.setUint32(0,!0),r.setUint32(0,!0),r.setUint32(0,!0),r.setUint32(0,!0);var a=this.data;switch(this.format){case 1:for(var i=e;i--;)for(var o=i*t<<2,s=0;s<t;s++)r.setUint8(a[o+2],!0),r.setUint8(a[o+1],!0),r.setUint8(a[o+0],!0),r.setUint8(a[o+3],!0),o+=4}return r.byteBuffer})),t||(t=0,n=0),this.width=t,this.height=n,this.data=null,this.format=r,this.width)switch(this.format){case 1:this.imagedata=be.createImageData(this.width,this.height),this.data=this.imagedata.data,this.rgba=new Uint32Array(this.data.buffer);break;default:this.data=new Float32Array(this.width*this.height<<2)}}var t,n,r;return t=e,r=[{key:"copy",value:function(e,t,n,r,a,i,o,s,l){var u=e.data,c=(e.width,r.data);r.width,o+a>r.width&&(o=r.width-a),s+i>r.height&&(s=r.height-i);var f=t,d=t+o,h=n,p=n+s;if(a<0&&(f-=a,a=0),i<0&&(h-=i,i=0),f<0&&(a-=f,f=0),h<0&&(i-=h,h=0),d>e.width&&(d=e.width),p>e.height&&(p=e.height),1===e.type&&1===r.type)for(var v=h;v<p;v++)for(var m=e.getIndex(f,v),y=r.getIndex(a,i+v-h),g=f;g<d;g++)e.rgba[m]=r.rgba[y],m++,y++;else for(v=h;v<p;v++)for(m=e.getIndex(f,v),y=r.getIndex(a,i+v-h),m<<=2,y<<=2,g=f;g<d;g++)u[m+0]=c[y+0],u[m+1]=c[y+1],u[m+2]=c[y+2],u[m+3]=c[y+3],m+=4,y+=4}},{key:"loadImg",value:function(t,n,r){if("string"!=typeof t)return W.loadFile(t,(function(t){e.loadImg(t,n,r)})),null;var a=new Image;a.src=t;var i=new e;return i.name=t,i.format=n,a.onload=function(e){i.width=a.width,i.height=a.height,(we.width<i.width||we.height<i.height)&&(we.width<i.width&&(we.width=i.width),we.height<i.height&&(we.height=i.height),be.createImageData(we.width,we.height)),be.clearRect(0,0,we.width,we.height),be.drawImage(a,0,0);var t=be.getImageData(0,0,i.width,i.height).data;switch(i.format){case 1:i.data=new Uint8Array(i.width*i.height*4),i.rgba=new Uint32Array(i.data.buffer);for(var n=0;n<i.width*i.height*4;n++)i.data[n]=t[n];break;default:for(i.data=new Float32Array(i.width*i.height*4),n=0;n<i.width*i.height*4;n++)i.data[n]=.00392156862745098*t[n]}r&&r(i)},i}},{key:"loadExr",value:function(t,n,r){var a=new e,i=function(e){var t={};_e.fromArrayBuffer(t,e),a.width=t.width,a.height=t.height,a.data=new Float32Array(a.width*a.height*4);for(var n=t.attributes.channels,i=a.data,o={R:-1,G:-1,B:-1,A:-1},s=0;s<n.length;s++)o[n[s].name]=s;var l=o.R,u=o.G,c=o.B,f=a.width*a.height*4;for(s=0;s<f;s+=4)i[s]=n[l].data[s>>2],i[s+1]=n[u].data[s>>2],i[s+2]=n[c].data[s>>2];var d=o.A;if(d>=0)for(s=0;s<f;s+=4)i[s+3]=n[d].data[s>>2];else for(s=0;s<f;s+=4)i[s+3]=1;r&&r(a)};return"string"==typeof t?W.loadBinary(t,(function(e){i(e)})):t.byteLength?i(t):W.loadBinary(t,(function(e){i(e)})),a}}],(n=[{key:"scan",value:function(e,t,n,r,a){var i=this.data;void 0===t&&(t=0,n=0,r=this.width,a=this.height);for(var o=0;o<a;o++)for(var s=this.getIndex(t,o+n)<<2,l=0;l<r;l++)e(i,s,t+l,n+o),s+=4}},{key:"copy",value:function(t,n,r,a,i,o,s,l){e.copy(this,t,n,r,a,i,o,s,l)}},{key:"getIndex",value:function(e,t){return t*this.width+e}},{key:"getIndexLoop",value:function(e,t){var n=e%this.width,r=t%this.height;return n<0&&(n+=this.width),r<0&&(r+=this.height),r*this.width+n}},{key:"createExr",value:function(e){var t=this,n={};n.width=t.width,n.height=t.height,n.attributes=[],n.attributes.compression=e,n.attributes.dataWindow={xMin:0,yMin:0,xMax:t.width-1,yMax:t.height-1},n.attributes.displayWindow={xMin:0,yMin:0,xMax:t.width-1,yMax:t.height-1},n.attributes.lineOrder=0,n.attributes.pixelAspectRatio=1,n.attributes.screenWindowCenter=[0,0],n.attributes.screenWindowWidth=1;for(var r=t.width*t.height,a=[],i=0;i<4;i++){var o={};o.data=new Float32Array(r),o.pixel_type=1,o.pLiner=0,o.reserved=0,o.xSampling=1,o.ySampling=1,a.push(o)}a[0].name="A",a[1].name="B",a[2].name="G",a[3].name="R";var s=t.data;for(i=0;i<r;i++){var l=i<<2;a[0].data[i]=s[l+3],a[1].data[i]=s[l+2],a[2].data[i]=s[l+1],a[3].data[i]=s[l+0]}return n.attributes.channels=a,_e.toArrayBuffer(n)}},{key:"clear",value:function(e,t,n,r){var a=this.data;if(void 0===e)for(var i=a.length,o=3;o<i;o+=4)a[o]=0;else for(var s=this.width,l=Math.min(this.height,t+r),u=Math.min(s,e+n),c=t;c<l;c++)for(var f=c*s+e<<2,d=c*s+u<<2;f<d;f+=4)a[f+0]=1,a[f+1]=1,a[f+2]=1,a[f+3]=0}},{key:"toCanvas",value:function(e,t){return we.width=this.width,we.height=this.height,be.putImageData(this.toImageData(),0,0),we}},{key:"toImageData",value:function(){var e,t=this.data;switch(this.format){case 1:e=this.imagedata;break;default:e=be.createImageData(this.width,this.height);for(var n=0;n<this.height;n++)for(var r=0;r<this.width;r++)for(var a=n*this.width+r<<2,i=0;i<4;i++)e.data[a+i]=255*t[a+i]}return e}},{key:"gauss",value:function(t,n,r,a,i,o){var s=this;t=Math.max(1,t);var l=0|n;Ie.data.length<s.data.length&&(Ie=new e(s.width,s.height)),Ie.width=s.width,Ie.height=s.height;for(var u=Ie,c=r+i-1,f=a+o-1,d=new Array(l),h=0,p=0;p<d.length;p++){var v=p,m=Math.exp(-v*v/(2*t*t));d[p]=m,p>0&&(m*=2),h+=m}for(p=0;p<d.length;p++)d[p]/=h;for(var y=s.height,g=s.width,b=s.data,w=u.data,_=Math.max(0,a-n),x=Math.min(s.height,f+n+1),k=_;k<x;k++){for(var M=k*g,I=M+r<<2,E=M+(c+1)<<2;I<E;I+=4){var L=b[I+3];b[I+0]*=L,b[I+1]*=L,b[I+2]*=L}for(var C=r,O=(I=M+r<<2,M+c+1<<2),B=(v=d[0],k*g+(g-1)<<2),A=k*g<<2;I<O;I+=4)w[I+0]=b[I+0]*v,w[I+1]=b[I+1]*v,w[I+2]=b[I+2]*v,w[I+3]=b[I+3]*v;for(O=Math.min(l,c+1);C<O;C++){var P=I=M+C<<2,R=I;for(p=1;p<l;p++)P=Math.max(P-4,A),R=Math.min(R+4,B),v=d[p],w[I+0]+=(b[P+0]+b[R+0])*v,w[I+1]+=(b[P+1]+b[R+1])*v,w[I+2]+=(b[P+2]+b[R+2])*v,w[I+3]+=(b[P+3]+b[R+3])*v}for(O=Math.min(g-l,c+1);C<O;C++)for(P=I=M+C<<2,R=I,p=1;p<l;p++)P-=4,R+=4,v=d[p],w[I+0]+=(b[P+0]+b[R+0])*v,w[I+1]+=(b[P+1]+b[R+1])*v,w[I+2]+=(b[P+2]+b[R+2])*v,w[I+3]+=(b[P+3]+b[R+3])*v;for(O=Math.min(c+1,g);C<O;C++)for(P=I=M+C<<2,R=I,p=1;p<l;p++)P=Math.max(P-4,A),R=Math.min(R+4,B),v=d[p],w[I+0]+=(b[P+0]+b[R+0])*v,w[I+1]+=(b[P+1]+b[R+1])*v,w[I+2]+=(b[P+2]+b[R+2])*v,w[I+3]+=(b[P+3]+b[R+3])*v}for(b=u.data,w=s.data,C=r;C<c+1;C++){var T=g<<2;for(I=a*g+C<<2,O=(f+1)*g+C<<2,v=d[0];I<O;I+=4*g)w[I+0]=b[I+0]*v,w[I+1]=b[I+1]*v,w[I+2]=b[I+2]*v,w[I+3]=b[I+3]*v;for(k=a,O=Math.min(l,f+1),B=(y-1)*g+C<<2,A=C<<2;k<O;k++)for(P=I=k*g+C<<2,R=I,p=1;p<l;p++)P=Math.max(P-T,A),R=Math.min(R+T,B),v=d[p],w[I+0]+=(b[P+0]+b[R+0])*v,w[I+1]+=(b[P+1]+b[R+1])*v,w[I+2]+=(b[P+2]+b[R+2])*v,w[I+3]+=(b[P+3]+b[R+3])*v;for(O=Math.min(y-l,f+1);k<O;k++)for(P=I=k*g+C<<2,R=I,p=1;p<l;p++)P-=T,R+=T,v=d[p],w[I+0]+=(b[P+0]+b[R+0])*v,w[I+1]+=(b[P+1]+b[R+1])*v,w[I+2]+=(b[P+2]+b[R+2])*v,w[I+3]+=(b[P+3]+b[R+3])*v;for(O=Math.min(y,f+1);k<O;k++)for(P=I=k*g+C<<2,R=I,p=1;p<l;p++)P=Math.max(P-T,A),R=Math.min(R+T,B),v=d[p],w[I+0]+=(b[P+0]+b[R+0])*v,w[I+1]+=(b[P+1]+b[R+1])*v,w[I+2]+=(b[P+2]+b[R+2])*v,w[I+3]+=(b[P+3]+b[R+3])*v;for(I=a*g+C<<2,E=(f+1)*g+C<<2;I<E;I+=4*g)(L=w[I+3])>0&&L<1&&(L=1/L,w[I+0]*=L,w[I+1]*=L,w[I+2]*=L)}}}])&&xe(t.prototype,n),r&&xe(t,r),e}();ke(Me,"FORMAT_FLOAT32",0),ke(Me,"FORMAT_UINT8",1);var Ie=new Me(1024,1024);function Ee(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Le=new k,Ce=[],Oe=function e(){if(!Ae.refreshoff){for(var t=0;t<Ce.length;t++){var n=Ce[t];Be(n.step,n.x,n.y,n.w,n.h)}Ce=[]}Ce.length>0&&window.requestAnimationFrame((function(t){e()}))},Be=function(e,t,n,r,a){void 0===e&&(e=0);var i=parseFloat(inputs.bloom_size.value),o=root_layer.img,s=0,l=o.width,u=0,c=o.height,f=o.data,d=o.width;r&&(s=t,l=t+r,u=n,c=n+a,s-=i,l+=i,u-=i,c+=i,s=Math.max(0,s),l=Math.min(o.width,l),u=Math.max(0,u),c=Math.min(o.height,c),s=Math.floor(s),l=Math.ceil(l),u=Math.floor(u),c=Math.ceil(c));var h=l-s,p=c-u;if(inputs.selected_layer_only.checked){var v=bloom_img,m=(v.data,v.width,selected_layer);bloom_img.clear(s,u,h,p),m.getAbsolutePosition(Le),"normal_layer"===m.typename?bloom_img.copy(s,u,m.img,s-Le[0],u-Le[1],h,p):(m.beforeReflect(),bloom_img.scan((function(e,t,n,r){m.getPixel(e,t,n-Le[0],r-Le[1])}),s,u,h,p))}else if(e<=0&&inputs.ch_bloom.checked&&(bloom_img.copy(s-i,u-i,root_layer.img,s-i,u-i,l-s+2*i,c-u+2*i),bloom_img.gauss(i>>1,i,s,u,l-s,c-u),bloomed_img.copy(s,u,bloom_img,s,u,l-s,c-u)),e<=1){var y=parseFloat(inputs.bloom_power.value),g=1-y,b=bloom_img.data,w=bloomed_img.data;if(inputs.ch_bloom.checked&&y>0)for(var _=u;_<c;_++)for(var x=_*d+s<<2,k=_*d+l<<2;x<k;x+=4)b[x]=f[x]*g+w[x]*y,b[x+1]=f[x+1]*g+w[x+1]*y,b[x+2]=f[x+2]*g+w[x+2]*y,b[x+3]=f[x+3];else bloom_img.copy(s,u,o,s,u,h,p)}if(e<=2){var M=preview_ctx_imagedata.data,I=parseFloat(inputs.ev.value),E=1/parseFloat(inputs.gamma.value);if(f=bloom_img.data,inputs.ch_gamma.checked){var L=Math.pow(2,-I);for(_=u;_<c;_++)for(x=_*d+s<<2,k=_*d+l<<2;x<k;x+=4)M[x+0]=255*Math.pow(f[x+0]*L,E),M[x+1]=255*Math.pow(f[x+1]*L,E),M[x+2]=255*Math.pow(f[x+2]*L,E),M[x+3]=255*f[x+3]}else for(L=255*Math.pow(2,-I),_=u;_<c;_++)for(x=_*d+s<<2,k=_*d+l<<2;x<k;x+=4)M[x+0]=f[x+0]*L,M[x+1]=f[x+1]*L,M[x+2]=f[x+2]*L,M[x+3]=255*f[x+3]}preview_ctx.putImageData(preview_ctx_imagedata,0,0,s,u,l-s,c-u)},Ae=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"disableRefresh",value:function(){}},{key:"enableRefresh",value:function(){}},{key:"refreshPreview",value:function(e,t,n,r,a){if(1!==Ce.length||0!==Ce[0].step||0!==Ce[0].w){void 0===t&&(Ce=[],t=0,n=0,r=root_layer.img.width,a=root_layer.img.height),0===Ce.length&&window.requestAnimationFrame((function(e){Oe()}));var i={};i.step=e,i.x=t,i.y=n,i.w=r,i.h=a,Ce.push(i)}}},{key:"compositeAll",value:function(){!function e(t,n,r,a,i){if(1==t.type){for(var o=t.children,s=0;s<o.length;s++)e(o[s],n,r,a,i);t.composite(n,r,a,i)}}(root_layer)}},{key:"refreshActiveLayerParam",value:function(){var e=selected_layer;if(e){var t=Array.prototype.slice.call(document.getElementById("layer_param").getElementsByTagName("input"));t=t.concat(Array.prototype.slice.call(document.getElementById("layer_param").getElementsByTagName("select")));for(var n=0;n<t.length;n++){var r=t[n];switch(r.id){case"layer_x":r.value=e.position[0];break;case"layer_y":r.value=e.position[1];break;case"layer_width":e.img&&(r.value=e.img.width);break;case"layer_height":e.img&&(r.value=e.img.height);break;default:var a=r.id.replace("layer_","");a in e&&("checkbox"===r.getAttribute("type")?r.checked=e[a]:r.value=e[a],W.fireEvent(r,"input"))}}}}},{key:"refreshPreviewStatus",value:function(e){var t=root_layer.img,n=t.data,r=doc.cursor_pos[0],a=doc.cursor_pos[1],i=t.width,o=t.height,s=document.getElementById("status2"),l=0,u=0,c=0,f=0;if(r<0||a<0||r>=i||a>=o)d=(d=(d=(d="倍率[scale]% X:[x],Y:[y]").replace(/\[scale\]/,doc.scale)).replace(/\[x\]/,"-")).replace(/\[y\]/,"-"),W.setText(s,d),W.setText(document.getElementById("pos_R"),"-"),W.setText(document.getElementById("pos_G"),"-"),W.setText(document.getElementById("pos_B"),"-"),W.setText(document.getElementById("pos_A"),"-");else{var d,h=t.getIndex(0|r,0|a)<<2;l=n[h],u=n[h+1],c=n[h+2],f=n[h+3],r.toFixed(2),a.toFixed(2),d=(d=(d=(d="倍率[scale]% X:[x],Y:[y]").replace(/\[scale\]/,doc.scale)).replace(/\[x\]/,r)).replace(/\[y\]/,a),W.setText(s,d),W.setText(document.getElementById("pos_R"),l.toFixed(3)),W.setText(document.getElementById("pos_G"),u.toFixed(3)),W.setText(document.getElementById("pos_B"),c.toFixed(3)),W.setText(document.getElementById("pos_A"),f.toFixed(3))}}}],null&&Ee(t.prototype,null),n&&Ee(t,n),e}();function Pe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Re(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Te=function e(){ze.enableRefreshThumbnail&&Ve.shift().refreshThumbnail(),Ve.length>0&&window.requestAnimationFrame((function(t){e()}))},Ue=function(){var e=selected_layer;if(e){var t=Array.prototype.slice.call(document.getElementById("layer_param").getElementsByTagName("input"));t=t.concat(Array.prototype.slice.call(document.getElementById("layer_param").getElementsByTagName("select")));for(var n=0;n<t.length;n++)switch((s=t[n]).id){case"layer_x":s.value=e.position[0];break;case"layer_y":s.value=e.position[1];break;case"layer_width":e.img&&(s.value=e.img.width);break;case"layer_height":e.img&&(s.value=e.img.height);break;default:var r=s.id.replace("layer_","");r in e&&("checkbox"===s.getAttribute("type")?s.checked=e[r]:s.value=e[r],W.fireEvent(s,"input"))}var a=Xe.inputs;1===selected_layer.type?a.join_layer.value="子を結合":a.join_layer.value="下のレイヤと結合";var i=document.querySelector("#modifier_param_area").children;for(n=0;n<i.length;n++)i[n].style.display="none";var o=document.querySelector("#div_"+selected_layer.modifier);if(o)for(o.style.display="inline",i=o.querySelectorAll("input,select"),n=0;n<i.length;n++){var s,l=(s=i[n]).title;l in e&&("checkbox"===s.type?s.checked=Boolean(e[l]):"radio"===s.type?s.checked=Boolean(e[l]===s.value):s.value=e[l],W.fireEvent(s,"input"))}}},Ve=[],je=new Me(512,512),Se=new I,De=0,Fe=function(e){var t=null;return ze.eachLayers((function(n){if(n.div==e)return t=n,!0})),t},Ne=null,qe=new Me(64,64,1),ze=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Re(this,"typename","normal_layer"),this.name="",this.display=!0,this.lock=!1,this.power=0,this.alpha=1,this.blendfunc="normal",this.modifier="layer",this.div=null,this.img=null,this.mask_alpha=0,this.position=new k,this.size=new k,this.modifier_param={},this.type=0,this.children=null}var t,n,r;return t=e,r=[{key:"setLayerIdCount",value:function(e){De=e}},{key:"init",value:function(){}},{key:"bubble_func",value:function(t,n){n(t);var r=t.parent;r&&e.bubble_func(r,n)}},{key:"eachLayers",value:function(e){if(root_layer)return function t(n){if(e(n))return!0;if(0===n.type)return!1;var r=n.children;if(r)for(var a=0;a<r.length;a++)if(t(r[a]))return!0;return!1}(root_layer)}},{key:"findById",value:function(t){var n=null;return e.eachLayers((function(e){if(e.id==t)return n=e,!0})),n}},{key:"layerArray",value:function(){var t=[];return e.eachLayers((function(e){t.push(e)})),t}},{key:"DragOver",value:function(e){e.preventDefault()}},{key:"select",value:function(t){selected_layer=t,e.eachLayers((function(e){t!==e?e.div.classList.remove("active"):e.div.classList.add("active")})),Ue(),inputs.selected_layer_only.checked&&refreshPreview(1)}},{key:"create",value:function(t,n){var r=document.getElementById("layer_template"),a=new e;n&&(a.type=1,a.children=[]);var i=r.children[0].cloneNode(!0);return 1==a.type&&i.classList.add("group"),a.div=i,a.img=t,t&&k.set(a.size,t.width,t.height),a.id=De,De++,a.name="layer"+("0000"+a.id).slice(-4),a.refreshDiv(),a.registRefreshThumbnail(),a}},{key:"createModifier",value:function(e){var t=document.getElementById("layer_template"),n=new Xe.modifier[e];n.type=2;var r=t.children[0].cloneNode(!0);return n.children&&r.classList.add("group"),r.classList.add("modifier"),n.div=r,n.img=null,n.id=De,De++,n.modifier=e,n.name=e+("0000"+n.id).slice(-4),n.refreshDiv(),n}},{key:"opencloseClick",value:function(e){return Fe(event.target.parentNode).div.classList.toggle("open"),e.preventDefault(),!1}}],(n=[{key:"before",value:function(e){}},{key:"beforeReflect",value:function(){}},{key:"reflect",value:function(e,t,n,r,a){t=Math.max(e.offsetx,Se[0]),n=Math.max(e.offsety,Se[1]);for(var i=Math.min(e.width+e.offsetx,Se[2]+Se[0]),o=Math.min(e.height+e.offsety,Se[3]+Se[1]),s=this,l=e.data,u=e.width,c=s.img.data,f=s.alpha,d=Math.pow(2,s.power),h=s.img.width,p=Xe.blendfuncs[s.blendfunc],v=s.position[0],m=s.position[1],y=Math.max(t,s.position[0]),g=Math.max(n,s.position[1]),b=Math.min(s.img.width+v,i),w=Math.min(s.img.height+m,o),_=g;_<w;_++)for(var x=(_-e.offsety)*u+y-e.offsetx<<2,k=(_-e.offsety)*u+b-e.offsetx<<2,M=(_-m)*h+y-v<<2;x<k;x+=4)p(l,x,c,M,f,d),M+=4}},{key:"composite",value:function(e,t,n,r){var a=this.children;if(void 0===e&&(e=0,t=0,n=this.img.width-1,r=this.img.height-1),1===this.type){var i=n-e+1,o=r-t+1;I.set(Se,e,t,i,o);for(var s=a.length;s--;)(l=a[s]).display&&l.before(Se);for(e=Math.max(0,Se[0]),t=Math.max(0,Se[1]),n=Math.min(this.img.width,Se[2]+e),r=Math.min(this.img.height,Se[3]+t),je.data.length<(n-e)*(r-t)<<2&&(je=new Me(n-e,r-t)),je.offsetx=e,je.offsety=t,je.width=n-e,je.height=r-t,je.clear(0,0,je.width,je.height),s=0;s<a.length;s++){var l;(l=a[s]).display&&(l.beforeReflect(),l.reflect(je,Se))}var u=Se[0],c=Se[0]+Se[2],f=Se[1],d=Se[1]+Se[3];u=Math.max(0,u),f=Math.max(0,f),c=Math.min(this.img.width,c),d=Math.min(this.img.height,d),I.set(Se,u,f,c-u,d-f),Me.copy(this.img,Se[0],Se[1],je,-je.offsetx+Se[0],-je.offsety+Se[1],Se[2],Se[3]),this===root_layer?Ae.refreshPreview(0,Se[0],Se[1],Se[2],Se[3]):this.registRefreshThumbnail()}}},{key:"getPixel",value:function(e,t,n,r){if(this.img){if(n<0||r<0||n>=this.img.width||r>=this.img.height)return e;if(void 0===r&&(r=n,n=t,t=0),this.img.data){var a=this.img.data,i=this.img.getIndex(n,r)<<2;e[t+0]=a[i],e[t+1]=a[i+1],e[t+2]=a[i+2],e[t+3]=a[i+3]}return e}}},{key:"refreshImg",value:function(e,t,n,r){var a=this,i=0,o=a.img.width-1,s=0,l=a.img.height-1;void 0!==n&&(i=Math.max(i,e),o=Math.min(o,e+n-1),s=Math.max(s,t),l=Math.min(l,t+r-1)),i=Math.floor(i),o=Math.ceil(o),s=Math.floor(s),l=Math.ceil(l),a.parent&&(void 0===n?a.parent.bubbleComposite():a.parent.bubbleComposite(i+a.position[0],s+a.position[1],o-i+1,l-s+1)),this.registRefreshThumbnail()}},{key:"bubbleComposite",value:function(e,t,n,r){void 0===e&&(e=0,t=0,n=this.size[0],r=this.size[1]);var a=e,i=t,o=e+n-1,s=t+r-1;a=Math.max(0,a),i=Math.max(0,i),this.img&&(o=Math.min(this.img.width-1,o),s=Math.min(this.img.height-1,s)),a=Math.floor(a),o=Math.ceil(o),i=Math.floor(i),s=Math.ceil(s),a!=o&&i!=s&&(2!==this.type?(void 0===e?this.composite():this.composite(a,i,o,s),this.parent&&this.parent.bubbleComposite(a+this.position[0],i+this.position[1],o-a+1,s-i+1)):this.parent&&this.parent.bubbleComposite(a+this.position[0],i+this.position[1],o-a+1,s-i+1))}},{key:"showDivParam",value:function(){var e=this,t="";return t+="offset:["+e.position[0]+","+e.position[1]+"]size:["+e.size[0]+","+e.size[1]+"]<br>",e.power=parseFloat(e.power),t+="pow:"+e.power.toFixed(2),e.alpha=parseFloat(e.alpha),t+"α:"+e.alpha.toFixed(2)+"<br>"}},{key:"refreshDiv",value:function(){var e=this,t=null;if(e===root_layer)t=document.getElementById("layers_container");else{selected_layer===e?e.div.classList.add("active"):e.div.classList.remove("active"),0!==e.type&&e.children?e.div.classList.add("group"):e.div.classList.remove("group");var n=e.div.getElementsByClassName("name")[0],r=e.name;this.display?e.div.classList.remove("invisible"):(r+="(非表示)",e.div.classList.add("invisible")),this.lock?(r+="(lock)",e.div.classList.add("lock")):e.div.classList.remove("lock"),this.mask_alpha&&(r+="(αlock)"),n.innerHTML=r;var a=e.div.getElementsByClassName("layer_attributes")[0],i="";2===e.type?i+="modifier:"+e.modifier+"<br>":i+="func:"+e.blendfunc+"<br>",i+=e.showDivParam(),a.innerHTML=i,t=e.div.getElementsByClassName("children")[0]}for(;t.firstChild;)t.removeChild(t.firstChild);if(e.children)for(var o=e.children.length;o--;)t.appendChild(e.children[o].div);e===selected_layer&&Ue()}},{key:"append",value:function(e,t){this.children.splice(e,0,t),t.parent=this,this.refreshDiv(),this.bubbleComposite()}},{key:"refreshThumbnail",value:function(){var e=this;if(e.img&&e.img.data){var t=e.img,n=(t.data,e.div.getElementsByTagName("img")[0]),r=(t.toCanvas(),Me.ctx,t.width/64),a=t.height/64,i=r;r<a?(i=a,n.style.width="auto",n.style.height="100%"):(n.style.width="100%",n.style.height="auto");var o=t.width/i|0,s=t.height/i|0;qe.clear(0,0,o,s);for(var l=t.data,u=qe.data,c=new I,f=parseFloat(inputs.ev.value),d=255*Math.pow(2,-f),h=255/(i*i),p=0;p<s;p++)for(var v=0;v<o;v++){I.set(c,0,0,0,0);for(var m=0;m<i;m++)for(var y=0;y<i;y++){var g=l[3+(b=t.getIndex(v*i+y|0,p*i+m|0)<<2)];c[0]+=l[b+0]*g,c[1]+=l[b+1]*g,c[2]+=l[b+2]*g,c[3]+=g}var b=qe.getIndex(v,p)<<2,w=d/c[3];u[b]=c[0]*w,u[b+1]=c[1]*w,u[b+2]=c[2]*w,u[b+3]=c[3]*h}qe.width=o,qe.height=s,n.src=qe.toDataURL(),qe.width=64,qe.height=64}}},{key:"getAbsolutePosition",value:function(t){k.set(t,0,0),e.bubble_func(this,(function(e){k.add(t,t,e.position)}))}},{key:"select",value:function(){e.select(this)}},{key:"registRefreshThumbnail",value:function(){Ve.indexOf(this)>=0||(Ve.push(this),1===Ve.length&&window.requestAnimationFrame((function(e){Te()})))}}])&&Pe(t.prototype,n),r&&Pe(t,r),e}();Re(ze,"enableRefreshThumbnail",!0),Re(ze,"click",(function(e){Fe(e.currentTarget).select(),e.stopPropagation()})),Re(ze,"DragStart",(function(e){(Ne=Fe(e.currentTarget)).select,e.stopPropagation()})),Re(ze,"DragEnter",(function(e){var t=Fe(e.currentTarget.parentNode);if(t&&(e.stopPropagation(),Ne!==t)){if(0!==Ne.type){var n=!1;if(ze.bubble_func(t,(function(e){if(e===Ne)return n=!0,!0})),n)return}var r=t.parent,a=r.children.indexOf(t);r.children.indexOf(Ne)<0&&a++,Xe.executeCommand("moveLayer",{layer_id:Ne.id,parent_layer_id:r.id,position:a})}})),Re(ze,"DragEnterChild",(function(e){Fe(e.currentTarget),e.stopPropagation(),parseInt(e.dataTransfer.getData("text"));var t=Fe(e.currentTarget.parentNode);if(0!==Ne.type){var n=!1;if(ze.bubble_func(t,(function(e){if(e===Ne)return n=!0,!0})),n)return}Xe.executeCommand("moveLayer",{layer_id:Ne.id,parent_layer_id:t.id,position:0})})),document.querySelector("#layer_param").addEventListener("change",(function(e){var t=e.target;if(selected_layer&&t){var n=selected_layer,r=e.target.id.replace("layer_","");if(""===r&&(r=e.target.title),"layer_width"!==t.id&&"layer_height"!==t.id){if("layer_x"===t.id||"layer_y"===t.id){n=selected_layer;var a=parseInt(inputs.layer_x.value),i=parseInt(inputs.layer_y.value);return a-=n.position[0],i-=n.position[1],void Xe.executeCommand("translateLayer",{layer_id:n.id,x:a,y:i})}"checkbox"===e.target.getAttribute("type")?Xe.executeCommand("changeLayerAttribute",{layer_id:n.id,name:r,value:e.target.checked}):"radio"===e.target.getAttribute("type")?(r=e.target.name,Xe.executeCommand("changeLayerAttribute",{layer_id:n.id,name:r,value:e.target.value})):Xe.executeCommand("changeLayerAttribute",{layer_id:n.id,name:r,value:e.target.value})}else{n=selected_layer;var o=parseInt(inputs.layer_width.value),s=parseInt(inputs.layer_height.value);Xe.executeCommand("resizeLayer",{layer_id:n.id,width:o,height:s})}}})),window.inputs=[],window.doc={},window.pen_log=null,window.pen_func=null,window.bloomed_img=null,window.bloom_img=null,window.preview=null,window.preview_ctx=null,window.preview_ctx_imagedata=null,window.selected_brush=null,window.Command={},window.commandObjs={},window.brushes=[];var Xe=function(){var e=function(){},t=e;t.getPosition=function(){var e={};return selected_layer?selected_layer.children&&selected_layer.div.classList.contains("open")?(e.parent_layer_id=selected_layer.id,e.parent_layer=selected_layer,e.position=selected_layer.length):(e.parent_layer_id=selected_layer.parent.id,e.parent_layer=selected_layer.parent,e.position=selected_layer.parent.children.indexOf(selected_layer)+1):(e.parent_layer_id=root_layer.id,e.parent_layer=root_layer,e.position=root_layer.length),e},t.loadImageFile_=function(t){var n=e.getPosition(),r=function(r){e.executeCommand("loadImage",{img:r,file:t.name,parent_layer_id:n.parent_layer_id,position:n.position})};/.*exr$/.test(t.name)?Img.loadExr(t,0,r):/^image\//.test(t.type)&&Img.loadImg(t,0,r)},t.createDif=function(e,t,n,r,a){var i=new Img(r,a);Img.copy(i,0,0,e.img,t,n,r,a);var o={};return o.img=i,o.x=t,o.y=n,o},t.removeLayer=function(e){var t=e.parent,n=t.children,r=n.indexOf(e);n.splice(r,1),e==selected_layer&&t.children.length>0&&(t.children.length<=r&&(r=t.children.length-1),t.children[r].select()),t.refreshDiv(),t.bubbleComposite()},t.onlyExecute=function(e,t){if(t.layer_id&&"changeLayerAttribute"!==e){var n=ze.findById(t.layer_id);if(n&&(n.lock||!n.display))return}var r={param:t};(e=Command[e]).execute?e.execute(r):e(r)},t.executeCommand=function(e,t,n){if(t.layer_id&&"changeLayerAttribute"!==e&&"moveLayer"!==e){var r=ze.findById(t.layer_id);if(r&&(r.lock||!r.display))return null}var a=CommandLog.createLog(e,t,n);return CommandLog.appendOption(),commandObjs[a.command]?(a.obj=new commandObjs[a.command],a.obj.param=t,a.obj.func()):(e=Command[a.command]).execute?e.execute(a):e(a),a},t.blendfuncs={},t.blendfuncsname=["normal","mul","add","sub","transmit"];for(var n=0;n<t.blendfuncsname.length;n++)var r=t.blendfuncsname[n];t.modifier={},t.modifiername=["grayscale","shift","blur","gradient","gradientmap","noise"];var a=document.querySelector("#modifier_area");for(n=0;n<t.modifiername.length;n++){r=t.modifiername[n];var i=document.createElement("input");i.type="button",i.title=r,i.value=r,a.appendChild(i)}return t.addFilter=function(e,t){var n=document.createElement("a");n.id=e,W.setText(n,t),n.setAttribute("href","#"),document.getElementById("additional").appendChild(n)},t.addDialog=function(e,t){var n=document.createElement("div");n.id=e,n.style.display="none",n.classList.add("area"),n.classList.add("dialog"),n.insertAdjacentHTML("beforeend",t),document.querySelector(".dialog_parent").appendChild(n)},t.showDialog=function(e){document.getElementById(e).style.display="inline",document.querySelector(".dialog_parent").style.display="flex"},t.closeDialog=function(){var e=document.querySelector(".dialog_parent");e.style.display="none";for(var t=0;t<e.children.length;t++)e.children[t].style.display="none"},t.addModifierControl=function(e,t){var n=document.createElement("div");n.id="div_"+e,n.classList.add("modifier_param"),n.insertAdjacentHTML("beforeend",t),document.querySelector("#modifier_param_area").appendChild(n)},t.undo=function(){var e=inputs.history.selectedIndex,t=inputs.history.options;if(0!==e){var n=t[e-1];n.disabled||(e--,inputs.history.selectedIndex=e,CommandLog.moveLog(parseInt(n.value)))}},t}(),Ye=function(e){var t=e.id,n=!1,r=document.createElement("span");r.setAttribute("class","js-slider"),e.parentNode.replaceChild(r,e);var a=e;a.setAttribute("type","text"),a.setAttribute("class","js-text"),""!==t&&(a.id=t),r.appendChild(a);var i=document.createElement("div");i.setAttribute("class","js-slider3"),r.appendChild(i);var o=document.createElement("span");o.max=1,o.min=0,e.max&&(o.max=parseFloat(e.max)),e.min&&(o.min=parseFloat(e.min)),e.step&&(o.step=parseInt(e.step)),e.value?a.value=e.value:a.value=o.min,o.setAttribute("class","js-slider2"),i.appendChild(o);var s=document.createElement("input");s.setAttribute("type","button"),i.appendChild(s);var l=function(e){o.step&&(e=Math.floor(e/o.step)*o.step),a.value=e,e=(e-o.min)/(o.max-o.min);var t=o.offsetWidth,n=s.offsetWidth;0==n&&(n=15),0==t&&(t=100),s.style.left=e*t-n/2+"px"},u=function(e){e||(e=window.event);var t=e.clientX,n=o.getBoundingClientRect(),r=s.offsetWidth/2*0,i=Math.round(t-n.left-r);return i/=o.clientWidth,i=(i=Math.max(Math.min(i,1),0))*(o.max-o.min)+o.min,l(i),W.fireEvent(a,"change"),!1};return s.addEventListener("pointerdown",(function(e){n=!0})),document.addEventListener("pointerup",(function(e){n=!1})),document.addEventListener("pointermove",(function(e){n&&u(e)})),s.addEventListener("touchmove",(function(e){e.preventDefault()})),i.addEventListener("click",u,!1),a.addEventListener("input",(function(e){l(e.target.value)})),l(a.value),r},He=document.createElement("style");He.type="text/css",document.getElementsByTagName("head").item(0).appendChild(He);var We=document.styleSheets.item(document.styleSheets.length-1);We.insertRule(" \t.js-slider{ \t  white-space:nowrap; \t} ",We.cssRules.length),We.insertRule(" \t.js-slider input.js-text{ \t  width:32px; \t  margin:0px 8px; \t} ",We.cssRules.length),We.insertRule(" \t.js-slider3{ \t\tdisplay:inline-block; \t  \tposition:relative; \t\tvertical-align: middle; \t\twidth:100px; \t\theight:20px; } ",We.cssRules.length),We.insertRule(" \t.js-slider2{ \t\tdisplay:inline-block; \t\tvertical-align: middle; \t\twidth:100%; \t\tbackground:#ddd; \t\theight:3px; \t\tborder:1px inset #aaa; } ",We.cssRules.length),We.insertRule(" \t.js-slider3 input{ \t  position:absolute; \t  width:15px; \t  height:100%; \t  border-width:1px; \t  touch-action:none; \t} ",We.cssRules.length);var Ge=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)};function Qe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ze(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e.init=n}(Ge,"init",(function(e){e||(e=document);for(var t=e.querySelectorAll("input.slider"),n=0;n<t.length;n+=1){var r=t[n];Ye(r)}})),window.addEventListener("load",(function(e){Ge.init()}),!1);var Je=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"getOuterCenter",value:function(e,t,n,r){var a=Vec2.len2(r,n),i=Vec2.len2(r,t),o=Vec2.len2(t,n),s=a*(i+o-a),l=i*(o+a-i),u=o*(a+i-o);Vec2.mul(e,t,s),Vec2.madd(e,e,n,l),Vec2.madd(e,e,r,u),Vec2.mul(e,e,1/(s+l+u))}},{key:"getOuterCenter3_sub",value:function(e,t,n,r){var a=Vec3.len2(r,n),i=Vec3.len2(r,t),o=Vec3.len2(t,n),s=a*(i+o-a),l=i*(o+a-i),u=o*(a+i-o);Vec3.mul(e,t,s),Vec3.madd(e,e,n,l),Vec3.madd(e,e,r,u),Vec3.mul(e,e,1/(s+l+u))}},{key:"getOuterCenter3",value:function(e,t,n,r,a){var i=Vec3.len2(r,n),o=Vec3.len2(r,t),s=Vec3.len2(t,n),l=Vec3.len2(t,a),u=Vec3.len2(n,a),c=Vec3.len2(r,a),f=i*l*(u+c-i)+o*u*(c+i-u)+s*c*(i+u-c)-2*i*u*c,d=i*l*(o+c-l)+o*u*(c+l-o)+s*c*(l+o-c)-2*l*o*c,h=i*l*(u+s-l)+o*u*(s+l-u)+s*c*(l+u-s)-2*l*u*s,p=i*l*(o+s-i)+o*u*(s+i-o)+s*c*(i+o-s)-2*i*o*s;if(Math.abs(f+d+h+p)>1e-5){var v=1/(f+d+h+p);Vec3.mul(e,t,f*v),Vec3.madd(e,e,n,d*v),Vec3.madd(e,e,r,h*v),Vec3.madd(e,e,a,p*v)}else e[0]=NaN}},{key:"LINE_POINT",value:function(e,t,n,r){var a=Vec3.poolAlloc(),i=Vec3.poolAlloc();Vec3.sub(a,n,t),Vec3.sub(i,r,t);var o=Vec3.dot(a,i);if(o<=0)Vec3.copy(e,t);else{var s=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];o>s?Vec3.copy(e,n):Vec3.madd(e,t,a,o/s)}return Vec3.poolFree(2),Vec3.len2(e,r)}},{key:"calcSquarePos",value:function(e,t,n,r,a,i){var o=Vec3.poolAlloc(),s=Vec3.poolAlloc(),l=Vec3.poolAlloc(),u=Vec3.poolAlloc(),c=Vec3.poolAlloc();Vec3.cross3(c,t,r,n,a),Vec3.sub(o,n,t),Vec3.sub(s,r,a),Vec3.sub(l,t,i),Vec3.sub(u,a,i);for(var f,d=0,h=0,p=0,v=0;v<3;v++){var m=(v+1)%3,y=(v+2)%3;d+=(o[m]*s[y]-o[y]*s[m])*c[v],h+=(o[m]*u[y]+l[m]*s[y]-(o[y]*u[m]+l[y]*s[m]))*c[v],p+=(l[m]*u[y]-l[y]*u[m])*c[v]}if(d){f=h*h-4*d*p<0?-h/(2*d):(-h+Math.sqrt(h*h-4*d*p))/(2*d);var g=Vec3.poolAlloc();Vec3.sub(g,t,a),Vec3.cross(g,g,c);var b=Vec3.poolAlloc();Vec3.sub(b,n,r),Vec3.cross(b,c,b);var w=Vec3.poolAlloc();Vec3.sub(w,n,i),(f<0&&Vec3.dot(g,l)>0||f>1&&Vec3.dot(b,w)>0)&&(f=(-h-Math.sqrt(h*h-4*d*p))/(2*d)),Vec3.poolFree(3)}else f=-p/h;e[0]=f;var _=Vec3.poolAlloc(),x=Vec3.poolAlloc();return Vec3.madd(_,a,s,f),Vec3.madd(_,_,o,-f),Vec3.sub(_,_,t),Vec3.mul(x,o,f),Vec3.add(x,x,t),Vec3.sub(x,i,x),e[1]=Vec3.dot(x,_)/Vec3.dot(_,_),Vec3.poolFree(7),f}},{key:"TETRA_POINT",value:function(e,t,n){for(var r=Vec3.poolAlloc(),a=!0,i=0;i<4;i++){var o=n[i+1&3],s=n[i+2&3],l=n[i+3&3],u=n[i];Vec3.cross2(r,o,s,l);var c=Vec3.dot(o,r),f=Vec3.dot(t,r)-c,d=Vec3.dot(u,r)-c;if(d*d<=1e-10||f*d<0){a=!1;break}e&&(e[i]=f/d)}return Vec3.poolFree(1),a}}],null&&Qe(t.prototype,null),n&&Qe(t,n),e}();function Ke(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Ze(Je,"LINE_LINE",(function(e,t,n,r,a,i){var o=Vec3.poolAlloc(),s=Vec3.poolAlloc(),l=Vec3.poolAlloc(),u=Vec3.poolAlloc();if(Vec3.sub(o,r,n),!(o[0]||o[1]||o[2]))return Vec3.copy(e,n),this.LINE_POINT(t,a,i,e),void Vec3.poolFree(4);if(Vec3.sub(s,i,a),!(s[0]||s[1]||s[2]))return Vec3.copy(t,a),this.LINE_POINT(e,n,r,t),void Vec3.poolFree(4);if(Vec3.cross(l,o,s),Vec3.scalar(l)){Vec3.cross(l,s,l);var c=Vec3.dot(l,o);Vec3.sub(u,a,n);var f=Vec3.dot(l,u);if(f*c>=0&&f*f<=c*c){Vec3.cross(l,o,s),Vec3.cross(l,o,l);var d=Vec3.dot(l,s),h=-Vec3.dot(l,u);if(h*d>=0&&h*h<=d*d)return Vec3.madd(e,n,o,f/c),Vec3.madd(t,a,s,h/d),void Vec3.poolFree(4)}}var p,v=this.LINE_POINT(u,n,r,a);Vec3.copy(e,u),Vec3.copy(t,a),(p=this.LINE_POINT(u,n,r,i))<v&&(v=p,Vec3.copy(e,u),Vec3.copy(t,i)),(p=this.LINE_POINT(u,a,i,n))<v&&(v=p,Vec3.copy(e,n),Vec3.copy(t,u)),(p=this.LINE_POINT(u,a,i,r))<v&&(v=p,Vec3.copy(e,r),Vec3.copy(t,u)),Vec3.poolFree(4)})),Ze(Je,"TRIANGLE_POINT",(function(e,t,n,r,a){var i=Vec3.poolAlloc(),o=Vec3.poolAlloc(),s=Vec3.poolAlloc(),l=Vec3.poolAlloc();o[0]=n[1]*r[2]-n[2]*r[1]+t[2]*(-n[1]+r[1])+t[1]*(n[2]-r[2]),o[1]=n[2]*r[0]-n[0]*r[2]+t[0]*(-n[2]+r[2])+t[2]*(n[0]-r[0]),o[2]=n[0]*r[1]-n[1]*r[0]+t[1]*(-n[0]+r[0])+t[0]*(n[1]-r[1]);for(var u=[t,n,r,t,n],c=0;c<3;c++){var f=u[c],d=u[c+1],h=u[c+2];if(Vec3.sub(l,a,f),Vec3.sub(i,d,f),Vec3.cross(s,o,i),Vec3.dot(s,l)<=0){var p=Vec3.dot(l,i),v=Vec3.dot(i,i);return p<0?this.LINE_POINT(e,f,h,a):p>v?this.LINE_POINT(e,d,h,a):Vec3.madd(e,f,i,p/v),void Vec3.poolFree(4)}}Vec3.madd(e,a,o,-Vec3.dot(o,l)/(o[0]*o[0]+o[1]*o[1]+o[2]*o[2])),Vec3.poolFree(4)})),Ze(Je,"TRIANGLE_LINE",(function(e,t,n,r,a){var i=Vec3.poolAlloc(),o=Vec3.poolAlloc(),s=Vec3.poolAlloc(),l=Vec3.poolAlloc();Vec3.cross2(o,e,t,n),Vec3.sub(i,e,r),Vec3.sub(s,a,r);var u=Vec3.dot(o,i)/Vec3.dot(o,s);Vec3.madd(s,r,s,u);for(var c=[e,t,n,e],f=0;f<3;f++){var d=c[f],h=c[f+1];if(Vec3.sub(i,h,d),Vec3.cross(l,o,i),Vec3.sub(i,s,d),Vec3.dot(l,i)<=0)return Vec3.poolFree(4),99999}return Vec3.poolFree(4),u}));var $e=-1,et=0,tt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.command="",this.param={},this.undo_data=null}var t,n,r;return t=e,r=[{key:"reset",value:function(){et=0;for(var t=inputs.history.options,n=t.length;n--;)inputs.history.removeChild(t[n]);e.command_logs.length=0,$e=-1}},{key:"moveLog",value:function(t){for(pen_log=null,pen_func&&(pen_func.end_flg=1,pen_func.pen_log.param.points.length=pen_func.idx,pen_func=null);$e<t;)$e++,(n=e.command_logs[$e]).obj?n.obj.func():(0,Command[n.command])(n);for(;$e>t;){var n;if((n=e.command_logs[$e]).obj)n.obj.undo(),n.obj.undo_default();else{(0,Command[n.command])(n,!0);var r=n.undo_data.difs;if(r){for(var a=n.param.layer_id,i=ze.findById(a),o=0,s=0,l=0,u=0,c=r.length;c--;){var f=r[c];Img.copy(i.img,f.x,f.y,f.img,0,0,f.img.width,f.img.height),o=Math.min(o,f.x),s=Math.max(s,f.img.width+f.x),l=Math.min(l,f.y),u=Math.max(u,f.img.height+f.y)}i.refreshImg(o,l,s-o,u-l)}}$e--}}},{key:"createLog",value:function(t,n,r){var a=null;if($e>=0&&!r){var i=e.command_logs[$e];t===i.command&&("changeLayerAttribute"===t?i.param.layer_id===n.layer_id&&i.param.name===n.name&&(a=i):"translateLayer"===t?i.param.layer_id===n.layer_id&&(a=i):"moveLayer"===t&&i.param.layer_id===n.layer_id&&(a=i))}return e.command_logs.splice($e+1,e.command_logs.length-($e+1)),a||((a=new e).id=et,et++,$e++,e.command_logs.push(a)),a.command=t,n&&(a.param=n),a}},{key:"appendOption",value:function(){for(var t=inputs.history.options,n=null,r=t.length;r--&&!(t[r].value<$e);)n=t[r];r++;for(var a=t.length-1;a>r;a--)inputs.history.removeChild(t[a]);n||(n=document.createElement("option"),inputs.history.appendChild(n));var i=e.command_logs[$e];if(n.value=$e,i.option=n,i.refreshLabel(),inputs.history.selectedIndex=t.length-1,t.length>10){var o=t[t.length-10-1],s=e.command_logs[o.value];o.setAttribute("disabled","disabled"),s.undo_data=null}return t.length>10&&inputs.history.removeChild(t[0]),n}}],(n=[{key:"refreshLabel",value:function(){for(var e=this,t="",n=e.param,r=Object.keys(n),a=0;a<r.length;a++)a&&(t+=","),t+=n[r[a]];var i=("0000"+e.id).substr(-4)+"| "+e.command+"("+t+")";W.setText(this.option,i)}}])&&Ke(t.prototype,n),r&&Ke(t,r),e}();function nt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(tt,"command_logs",[]);var rt,at,it=!1,ot=[],st=0,lt=function(e){return brushes.find((function(t){return t.div===e}))},ut=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name="",this.color_effect=[1,1,1,1],this.weight=3,this.softness=0,this.overlap=0,this.alpha=1,this.antialias=0,this.eraser=0,this.weight_pressure_effect=0,this.alpha_pressure_effect=0,this.stroke_correction=0,this.stroke_interpolation=1,this.shortcut="",this.div=[]}var t,n,r;return t=e,r=[{key:"init",value:function(){var t=document.getElementById("brush_param");ot=(ot=Array.prototype.slice.call(t.getElementsByTagName("input"))).concat(Array.prototype.slice.call(t.getElementsByTagName("select"))),document.querySelector("#up_brush").addEventListener("click",(function(){var e=brushes.indexOf(selected_brush);e<=0||(brushes.splice(e,1),brushes.splice(e-1,0,selected_brush),refreshBrush())})),document.querySelector("#down_brush").addEventListener("click",(function(){var e=brushes.indexOf(selected_brush);e+1>=brushes.length||(brushes.splice(e,1),brushes.splice(e+1,0,selected_brush),refreshBrush())})),document.querySelector("#update_brush").addEventListener("click",(function(){selected_brush.update()})),document.querySelector("#create_brush").addEventListener("click",(function(){var t=e.create();brushes.push(t),t.update(),t.select(),e.refreshBrush()})),document.querySelector("#delete_brush").addEventListener("click",(function(){selected_brush.delete()}));var n=(at=new CommandLog).param,r=document.getElementById("pen_preview");rt=new Img(r.width,r.height),n.layer=ze.create(rt,0);for(var a=[],i=[-1,-.7,-.3,.3,.7,1],o=0;o<i.length;o++){var s=i[o],l={pos:new k,pressure:0};l.pos[0]=(.8*s+1)*(r.width>>>1),l.pos[1]=(.7*Math.sin(s*Math.PI)+1)*(r.height>>>1),l.pressure=1-o/(i.length-1),a.push(l)}n.points=a,n.color_effect=new Float32Array([1,1,1,1]),n.undo_data={}}},{key:"create",value:function(){var t=document.getElementById("brush_template"),n=new e,r=t.children[0].cloneNode(!0);return n.div=r,n.id=st,st++,n.name="brush"+("0000"+n.id).slice(-4),e.refreshBrush(n),n}},{key:"setParam",value:function(e){e.color=new Float32Array(4),e.color[0]=inputs.color_R.value,e.color[1]=inputs.color_G.value,e.color[2]=inputs.color_B.value,e.color[3]=inputs.color_A.value,e.weight=Number(inputs.weight.value),e.softness=Number(inputs.softness.value),e.antialias=Number(inputs.brush_antialias.checked),e.eraser=Number(inputs.eraser.checked),e.alpha=inputs.brush_alpha.value,e.overlap=parseInt(inputs.brush_overlap.value),e.pressure_effect_flgs=1*Number(inputs.weight_pressure_effect.checked)|2*Number(inputs.alpha_pressure_effect.checked),e.alpha_pressure_effect=inputs.alpha_pressure_effect.checked,e.stroke_interpolation=inputs.stroke_interpolation.checked}},{key:"refreshPen",value:function(t){var n=at.param;if(t?(n.color=new Float32Array([0,0,0,1]),n.weight=parseFloat(t.weight),n.softness=parseFloat(t.softness),n.antialias=t.antialias,n.alpha=t.alpha,n.eraser=t.eraser,n.overlap=parseInt(t.overlap),n.pressure_effect_flgs=1*t.weight_pressure_effect|2*t.alpha_pressure_effect,n.alpha_pressure_effect=t.alpha_pressure_effect,n.stroke_interpolation=t.stroke_interpolation):e.setParam(n),painted_mask.fill(0),n.eraser)for(var r=rt.data,a=r.length,i=0;i<a;i+=4)r[i]=0,r[i+1]=0,r[i+2]=0,r[i+3]=1;else rt.clear();for(var o=at.param.points,s=1;s<o.length;s++)Command.drawHermitian(at,s);var l=rt.toDataURL();t?t.div.querySelector("img").src=l:document.getElementById("pen_preview").src=l}},{key:"refreshPreview",value:function(){it||(window.requestAnimationFrame(e.refreshPreview_),it=!0)}},{key:"refreshPreview_",value:function(){e.refreshPen(),it=!1}},{key:"DragStart",value:function(e){drag_brush=lt(e.currentTarget),e.stopPropagation()}},{key:"dragover_handler",value:function(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}},{key:"refreshBrush",value:function(e){if(e)e.div.getElementsByClassName("name")[0].innerHTML="["+e.shortcut+"]"+e.name,e.div.getElementsByClassName("attributes")[0].innerHTML="";else{for(var t=document.getElementById("brushes_container");t.firstChild;)t.removeChild(t.firstChild);for(var n=0;n<brushes.length;n++)t.appendChild(brushes[n].div)}}},{key:"DragEnter",value:function(e){var t=lt(e.currentTarget);if(e.stopPropagation(),drag_brush!==t){var n=brushes.indexOf(drag_brush),r=brushes.indexOf(t);brushes.splice(n,1),brushes.splice(r,0,drag_brush),refreshBrush()}}},{key:"brushselect",value:function(e){lt(e.currentTarget).select(),e.stopPropagation()}}],(n=[{key:"delete",value:function(){var t=brushes.indexOf(this);brushes.splice(t,1),t>=brushes.length&&(t=brushes.length-1),t>=0&&brushes[t].select(),e.refreshBrush()}},{key:"refresh",value:function(){e.refreshBrush(this),e.refreshPen(this)}},{key:"update",value:function(){for(var e=this,t=0;t<ot.length;t++){var n=ot[t];n.id;var r=n.id.replace("brush_","");r in e&&("checkbox"===n.getAttribute("type")?e[r]=Number(n.checked):e[r]=n.value)}e.refresh()}},{key:"delete",value:function(){var e=brushes.indexOf(selected_brush);brushes.splice(e,1),refreshBrush()}},{key:"select",value:function(){selected_brush=this;for(var t=0;t<brushes.length;t++){var n=brushes[t];selected_brush!==n?n.div.classList.remove("active"):n.div.classList.add("active")}if(n=this){for(var r=0;r<ot.length;r++){var a=ot[r];a.id;var i=a.id.replace("brush_","");i in n&&("checkbox"===a.getAttribute("type")?a.checked=n[i]:a.value=n[i],W.fireEvent(a,"input"))}inputs.pen.checked=!0,e.refreshPreview()}}}])&&nt(t.prototype,n),r&&nt(t,r),e}();function ct(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:null,enumerable:!0,configurable:!0,writable:!0}):e[t]=null}(ut,"drag_brush");var ft=function(e){for(var t=[],n=4294967295,r=0;r<256;r++){for(var a=r,i=0;i<8;i++)1&a?a=a>>>1^3988292384:a>>>=1;t.push(a>>>0)}for(r=0;r<e.length;r++)n=(n>>>8^t[e[r]^255&n])>>>0;return~n>>>0},dt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"read",value:function(e){for(var t=new Q(e),n=[];67324752===t.getUint32(!0);){var r={};n.push(r),t.getUint16(!0),t.getUint16(!0),t.getUint16(!0),t.getUint16(!0),t.getUint16(!0),t.getUint32(!0);var a=t.getUint32(!0);t.getUint32(!0);var i=t.getUint16(!0);t.getUint16(0,!0),r.name=W.utf8ToString(t.getBytes(i)),t.fill(0,0),r.data=t.getBytes(a)}return n}},{key:"create",value:function(e){for(var t=[],n=0,r=0;r<e.length;r++){var a={};t.push(a),a.name_utf8=W.stringToUtf8(e[r].name),a.data=e[r].data,a.offset=n,a.crc=ft(a.data),n+=30+a.data.length+a.name_utf8.length}for(n+=46*t.length+22,r=0;r<t.length;r++)n+=t[r].name_utf8.length;var i=new Q(n);for(r=0;r<t.length;r++)a=t[r],i.setUint32(67324752,!0),i.setUint16(20,!0),i.setUint16(0,!0),i.setUint16(0,!0),i.setUint16(0,!0),i.setUint16(0,!0),i.setUint32(a.crc,!0),i.setUint32(a.data.length,!0),i.setUint32(a.data.length,!0),i.setUint16(a.name_utf8.length,!0),i.setUint16(0,!0),i.setBytes(a.name_utf8),i.fill(0,0),i.idx,i.setBytes(a.data);var o=i.getByteIndex();for(r=0;r<t.length;r++)a=t[r],i.setUint32(33639248,!0),i.setUint8(20,!0),i.setUint8(10,!0),i.setUint16(20,!0),i.setUint16(0,!0),i.setUint16(0,!0),i.setUint16(0,!0),i.setUint16(0,!0),i.setUint32(a.crc,!0),i.setUint32(a.data.length,!0),i.setUint32(a.data.length,!0),i.setUint16(a.name_utf8.length,!0),i.setUint16(0,!0),i.setUint16(0,!0),i.setUint16(0,!0),i.setUint16(0,!0),i.setUint32(0,!0),i.setUint32(a.offset,!0),i.setBytes(a.name_utf8),i.fill(0,0),i.fill(0,0);var s=i.getByteIndex()-o;return i.setUint32(101010256,!0),i.setUint16(0,!0),i.setUint16(0,!0),i.setUint16(t.length,!0),i.setUint16(t.length,!0),i.setUint32(s,!0),i.setUint32(o,!0),i.setUint16(0,!0),i.setTextBuf(""),i.byteBuffer}}],null&&ct(t.prototype,null),n&&ct(t,n),e}();function ht(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Xe.addDialog("loading","\n\t\tファイル読み込み中...\n\n\t\t");var pt=function(e,t){for(var n=Object.keys(t),r=0;r<n.length;r++){var a=n[r];"number"==typeof e[a]?e[a]=Number(t[a]):e[a]=t[a]}},vt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"saveHpd",value:function(e){var t=[],n={},r=Layer.layerArray();n.layers=[];for(var a=0;a<r.length;a++){var i=r[a],o={};if(0===i.type){var s={};t.push(s),s.data=new Uint8Array(i.img.createExr(3)),s.name=i.id+".exr"}else o.size=new k,k.copy(o.size,i.size);for(var l=Object.keys(i),u=0;u<l.length;u++)o[l[u]]=i[l[u]];if(i.children)for(o.children=[],u=0;u<i.children.length;u++)o.children.push(i.children[u].id);delete o.img,delete o.parent,delete o.div,delete o.aaadiv,n.layers.push(o)}n.brushes=[];for(var c=0;c<brushes.length;c++){var f=brushes[c],d={};for(l=Object.keys(f),u=0;u<l.length;u++)d[l[u]]=f[l[u]];delete d.div,n.brushes.push(d)}n.canvas_width=preview.width,n.canvas_height=preview.height,l=Object.keys(inputs);for(var h=0;h<l.length;h++){var p=l[h],v=inputs[p];n[p]=v.value,"checkbox"===v.type&&(v.checked?n[p]=1:n[p]=0)}n.layer_id_count=Layer.layer_id_count,(s={}).data=W.stringToUtf8(JSON.stringify(n)),s.name="doc.txt",t.push(s);var m=dt.create(t),y=new Blob([m],{type:"application/octet-stream"}),g=e.target;g.href=window.URL.createObjectURL(y),g.target="_blank",g.download="project.hpd"}},{key:"loadHpd",value:function(e){Xe.showDialog("loading"),W.loadBinary(e,(function(t){!function(e){var t=dt.read(e),n=t.find((function(e){return"doc.txt"===e.name}));if(n){Ae.disableRefresh(),root_layer&&Command.deleteLayer({param:{layer_id:root_layer.id}});for(var r=JSON.parse(W.utf8ToString(n.data)),a=Object.keys(r),i=0;i<a.length;i++){var o=a[i],s=inputs[o];s&&(s.value=r[o],"checkbox"===s.type&&"1"===s.value&&(s.checked=!0))}Layer.layer_id_count=r.layer_id_count,brushes=[];for(var l=0;l<r.brushes.length;l++){var u=r.brushes[l],c=ut.create();brushes.push(c),o=c.id,pt(c,u),c.id=o,c.refresh()}ut.refreshBrush();for(var f=[],d=0;d<r.layers.length;d++){var h=r.layers[d];switch(parseInt(h.type)){case 0:var p=r.layers[d].id+".exr",v=t.find((function(e){return e.name===p})),m=Me.loadExr(v.data);y=Layer.create(m,0);break;case 1:m=new Me(h.size[0],h.size[1]),y=Layer.create(m,1);break;case 2:y=Layer.createModifier(h.modifier)}for(f.push(y),a=Object.keys(h),i=0;i<a.length;i++)"number"==typeof y[a[i]]?y[a[i]]=parseFloat(h[a[i]]):y[a[i]]=h[a[i]]}for(root_layer=f[0],Xe.onlyExecute("resizeCanvas",{width:root_layer.img.width,height:root_layer.img.height}),d=f.length;d--;){var y=f[d];if((h=r.layers[d]).children)for(y.children=[],i=0;i<h.children.length;i++){var g=h.children[i],b=f.find((function(e){return e.id===g}));y.append(i,b)}}var w=0;for(d=0;d<f.length;d++)(y=f[d]).refreshDiv(),w=Math.max(w,y.id);Layer.setLayerIdCount(w+1),Ae.enableRefresh(),Ae.compositeAll(),refreshTab("tools"),root_layer.children[root_layer.children.length-1].select(),Xe.changeColor(null),CommandLog.reset(),brushes.length>0&&brushes[0].select()}}(t);var n=CommandLog.createLog("loadDocumentFile",{file:e.name});CommandLog.appendOption(n),Xe.closeDialog()}))}},{key:"saveHdr",value:function(e){var t=e.target,n=root_layer.img.createExr(3),r=new Blob([n],{type:"application/octet-stream"});t.href=window.URL.createObjectURL(r),t.target="_blank",t.download="preview_hdr.exr"}},{key:"saveLdr",value:function(e){var t=e.target;t.href=preview.toDataURL("image/png"),t.target="_blank",t.download="preview_ldr.png"}}],null&&ht(t.prototype,null),n&&ht(t,n),e}(),mt=function(){var e=document.createElement("style");e.type="text/css",document.getElementsByTagName("head").item(0).appendChild(e);var t=document.styleSheets.item(document.styleSheets.length-1);t.insertRule(" \t\t.css_hsv{ \t\t}",t.cssRules.length);var n=new k;n[0]=.5,n[1]=.5;var r=0,a=new Me(128,128,Me.FORMAT_UINT8),i=new Me(8,128,Me.FORMAT_UINT8),o=document.getElementById("img_hsv");o.className="css_hsv";var s=document.getElementById("img_hsv2"),l=document.getElementById("cursor_img_hsv"),u=document.getElementById("cursor2_img_hsv"),c=document.getElementById("cursor_img_hsv2"),f={};f.color=new M,f.func=null;var d=new M,h=new M,p=function(){l.style.left=128*n[0]-1+"px",u.style.top=128*n[1]-1+"px",c.style.top=128*r-1+"px"};f.setRGB=function(e){M.copy(f.color,e),W.rgb2hsv(d,f.color),r=d[0],n[0]=d[2],n[1]=1-d[1],p(),v()};for(var v=f.redraw=function(){var e=0;d[0]=r,d[1]=1,d[2]=1,W.hsv2rgb(h,d);for(var t=0;t<a.height;t++){var n=t/a.height;d[0]=(1-h[0])*n+h[0],d[1]=(1-h[1])*n+h[1],d[2]=(1-h[2])*n+h[2];for(var i=a.data,s=0;s<a.width;s++){var l=s/a.width;i[e]=d[0]*l*255,i[e+1]=d[1]*l*255,i[e+2]=d[2]*l*255,i[e+3]=255,e+=4}}o.src=a.toDataURL()},m=i.data,y=0,g=0;g<i.height;g++){d[0]=g/i.height,d[1]=1,d[2]=1,W.hsv2rgb(d,d),d[0]=255*d[0]|0,d[1]=255*d[1]|0,d[2]=255*d[2]|0;for(var b=0;b<i.width;b++)m[y]=d[0],m[y+1]=d[1],m[y+2]=d[2],m[y+3]=255,y+=4}s.src=i.toDataURL();var w=0,_=0,x=function(e){if(!(1&e.buttons))return _=0,void(w=0);if(_){var t=o.getBoundingClientRect();n[0]=e.clientX-t.left,n[1]=e.clientY-t.top,n[0]=n[0]/a.width,n[1]=n[1]/a.height,n[0]=Math.min(Math.max(n[0],0),1),n[1]=Math.min(Math.max(n[1],0),1)}else w&&(t=s.getBoundingClientRect(),r=e.clientY-t.top,r/=i.height,r=Math.min(Math.max(r,0),1),v());(_||w)&&(p(),d[0]=r,d[1]=1-n[1],d[2]=n[0],W.hsv2rgb(f.color,d),f.func&&f.func())};return document.getElementById("img_hsv_area").addEventListener("pointerdown",(function(e){_=1,x(e)})),s.addEventListener("pointerdown",(function(e){w=1,x(e)})),window.addEventListener("pointermove",x),f}();function yt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var gt=-1,bt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.pen_log=null,this.endFlg=0,this.idx=0,this.ragtime=0;var t=this;setTimeout((function(){t.actualDraw()}),1)}var t,n;return t=e,(n=[{key:"end",value:function(){this.endFlg=1}},{key:"actualDraw",value:function(){var e=this,t=this.pen_log,n=t.param.points;if(gt>=0&&(clearTimeout(gt),gt=-1),this.endFlg&&n.length<=this.idx)ze.findById(t.param.layer_id),Xe.blendfuncs,painted_mask.fill(0);else if(n.length<=this.idx)gt=setTimeout((function(){e.actualDraw()}),16);else{var r=Date.now(),a=n[this.idx],i=this.ragtime-(r-a.time);if(i>0)gt=setTimeout((function(){e.actualDraw()}),.5*i);else{if(this.idx>=1){t.label=("0000"+t.id).slice(-4)+"| "+t.command,t.label+="("+n[0].pos[0].toFixed(2)+","+n[0].pos[1].toFixed(2)+")-",t.label+=n.length-2+"-",t.label+="("+n[n.length-1].pos[0].toFixed(2)+","+n[n.length-1].pos[1].toFixed(2)+")";var o=inputs.history.options[inputs.history.selectedIndex];W.setText(o,t.label),Command.drawHermitian(t,this.idx)}this.idx++,n.length<=this.idx?gt=setTimeout((function(){e.actualDraw()}),16):(i=Math.max(this.ragtime-(r-a.time),1),gt=setTimeout((function(){e.actualDraw()}),.5*i))}}}}])&&yt(t.prototype,n),e}(),wt=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.pos=new k,this.pressure=1};Command.eraser=function(e,t){Command.brush(e,t)},Command.brush=function(e,t){if(!t){var n=e.param,r=(ze.findById(n.layer_id),n.points);painted_mask.fill(0);for(var a=1;a<r.length;a++)Command.drawHermitian(e,a)}},Command.drawHermitian=function(){for(var e=new k,t=new k,n=new k,r=new k,a=new k,i=new k,o=[],s=0;s<32;s++)o.push(new wt);var l=function(e,t,n){return Math.min(n,Math.max(t,e))},u=function(e,t,n,r,a,i,o){var s=o.alpha_mask,l=o.color,u=l[3]*o.alpha;o.eraser&&(u=o.alpha),o.alpha_pressure_effect&&(u*=n);var c=k.scalar(r);if(o.softness?u*=Math.min(1,(i-i*c)/(i*o.softness)):o.antialias&&(u*=Math.min(1,i-i*c)),o.eraser&&2===o.overlap)e[t+3]=(1-u)*(1-o.alpha);else{if(2===o.overlap)return e[t+0]=l[0],e[t+1]=l[1],e[t+2]=l[2],void(s||(e[t+3]=u));if(0==o.overlap){if(a[t>>2]>=u)return;var f=a[t>>2];a[t>>2]=u,u=(u-f)/(1-f)}if(o.eraser)e[t+3]=e[t+3]*(1-u)+0*u;else{var d=e[t+3]*(1-u);if(s||(e[t+3]=d+u),e[t+3]&&!o.eraser){var h=1/e[t+3];d*=h,u*=h,e[t+0]+=e[t+0]*(-1+d)+l[0]*u,e[t+1]+=e[t+1]*(-1+d)+l[1]*u,e[t+2]+=e[t+2]*(-1+d)+l[2]*u}}}},c=new k,f=new k,d=new k,h=function(e,t,n,r){var a=r.weight,i=r.pressure_effect_flgs,o=(r.softness,e.data);a*=.5;var s=1&i,h=n.pos,p=t.pos,v=t.pressure,m=n.pressure-t.pressure,y=a*((v-1)*s+1),g=a*((m+v-1)*s+1),b=Math.max(y,g),w=(y*=y,g*=g,Math.min(h[0],p[0])),_=Math.max(h[0],p[0])+1,x=Math.min(h[1],p[1]),M=Math.max(h[1],p[1])+1;w=Math.floor(l(w-b,0,e.width)),_=Math.ceil(l(_+b,0,e.width)),x=Math.floor(l(x-b,0,e.height)),M=Math.ceil(l(M+b,0,e.height)),k.sub(c,h,p),0!==(O=k.scalar2(c))?k.mul(c,c,1/O):k.set(c,0,0),k.set(f,c[1],-c[0]),k.norm(f);for(var I=u,E=x;E<M;E++)for(var L=w;L<_;L++){d[0]=L-p[0]+.5,d[1]=E-p[1]+.5;var C=k.dot(c,d),O=0,B=0;if(C<=0){if(k.scalar2(d)>=y)continue;C=0,O=k.scalar(d),A=a*(((B=m*C+v)-1)*s+1)}else if(C>=1){if(d[0]=L-h[0]+.5,d[1]=E-h[1]+.5,k.scalar2(d)>=g)continue;C=1,O=k.scalar(d),A=a*(((B=m*C+v)-1)*s+1)}else{var A=a*(((B=m*C+v)-1)*s+1);if((O=k.dot(d,f))*O>=A*A)continue;k.mul(d,f,O),O=Math.abs(O)}var P=E*e.width+L|0;k.mul(d,d,1/A),I(o,P<<2,B,d,painted_mask,A,r)}},p=new k;return function(s,u){var c=(w=s.param).points,f=ze.findById(w.layer_id);f||(f=w.layer);var d=f.img;f.getAbsolutePosition(p);var v,m=c[u-1],y=c[u],g=m.pos,b=y.pos,w=s.param;if(u>=2){k.sub(e,g,c[u-2].pos);var _=k.scalar(e);k.sub(t,b,g),_+(v=k.scalar(t))>0&&(k.mul(a,e,v/(_+v)),k.madd(a,a,t,_/(_+v)))}else k.sub(a,b,g);u+1<c.length?(k.sub(e,b,g),_=k.scalar(e),k.sub(t,c[u+1].pos,b),_+(v=k.scalar(t))>0&&(k.mul(i,e,v/(_+v)),k.madd(i,i,t,_/(_+v)))):(k.sub(i,b,g),k.madd(i,i,a,-.5));k.copy(r,g),k.copy(n,a),k.madd(e,i,b,-2),k.add(e,e,a),k.madd(e,e,g,2),k.sub(t,b,e),k.sub(t,t,a),k.sub(t,t,g);var x=y.pressure-m.pressure,M=k.len(b,g),I=l(M/4|0,1,31);w.stroke_interpolation||(I=1);var E=1/I,L=.5*w.weight;1&w.pressure_effect_flgs&&(L*=Math.max(m.pressure,y.pressure));for(var C=d.width,O=0,B=d.height,A=0,P=0;P<I+1;P++){var R=o[P],T=P*E+0;k.mul(R.pos,e,T*T*T),k.madd(R.pos,R.pos,t,T*T),k.madd(R.pos,R.pos,n,T),k.add(R.pos,R.pos,r),k.sub(R.pos,R.pos,p),R.pressure=m.pressure+x*T,C=Math.min(R.pos[0],C),O=Math.max(R.pos[0],O),B=Math.min(R.pos[1],B),A=Math.max(R.pos[1],A)}if(C=Math.floor(l(C-L,0,d.width-1)),O=Math.ceil(l(O+L,0,d.width-1)),B=Math.floor(l(B-L,0,d.height-1)),A=Math.ceil(l(A+L,0,d.height-1)),s){var U=s;if(U.undo_data||(U.undo_data={difs:[]}),U.undo_data.difs.length<u){var V=Xe.createDif(f,C,B,O-C+1,A-B+1);U.undo_data.difs.push(V)}}for(P=0;P<I;P++)h(f.img,o[P],o[P+1],w);f.refreshImg(C,B,O-C+1,A-B+1)}}(),Command.changeLayerAttribute=function(e,t){var n=e.param,r=n.name,a=n.value,i=ze.findById(n.layer_id);t&&(a=e.undo_data.value),e.undo_data||(e.undo_data={value:i[r]}),i[r]=a,i.refreshDiv(),i.parent.bubbleComposite()},Command.changeModifierAttribute=function(e,t){var n=e.param,r=n.name,a=n.value,i=Layer.findById(n.layer_id);t&&(a=e.undo_data.value),e.undo_data||(e.undo_data={value:i[r]}),i[r]=a,i.refreshDiv(),i.parent.bubbleComposite()},Command.clear=function(e,t){if(!t){var n=e.param,r=Layer.findById(n.layer_id);if(!e.undo_data){e.undo_data={};var a=r.img,i=Xe.createDif(r,0,0,a.width,a.height);r.img=a,e.undo_data.difs=[],e.undo_data.difs.push(i)}r.img.data.fill(0),r.refreshImg()}},Command.composite=function(e,t){var n=e.param;if(t){var r=e.undo_data;return(a=r.layer).children=r.children,a.type=1,void a.refreshDiv()}var a=Layer.findById(n.layer_id);e.undo_data||(e.undo_data={layer:a,children:a.children}),a.type=0,a.children=null,a.refreshDiv()},Command.createNewLayer=function(e,t){var n,r=e.param,a=r.width,i=r.height,o=r.position;if(!t){if(e.undo_data)n=e.undo_data.layer;else{for(var s=new Img(a,i),l=s.data,u=0;u<l.length;u+=4)l[u+0]=1,l[u+1]=1,l[u+2]=1,l[u+3]=0;n=ze.create(s,r.composite_flg),e.undo_data={layer:n}}return ze.findById(r.parent).append(o,n),ze.select(n),n}Xe.removeLayer(e.undo_data.layer)},Command.createNewCompositeLayer=function(e,t){Command.createNewLayer(e,t)};var _t=function(){var e=function(){this.param={},this.undo_data=null};return e.prototype.undo=function(){},e.prototype.func=function(){},e.prototype.undo_default=function(){var e=this.undo_data.difs;if(e)for(var t=this.param.layer_id,n=Layer.findById(t),r=e.length;r--;){var a=e[r];Img.copy(n.img,a.x,a.y,a.img,0,0,a.img.width,a.img.height),n.refreshImg(a.x,a.y,a.img.width,a.img.height)}},e}();function xt(e){return(xt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function kt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Mt(e,t){return(Mt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function It(e,t){return!t||"object"!==xt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Et(e){return(Et=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Lt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Mt(e,t)}(o,e);var t,n,r,a,i=(r=o,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=Et(r);if(a){var n=Et(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return It(this,e)});function o(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),i.call(this)}return t=o,(n=[{key:"undo",value:function(){var e=this.undo_data.layer;Xe.removeLayer(e)}},{key:"func",value:function(){var e,t=this.param,n=t.src_layer,r=t.position;if(this.undo_data)e=this.undo_data.layer;else{n=ze.findById(t.src_layer_id);var a=new Img(n.size[0],n.size[1]);Img.copy(a,0,0,n.img,0,0,a.width,a.height),e=ze.create(a,0);for(var i=Object.keys(e),o=0;o<i.length;o++){var s=i[o];["id","div","img","children"].indexOf(s)>=0||(e[s]instanceof k?k.copy(e[s],n[s]):e[s]=n[s])}e.refreshDiv(),this.undo_data={layer:e}}return ze.findById(t.parent).append(r,e),ze.select(e),e}}])&&kt(t.prototype,n),o}(_t);function Ct(e){return(Ct="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ot(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Bt(e,t){return(Bt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function At(e,t){return!t||"object"!==Ct(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Pt(e){return(Pt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e.name=n}(Lt,"name","copylayer"),commandObjs.copylayer=Lt;var Rt,Tt,Ut,Vt,jt,St,Dt,Ft,Nt,qt,zt,Xt,Yt,Ht,Wt,Gt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Bt(e,t)}(o,e);var t,n,r,a,i=(r=o,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=Pt(r);if(a){var n=Pt(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return At(this,e)});function o(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),i.call(this)}return t=o,(n=[{key:"undo",value:function(){var e=this.undo_data.layer;Xe.removeLayer(e)}},{key:"func",value:function(){var e,t=this.param,n=(t.src_layer,t.position);return this.undo_data?e=this.undo_data.layer:(e=ze.createModifier(t.modifier),k.set(e.size,t.width,t.height),this.undo_data={layer:e}),ze.findById(t.parent_layer_id).append(n,e),ze.select(e),e}}])&&Ot(t.prototype,n),o}(_t);function Qt(e){return(Qt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Zt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Jt(e,t){return(Jt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Kt(e,t){return!t||"object"!==Qt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function $t(e){return($t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e.name=n}(Gt,"name","createmodifier"),commandObjs.createmodifier=Gt,Command.deleteLayer=function(e,t){if(t){var n=e.undo_data.layer,r=e.undo_data.position;return(a=Layer.findById(e.undo_data.parent)).append(r,n),void n.select()}var a,i=e.param.layer_id;if(a=(n=Layer.findById(i)).parent){var o=a.children;r=o.indexOf(n),e.undo_data||(e.undo_data={layer:n,position:r,parent:a.id});var s=o.indexOf(n);Xe.removeLayer(n),n===selected_layer&&(0===o.length?a.select():s<o.length?o[s].select():o[o.length-1].select())}a&&a.bubbleComposite()},Command.fill=(Nt=[],qt=new k,Xt=function(e,t,n,r){var a=e.img,i=a.getIndex(n,r)<<2,o=a.data;return jt===o[i]&&St===o[i+1]&&Dt===o[i+2]&&Ft===o[i+3]},Yt=function(e,t,n,r){var a=n+qt[0],i=r+qt[1];if(t.width<=a||a<0||i<0||t.height<=i)return!1;var o=e.img,s=o.getIndex(n,r)<<2,l=t.getIndex(a,i)<<2,u=t.data;return 1!==o.data[s+3]&&1!==u[l+3]},Ht=zt=function(e,t,n,r){var a=n+qt[0],i=r+qt[1];if(t.width<=a||a<0||i<0||t.height<=i)return!1;var o=e.img,s=o.getIndex(n,r)<<2,l=t.getIndex(a,i)<<2,u=t.data,c=o.data;return Rt===u[l]&&Tt===u[l+1]&&Ut===u[l+2]&&Vt===u[l+3]&&jt===c[s]&&St===c[s+1]&&Dt===c[s+2]&&Ft===c[s+3]},Wt=function(e,t,n,r){var a=e.img,i=root_layer.img,o=0,s=n;for(a.getIndex(0,t);s>=0&&Ht(e,i,s,t);s--)0===o&&(o=1);for(1===o&&(Nt.push(t),Nt.push(s+1)),s=n;s<r;s++)Ht(e,i,s,t)?0===o&&(Nt.push(t),Nt.push(s),o=1):1===o&&(Nt.push(s),o=0);if(1===o){for(s=r-1;s<a.width&&Ht(e,i,s,t);s++);Nt.push(s)}},function(e,t){if(!t){var n,r,a,i,o=e.param,s=ze.findById(o.layer_id);s.getAbsolutePosition(qt);var l=o.x,u=o.y,c=o.color;Ht=zt,o.is_layer&&(Ht=Xt),inputs.fill_alpha.checked&&(Ht=Yt);var f=s.mask_alpha,d=1-f;Nt=[];var h=0|l,p=0|u;r=p,a=p,n=h,i=h;var v=s.img,m=root_layer.img,y=m.getIndex(h+s.position[0],p+s.position[1])<<2;Rt=m.data[y],Tt=m.data[y+1],Ut=m.data[y+2],Vt=m.data[y+3],y=v.getIndex(h,p)<<2,jt=v.data[y],St=v.data[y+1],Dt=v.data[y+2],Ft=v.data[y+3];var g=c[0],b=c[1],w=c[2],_=c[3],x=v.data;if(jt!==g||St!==b||Dt!==w||Ft!==_){var k=new Img(v.width,v.height);for(Img.copy(k,0,0,v,0,0,v.width,v.height),Nt.push(p),Nt.push(h),Nt.push(h);Nt.length;){for(var M=Nt.pop(),I=Nt.pop(),E=Nt.pop(),L=v.getIndex(0,E)<<2,C=I;C<M;C++)x[(y=L+(C<<2))+0]=g,x[y+1]=b,x[y+2]=w,x[y+3]=x[y+3]*f+_*d;E>0&&Wt(s,E-1,I,M),E<v.height-1&&Wt(s,E+1,I,M),n=Math.min(n,I),i=Math.max(i,M),r=Math.min(r,E),a=Math.max(a,E+1)}var O=i-n,B=a-r;if(!e.undo_data){e.undo_data={};var A=s.img;s.img=k;var P=Xe.createDif(s,n,r,O,B);s.img=A,e.undo_data.difs=[],e.undo_data.difs.push(P)}s.refreshImg(n,r,i-n+1,a-r+1)}}});var en=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Jt(e,t)}(o,e);var t,n,r,a,i=(r=o,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=$t(r);if(a){var n=$t(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return Kt(this,e)});function o(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),i.call(this)}return t=o,(n=[{key:"undo",value:function(){var e=this.undo_data,t=e.layer,n=t.parent;n.append(e.position,e.layerA),n.append(e.positionB,e.layerB),Xe.removeLayer(t)}},{key:"func",value:function(){var e,t=this.param,n=ze.findById(t.layer_id),r=ze.findById(t.layer_id2),a=n.parent,i=a.children,o=[n,r];if(this.undo_data)e=this.undo_data.layer;else{var s=Math.min(n.position[0],r.position[0]),l=Math.min(n.position[1],r.position[1]),u=Math.max(n.position[0]+n.size[0],r.position[0]+r.size[0])-s,c=Math.max(n.position[1]+n.size[1],r.position[1]+r.size[1])-l,f=i.indexOf(n),d=i.indexOf(r),h=new Img(u,c);(e=ze.create(h,1)).position[0]=s,e.position[1]=l,e.name=n.name+","+r.name,e.append(0,n),e.append(1,r),k.sub(r.position,r.position,e.position),k.sub(n.position,n.position,e.position),e.composite(),e.type=0,e.children=[],k.add(r.position,r.position,e.position),k.add(n.position,n.position,e.position),e.refreshDiv(),this.undo_data={layerA:n,position:f,layerB:r,positionB:d,layer:e}}for(var p=0;p<o.length;p++){var v=i.indexOf(o[p]);i.splice(v,1)}a.append(v,e),e.select()}}])&&Zt(t.prototype,n),o}(_t);function tn(e){return(tn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function nn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function rn(e,t){return(rn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function an(e,t){return!t||"object"!==tn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function on(e){return(on=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e.name=n}(en,"name","JoinLayer"),commandObjs.joinLayer=en;var sn,ln,un=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&rn(e,t)}(o,e);var t,n,r,a,i=(r=o,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=on(r);if(a){var n=on(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return an(this,e)});function o(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),i.call(this)}return t=o,(n=[{key:"undo",value:function(){Xe.removeLayer(this.undo_data.layer)}},{key:"func",value:function(){var e,t=this.param,n=(t.position,this.param.img),r=(t.file,Layer.findById(t.parent_layer_id));this.undo_data?e=this.undo_data.layer:(t.img=null,e=Layer.create(n),this.undo_data={layer:e}),r.append(t.position,e),e.select()}}])&&nn(t.prototype,n),o}(_t);function cn(e){return(cn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function fn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function dn(e,t){return(dn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function hn(e,t){return!t||"object"!==cn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function pn(e){return(pn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e.name=n}(un,"name","LoadImage"),commandObjs.loadImage=un,Command.moveLayer=function(e,t){var n=e.param,r=ze.findById(n.layer_id),a=r.parent,i=a.children,o=n.parent_layer_id,s=n.position,l=i.indexOf(r);t&&(s=e.undo_data.before,o=e.undo_data.before_parent),o=ze.findById(o),s<0||o.children.length<s||l===s&&a===o||(a.children.splice(l,1),a.bubbleComposite(),r.div.parentNode,o.append(s,r),e.undo_data||(e.undo_data={before:l,before_parent:a.id}))},Command.multiCommand=function(e,t){var n=e.param.logs;if(t)for(var r=n.length;r--;){var a=n[r];Command[a.command](a,!0);var i=a.undo_data.difs;if(i)for(var o=a.param,s=(o.layer_id,Layer.findById(o.layer_id)),l=i.length;l--;){var u=i[l];Img.copy(s.img,u.x,u.y,u.img,0,0,u.img.width,u.img.height)}}else for(e.undo_data||(e.undo_data={}),r=0;r<n.length;r++)a=n[r],Command[a.command](a)},Command.resizeCanvas=function(e,t){var n=e.param.width,r=e.param.height,a=preview.width,i=preview.height;t&&(n=e.undo_data.width,r=e.undo_data.height),e.undo_data||(e.undo_data={width:a,height:i}),preview.width=n,preview.height=r,preview_ctx_imagedata=preview_ctx.createImageData(n,r),bloomed_img=new Img(n,r),bloom_img=new Img(n,r),root_layer.width=n,root_layer.height=r,root_layer.img=new Img(n,r),k.set(root_layer.size,n,r),inputs.canvas_width.value=root_layer.img.width,inputs.canvas_height.value=root_layer.img.height,root_layer.composite()},n(10),Command.translateLayer=function(e,t){var n=e.param,r=ze.findById(n.layer_id),a=n.x,i=n.y;if(t&&(a*=-1,i*=-1),e.undo_data||(e.undo_data={}),r)r.position[0]+=a,r.position[1]+=i,isNaN(r.position[0])&&(r.position[0]=0),isNaN(r.position[1])&&(r.position[1]=0),r.refreshDiv(),r.refreshImg();else{for(var o=root_layer.children,s=0;s<o.length;s++){var l=o[s];l.position[0]+=a,l.position[1]+=i,isNaN(l.position[0])&&(l.position[0]=0),isNaN(l.position[1])&&(l.position[1]=0),l.refreshDiv()}root_layer.composite()}},Xe.blendfuncs.normal=function(e,t,n,r,a,i){var o=n[r+3]*a,s=n[r+3]*a,l=e[t+3]*(1-s),u=1-s,c=l+s;0!=c&&(l*=c=1/c,s*=c,s*=i,e[t+0]=e[t+0]*l+n[r+0]*s,e[t+1]=e[t+1]*l+n[r+1]*s,e[t+2]=e[t+2]*l+n[r+2]*s,e[t+3]=e[t+3]*u+o)},Xe.blendfuncs.mul=function(e,t,n,r,a,i){var o=n[r+3]*a,s=1-o,l=i*o;e[t+0]=e[t+0]*(s+n[r+0]*l),e[t+1]=e[t+1]*(s+n[r+1]*l),e[t+2]=e[t+2]*(s+n[r+2]*l)},Xe.blendfuncs.add=function(e,t,n,r,a,i){var o=i*(n[r+3]*a);e[t+0]=e[t+0]+n[r+0]*o,e[t+1]=e[t+1]+n[r+1]*o,e[t+2]=e[t+2]+n[r+2]*o},Xe.blendfuncs.sub=function(e,t,n,r,a,i){var o=i*(n[r+3]*a);e[t+0]=e[t+0]-n[r+0]*o,e[t+1]=e[t+1]-n[r+1]*o,e[t+2]=e[t+2]-n[r+2]*o},Xe.blendfuncs.transmit=function(e,t,n,r,a,i){var o=n[r+3]*a,s=1-o,l=i*o;e[t+0]=e[t+0]*s*n[r+0]+n[r+0]*l,e[t+1]=e[t+1]*s*n[r+1]+n[r+1]*l,e[t+2]=e[t+2]*s*n[r+2]+n[r+2]*l,e[t+3]=e[t+3]*s+o};var vn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&dn(e,t)}(o,e);var t,n,r,a,i=(r=o,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=pn(r);if(a){var n=pn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return hn(this,e)});function o(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(e=i.call(this)).children=null,e}return t=o,(n=[{key:"beforeReflect",value:function(){}},{key:"reflect",value:function(e,t){this.beforeReflect(),ln=(sn=e).data;var n=Math.max(0,t[0]),r=Math.max(0,t[1]),a=Math.min(this.parent.size[0],t[2]+n),i=Math.min(this.parent.size[1],t[3]+r);sn.scan(this.getPixel,n-sn.offsetx,r-sn.offsety,a-n,i-r)}},{key:"getPixel",value:function(e,t,n,r){if(null==r&&(r=n,n=t,t=0),sn){t=sn.getIndex(n,r)<<2;var a=ln[t]+ln[t+1]+ln[t+2];a*=.33333,e[t+0]=a,e[t+1]=a,e[t+2]=a,e[t+3]=ln[t+3]}}}])&&fn(t.prototype,n),o}(ze);function mn(e){return(mn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function yn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function gn(e,t){return(gn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function bn(e,t){return!t||"object"!==mn(t)&&"function"!=typeof t?wn(e):t}function wn(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _n(e){return(_n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function xn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Xe.modifier.grayscale=vn;var kn,Mn,In=new I,En=new Me(1024,1024),Ln=function(e,t,n){return Math.max(t,Math.min(n,e))},Cn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&gn(e,t)}(o,e);var t,n,r,a,i=(r=o,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=_n(r);if(a){var n=_n(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return bn(this,e)});function o(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),xn(wn(e=i.call(this)),"typename","shift"),xn(wn(e),"beforeReflect",(function(){if(kn=0,Mn=0,this.children.length>=1){var e=this.children[0];e.beforeReflect(),kn=-this.position[0]-e.position[0],Mn=-this.position[1]-e.position[1]}})),e.effect=4,e.children=[],e}return t=o,(n=[{key:"before",value:function(e){var t=this.effect;e[0]-=t,e[1]-=t,e[2]+=t<<1,e[3]+=t<<1}},{key:"reflect",value:function(e,t){var n=this.effect>>1;t[0]+=n,t[1]+=n,t[2]-=n<<1,t[3]-=n<<1,En.data.length<e.data.length&&(En=new Me(e.width,e.height)),En.width=e.width,En.height=e.height,En.offsetx=e.offsetx,En.offsety=e.offsety,Me.copy(En,0,0,e,0,0,e.width,e.height),this.beforeReflect();for(var r=Math.max(0,t[0]),a=Math.max(0,t[1]),i=Math.min(this.parent.size[0],t[2]+r),o=Math.min(this.parent.size[1],t[3]+a),s=e.data,l=a;l<o;l++)for(var u=e.getIndex(r-e.offsetx,l-e.offsety)<<2,c=r;c<i;c++)this.getPixel(In,c,l),s[u+0]=In[0],s[u+1]=In[1],s[u+2]=In[2],s[u+3]=In[3],u+=4}},{key:"getPixel",value:function(e,t,n){var r=En,a=0,i=0;if(this.children.length>=1){this.children[0].getPixel(e,t+kn,n+Mn),a=e[0]-.5,i=e[1]-.5;var o=this.effect;a=a*o|0,i=i*o|0}var s=r.getIndex(Ln(t+a-r.offsetx,0,r.width-1),Ln(n+i-r.offsety,0,r.height-1))<<2;e[0]=r.data[s+0],e[1]=r.data[s+1],e[2]=r.data[s+2],e[3]=r.data[s+3]}}])&&yn(t.prototype,n),o}(ze);function On(e){return(On="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Bn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function An(e,t){return(An=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Pn(e,t){return!t||"object"!==On(t)&&"function"!=typeof t?Rn(e):t}function Rn(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Tn(e){return(Tn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}Xe.addModifierControl("shift",'\n\t\t\t影響度:<input type="text" class="slider modifier_effect" title="effect" value="0.5" min="0" max="100">\n\t\t'),Xe.modifier.shift=Cn;var Un=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&An(e,t)}(o,e);var t,n,r,a,i=(r=o,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=Tn(r);if(a){var n=Tn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return Pn(this,e)});function o(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(Rn(e=i.call(this)),"typename","blur"),e.scale=16,e}return t=o,(n=[{key:"showDivParam",value:function(){return"blursize:"+this.scale}},{key:"before",value:function(e){var t=2*Math.ceil(this.scale);e[0]-=t,e[1]-=t,e[2]+=t<<1,e[3]+=t<<1}},{key:"reflect",value:function(e,t){var n=Math.ceil(this.scale);t[0]+=n,t[1]+=n,t[2]-=n<<1,t[3]-=n<<1;var r=Math.max(0,t[0]-e.offsetx),a=Math.max(0,t[1]-e.offsety),i=Math.min(e.width,t[2]+r),o=Math.min(e.height,t[3]+a);e.gauss(n>>1,n,r,a,i-r,o-a)}}])&&Bn(t.prototype,n),o}(ze);function Vn(e){return(Vn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function jn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Sn(e,t){return(Sn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Dn(e,t){return!t||"object"!==Vn(t)&&"function"!=typeof t?Fn(e):t}function Fn(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Nn(e){return(Nn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}Xe.addModifierControl(Un.prototype.typename,'\n\t\t\tぼかし半径:<input class="slider modifier_scale" title="scale" step="1" min="1" max="128"><br>\n\t\t'),Ge.init(),Xe.modifier.blur=Un;for(var qn,zn,Xn=new Me(128,1),Yn=new Array,Hn=0;Hn<4;Hn++){var Wn={};Wn.color=new I,Wn.pos=0,Yn.push(Wn)}var Gn=new E,Qn=new E,Zn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Sn(e,t)}(o,e);var t,n,r,a,i=(r=o,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=Nn(r);if(a){var n=Nn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return Dn(this,e)});function o(){var e;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(Fn(e=i.call(this)),"typename","gradient");for(var t=0;t<4;t++){var n="col"+t;e[n]="0,0,0,1",e[n+"pos"]=1}return e.col1="1,1,1,1",e.col0pos=0,e.col1pos=1,e.radius=0,e}return t=o,(n=[{key:"showDivParam",value:function(){var e=this;return e.beforeReflect(),Gn[0]=1/128,Gn[1]=1,qn=64,zn=0,Xn.scan((function(t,n,r,a){e.getPixel(t,n,r,a)})),e.div.style.backgroundImage="url("+Xn.toDataURL()+"),url(./back.png)",""}},{key:"beforeReflect",value:function(){for(var e=0;e<4;e++){var t="col"+e,n=this[t].split(",");Yn[e].color[0]=0,Yn[e].color[1]=0,Yn[e].color[2]=0,Yn[e].color[3]=0,4===n.length&&(Yn[e].color[0]=Number(n[0]),Yn[e].color[1]=Number(n[1]),Yn[e].color[2]=Number(n[2]),Yn[e].color[3]=Number(n[3])),Yn[e].pos=this[t+"pos"]}for(Yn.sort((function(e,t){return e.pos-t.pos})),e=1;e<4;e++)Yn[e]._r=Yn[e].pos-Yn[e-1].pos,Yn[e]._r&&(Yn[e]._r=1/Yn[e]._r);var r=this.parent;r&&(qn=r.size[0]>>1,zn=r.size[1]>>1,E.rotate(Gn,this.radius*Math.PI/180,0,0,1),E.set(Qn,1/r.size[0],0,0,0,1/r.size[1],0,0,0,1),E.dot(Gn,Gn,Qn))}},{key:"reflect",value:function(e,t){var n=this,r=-this.position[0]+e.offsetx,a=-this.position[1]+e.offsety;e.scan((function(e,t,i,o){n.getPixel(e,t,i+r,o+a)}),t[0]-e.offsetx,t[1]-e.offsety,t[2],t[3])}},{key:"getPixel",value:function(e,t,n,r){var a=Gn[0]*(n-qn)+Gn[1]*(r-zn)+.5;a=Math.max(0,Math.min(a,1));for(var i=1;i<3&&!(a<=Yn[i].pos);i++);a=(a-Yn[i-1].pos)*Yn[i]._r,a=Math.max(0,Math.min(a,1));var o=Yn[i-1].color,s=Yn[i].color,l=1-a;e[t+0]=o[0]*l+s[0]*a,e[t+1]=o[1]*l+s[1]*a,e[t+2]=o[2]*l+s[2]*a,e[t+3]=o[3]*l+s[3]*a}}])&&jn(t.prototype,n),o}(ze);function Jn(e){return(Jn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Kn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function $n(e,t){return($n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function er(e,t){return!t||"object"!==Jn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function tr(e){return(tr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}Xe.addModifierControl("gradient",'\n\t\t角度:<input class="slider modifier_scale" title="radius" value="0" min="0" max="360"><br>\n\n\t\t<div class="modifier_gradient">\n\t\tR,G,B,A pos<br>\n\t\t<ul>\n\t\t<li>\n\t\t<input type="text" class="col " title="col0">\n\t\t<input class="slider pos" title="col0pos" min="0" max="1">\n\t\t</li>\n\n\t\t<li>\n\t\t<input type="text" class="col" title="col1">\n\t\t<input class="slider pos" title="col1pos" min="0" max="1">\n\t\t</li>\n\n\t\t<li>\n\t\t<input type="text" class="col" title="col2">\n\t\t<input class="slider pos" title="col2pos" min="0" max="1">\n\t\t</li>\n\n\t\t<li>\n\t\t<input type="text" class="col" title="col3">\n\t\t<input class="slider pos" title="col3pos" min="0" max="1">\n\t\t</li>\n\t\t</ul>\n\n\t\t</div>\n\t\t'),Ge.init(),Xe.modifier.gradient=Zn;var nr=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&$n(e,t)}(o,e);var t,n,r,a,i=(r=o,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=tr(r);if(a){var n=tr(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return er(this,e)});function o(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(e=i.call(this)).effect=4,e.children=[],e.gradtype="0",e}return t=o,(n=[{key:"showDivParam",value:function(){return"gradtype:"+this.gradtype}},{key:"beforeReflect",value:function(){this.children.length<1||this.children[0].beforeReflect()}},{key:"reflect",value:function(e,t){var n=Math.max(0,t[0]),r=Math.max(0,t[1]),a=Math.min(this.parent.size[0],t[2]+n),i=Math.min(this.parent.size[1],t[3]+r),o=this,s=e.offsetx,l=e.offsety;e.scan((function(e,t,n,r){o.getPixel(e,t,n+s,r+l)}),n-e.offsetx,r-e.offsety,a-n,i-r)}},{key:"getPixel",value:function(e,t,n,r){if(!(this.children.length<1)){var a,i;void 0===r&&(r=n,n=t,t=0),i=a="0"===this.gradtype?.33333*(e[t]+e[t+1]+e[t+2]):e[t+3],0,1,a=Math.max(0,Math.min(1,i)),e[t+3];var o=this.children[0];o.getPixel(e,t,a*(o.size[0]-1),0)}}}])&&Kn(t.prototype,n),o}(ze);function rr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}nr.prototype.typename="gradientmap",Xe.addModifierControl(nr.prototype.typename,'\n\t\t<input type="radio" name="gradtype" title="gradtype" value="0"/>明るさで判定\n\t\t<input type="radio" name="gradtype" title="gradtype" value="1"/>アルファ値で判定\n\t'),Xe.modifier.gradientmap=nr,Math.sqrt(3);var ar=-1/6,ir=function(e,t,n){return lr[e+lr[t+lr[255&n]&255]&255]},or=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"valuenoise",value:function(e,t,n){var r=t-(0|t),a=n-(0|n),i=255&e,o=255&t,s=255&n,l=mr(e-(0|e)),u=mr(r),c=mr(a);return br(c,br(u,br(l,vr(i,o,s),vr(i+1,o,s)),br(l,vr(i,o+1,s),vr(i+1,o+1,s))),br(u,br(l,vr(i,o,s+1),vr(i+1,o,s+1)),br(l,vr(i,o+1,s+1),vr(i+1,o+1,s+1))))*sr}},{key:"perlinnoise",value:function(e,t,n){var r=e-(0|e),a=t-(0|t),i=n-(0|n),o=255&e,s=255&t,l=255&n,u=mr(r),c=mr(a),f=mr(i);return.5*br(f,br(c,br(u,gr(vr(o,s,l),r,a,i),gr(vr(o+1,s,l),r-1,a,i)),br(u,gr(vr(o,s+1,l),r,a-1,i),gr(vr(o+1,s+1,l),r-1,a-1,i))),br(c,br(u,gr(vr(o,s,l+1),r,a,i-1),gr(vr(o+1,s,l+1),r-1,a,i-1)),br(u,gr(vr(o,s+1,l+1),r,a-1,i-1),gr(vr(o+1,s+1,l+1),r-1,a-1,i-1))))+.5}}],null&&rr(t.prototype,null),n&&rr(t,n),e}();!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(or,"simplexnoise",(function(e,t,n){var r,a,i,o,s,l,u=.3333333333333333*(e+t+n),c=Math.floor(e+u),f=Math.floor(t+u),d=Math.floor(n+u),h=(c+f+d)*ar,p=e-(c+h),v=t-(f+h),m=n-(d+h);p>=v?v>=m?(r=1,a=0,i=0,o=1,s=1,l=0):p>=m?(r=1,a=0,i=0,o=1,s=0,l=1):(r=0,a=0,i=1,o=1,s=0,l=1):v<m?(r=0,a=0,i=1,o=0,s=1,l=1):p<m?(r=0,a=1,i=0,o=0,s=1,l=1):(r=0,a=1,i=0,o=1,s=1,l=0);var y=p-(r+ar),g=v-(a+ar),b=m-(i+ar),w=p-(o+2*ar),_=v-(s+2*ar),x=m-(l+2*ar),k=p-.5,M=v-.5,I=m-.5;return 10*(yr(Math.max(.5-(p*p+v*v+m*m),0))*gr(ir(c,f,d),p,v,m)+yr(Math.max(.5-(y*y+g*g+b*b),0))*gr(ir(c+r,f+a,d+i),y,g,b)+yr(Math.max(.5-(w*w+_*_+x*x),0))*gr(ir(c+o,f+s,d+l),w,_,x)+yr(Math.max(.5-(k*k+M*M+I*I),0))*gr(ir(c+1,f+1,d+1),k,M,I))*.5+.5}));var sr=1/256,lr=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];lr=lr.concat(lr);var ur,cr,fr,dr,hr,pr,vr=function(e,t,n){return lr[lr[lr[e]+t]+n]},mr=function(e){return e*e*e*(e*(6*e-15)+10)},yr=function(e){return e*e},gr=function(e,t,n,r){switch(15&e){case 0:return t+n;case 1:return-t+n;case 2:return t-n;case 3:return-t-n;case 4:return t+r;case 5:return-t+r;case 6:return t-r;case 7:return-t-r;case 8:return n+r;case 9:return-n+r;case 10:return n-r;case 11:return-n-r;case 12:return n+t;case 13:return-n+r;case 14:return n-t;case 15:return-n-r;default:return 0}},br=function(e,t,n){return t*(1-e)+n*e};function wr(e){return(wr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function xr(e,t){return(xr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function kr(e,t){return!t||"object"!==wr(t)&&"function"!=typeof t?Mr(e):t}function Mr(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ir(e){return(Ir=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Er={perlin:or.perlinnoise,simplex:or.simplexnoise,value:or.valuenoise},Lr=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&xr(e,t)}(o,e);var t,n,r,a,i=(r=o,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=Ir(r);if(a){var n=Ir(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return kr(this,e)});function o(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(Mr(e=i.call(this)),"typename","noise"),e.scale=128,e.zoffset=0,e.octave=0,e.betsu=!1,e.func="simplex",e.children=null,e}return t=o,(n=[{key:"beforeReflect",value:function(){ur=1/this.scale,cr=Number(this.octave),fr=1/((1<<cr+1)-1),dr=this.betsu,pr=Er[this.func],hr=this.zoffset}},{key:"reflect",value:function(e,t){var n=t[0],r=t[1],a=t[2],i=t[3];this.beforeReflect();var o=this,s=-this.position[0]+e.offsetx,l=-this.position[1]+e.offsety;e.scan((function(e,t,n,r){o.calcPixel(e,t,n+s,r+l)}),n-e.offsetx,r-e.offsety,a,i)}},{key:"getPixel",value:function(e,t,n){this.calcPixel(e,0,t,n)}},{key:"calcPixel",value:function(e,t,n,r){var a=0,i=ur,o=1;dr&&(o=3);for(var s=0;s<o;s++){a=0;for(var l=0;l<cr+1;l++)a+=pr(n*(i=(1<<l)*ur)+.123*l+.321*s,r*i+.123*l+.321*s,hr*i+.123*l+s)*(1<<cr-l);e[s+t]=a*fr}dr||(e[1+t]=e[0+t],e[2+t]=e[0+t]),e[3+t]=1}}])&&_r(t.prototype,n),o}(ze);Xe.addModifierControl("noise",'\n\t\t\tfunc:<select class="modifier_func" title="func">\n\t\t\t\t<option value="perlin">Perlin</option>\n\t\t\t\t<option value="simplex">Simplex</option>\n\t\t\t\t<option value="value">Value</option>\n\t\t\t\t</select><br>\n\t\t\tスケール:<input class="slider modifier_scale" title="scale" value="32" min="1" max="256"><br>\n\t\t\tオクターブ数:<input class="slider modifier_octabe" title="octave" value="0" min="0" max="10" step="1"><br>\n\t\t\tZ(seed):<input class="slider modifier_z" title="zoffset" max="255"><br>\n\t\t\trgb別:<input type="checkbox" class="modifier_betsu" title="betsu"><br>\n\t\t'),Ge.init(),Xe.modifier.noise=Lr,window.Img=Me,window.CommandLog=tt,window.Redraw=Ae,window.Hdrpaint=Xe,window.Layer=ze,window.Brush=ut,window.painted_mask=new Float32Array(1048576),window.root_layer=null,window.selected_layer=null,Xe.inputs=inputs,doc.draw_col=new I,doc.scale=100,doc.canvas_pos=new k,doc.cursor_pos=new k,window.createModifier=function(e){if(""!==e.target.value){var t=e.target.value,n=Xe.getPosition();Xe.executeCommand("createmodifier",{modifier:t,parent_layer_id:n.parent_layer.id,position:n.position,width:n.parent_layer.size[0],height:n.parent_layer.size[1]})}},window.copylayer=function(e){var t=Xe.getPosition();Xe.executeCommand("copylayer",{position:t.position,parent:t.parent_layer.id,src_layer_id:selected_layer.id})},window.createNewCompositeLayer=function(e){var t=Xe.getPosition(),n=preview.width,r=preview.height;Xe.executeCommand("createNewCompositeLayer",{parent:t.parent_layer.id,position:t.position,width:n,height:r,composite_flg:1})},window.redo=function(){var e=inputs.history.selectedIndex,t=inputs.history.options;if(e!==t.length-1){var n=t[++e];inputs.history.selectedIndex=e,tt.moveLog(parseInt(n.value))}},window.undo=function(){var e=inputs.history.selectedIndex,t=inputs.history.options;if(0!==e){var n=t[e-1];n.disabled||(e--,inputs.history.selectedIndex=e,tt.moveLog(parseInt(n.value)))}},window.createNewLayer=function(e){var t=Xe.getPosition(),n=t.parent_layer.size[0],r=t.parent_layer.size[1];Xe.executeCommand("createNewLayer",{position:t.position,parent:t.parent_layer.id,width:n,height:r})};var Cr=Array.prototype.slice.call(document.getElementsByTagName("input"));Cr=Cr.concat(Array.prototype.slice.call(document.getElementsByTagName("select")));for(var Or=0;Or<Cr.length;Or++){var Br=Cr[Or].getAttribute("id");inputs[Br]=Cr[Or]}var Ar=function(e){var t=preview.getBoundingClientRect();doc.cursor_pos[0]=e.clientX-t.left-1,doc.cursor_pos[1]=e.clientY-t.top-1,doc.cursor_pos[0]*=100/doc.scale,doc.cursor_pos[1]*=100/doc.scale},Pr=Xe.changeColor=function(e){var t=new Float32Array(4);t[0]=inputs.color_R.value,t[1]=inputs.color_G.value,t[2]=inputs.color_B.value,t[3]=inputs.color_A.value;for(var n=[Rr],r=0;r<n.length;r++)e!==n[r]&&n[r].setRGB(t);ut.refreshPreview()};mt.redraw();var Rr=function(){var e={setRGB:function(e){var t=new M,n=Math.max(Math.max(e[0],Math.max(e[1],e[2])),1);M.mul(t,e,1/n),mt.setRGB(t),inputs.cs_default_lumi.value=Math.log2(n),W.fireEvent(inputs.cs_default_lumi,"input")}},t=function(){var e=Math.pow(2,parseFloat(inputs.cs_default_lumi.value));inputs.color_R.value=(mt.color[0]*e).toFixed(4),inputs.color_G.value=(mt.color[1]*e).toFixed(4),inputs.color_B.value=(mt.color[2]*e).toFixed(4),Pr(Rr)};return mt.func=t,document.getElementById("cs_default_lumi").addEventListener("change",t),e}(),Tr=function(e){for(var t=document.getElementById(e).getElementsByTagName("input"),n=0;n<t.length;n++){var r=t[n],a=document.getElementById("tab_"+r.id);a&&(r.checked?a.style.display="inline-block":a.style.display="none")}};window.refreshTab=Tr,document.body.onload=function e(t){if(W.getLoadingCount()>0)window.setTimeout(e,1e3);else{preview=document.getElementById("preview"),preview_ctx=preview.getContext("2d"),preview_ctx_imagedata=preview_ctx.createImageData(preview.width,preview.height),window.addEventListener("beforeunload",(function(e){return!(tt.command_logs.length>1&&(e.returnValue="移動前に表示する確認のメッセージ",1))}));for(var n=document.querySelector("#layer_blendfunc");n.firstChild;)n.removeChild(n.firstChild);for(var r=0;r<Xe.blendfuncsname.length;r++){var a=Xe.blendfuncsname[r],i=document.createElement("option");i.value=a,W.setText(i,a),n.appendChild(i)}var o=Object.keys(inputs);for(r=0;r<o.length;r++){var s=o[r],l=inputs[s];null===l.getAttribute("title")&&l.setAttribute("title",s)}new k;var u=function(e){var t=doc.cursor_pos[0],n=doc.cursor_pos[1];if(2&e.buttons||inputs.color_picker.checked){var r=root_layer.img;if(inputs.selected_layer_only.checked&&(r=selected_layer.img),t<0||t>=r.width||n<0||n>r.height);else{var a=r.data,i=4*((0|n)*r.width+(0|t));inputs.color_R.value=a[i],inputs.color_G.value=a[i+1],inputs.color_B.value=a[i+2],inputs.color_A.value=a[i+3],W.fireEvent(inputs.color_A,"input"),Pr(null)}}else if(pen_log)if(inputs.pen.checked){if(!pen_log)return;var o=new wt;o.pos[0]=t,o.pos[1]=n,1&e.buttons?"mouse"===e.pointerType?o.pressure=1:o.pressure=e.pressure:o.pressure=0;var s=pen_log.param.points;if(o.time=Date.now(),s.push(o),inputs.stroke_correction.checked&&s.length>=3&&pen_func.idx<s.length-2){var l=new k;k.sub(l,s[s.length-2].pos,s[s.length-3].pos),(f=k.scalar(l))>20&&(k.norm(l),k.mul(l,l,f-20)),k.add(s[s.length-2].pos,s[s.length-3].pos,l)}if(!(1&e.buttons)&&(s=pen_log.param.points,pen_func.idx+1<s.length))for(var u=s.length-(pen_func.idx+1),f=s[pen_func.idx].pressure,d=s[s.length-1].pressure,h=pen_func.idx+1;h<s.length;h++){var p=(h-pen_func.idx)/u;s[h].pressure=f+(d-f)*p}1&e.buttons||(pen_func.end(),o.pressure=0,pen_log=null),pen_func.actualDraw()}else if(inputs.translate.checked){if(1&e.buttons&&pen_log){var v=pen_log.param.x,m=pen_log.param.y;t=(0|t)-c[0],n=(0|n)-c[1],pen_log.param.x=t-v,pen_log.param.y=n-m,Command[pen_log.command](pen_log),pen_log.param.x=t,pen_log.param.y=n,pen_log.refreshLabel()}1&e.buttons||(pen_log=null)}};window.addEventListener("pointerup",(function(e){Ar(e),pen_log&&(u(e),e.preventDefault()),ze.enableRefreshThumbnail=!0})),document.querySelector("#canvas_field").addEventListener("pointermove",(function(e){Ar(e),Ae.refreshPreviewStatus(e),e.buttons&&(u(e),e.preventDefault())})),preview.addEventListener("contextmenu",(function(e){event.preventDefault()}),!1);var c=new k;preview.addEventListener("pointerdown",(function(e){Ar(e);var t=doc.cursor_pos[0],n=doc.cursor_pos[1];if(c[0]=t,c[1]=n,ze.enableRefreshThumbnail=!1,null!==selected_layer){if(inputs.fill.checked&&1&e.buttons){if(1===selected_layer.type)return;var r=root_layer.img;if(t<0||t>=r.width||n<0||n>=r.height)return;var a=selected_layer;if(t<0||t>=a.img.width||n<0||n>=a.img.height)return;var i=new Float32Array(4);i[0]=inputs.color_R.value,i[1]=inputs.color_G.value,i[2]=inputs.color_B.value,i[3]=inputs.color_A.value;var o=inputs.selected_layer_only.checked;Xe.executeCommand("fill",{layer_id:selected_layer.id,x:t,y:n,color:i,is_layer:o})}else if(inputs.translate.checked&&1&e.buttons){c[0]=0|t,c[1]=0|n;var s=-1;(o=inputs.selected_layer_only.checked)&&(s=selected_layer.id),pen_log=Xe.executeCommand("translateLayer",{layer_id:s,x:0,y:0},{x:selected_layer.position[0],y:selected_layer.position[1]},1)}else if(inputs.pen.checked&&1&e.buttons){if(0!==selected_layer.type)return;if(selected_layer.mask_alpha&&inputs.eraser.checked)return;var l={};ut.setParam(l),l.alpha_mask=selected_layer.mask_alpha,l.points=[],l.layer_id=selected_layer.id,pen_log=Xe.executeCommand("brush",l),pen_log&&(pen_func=new bt,pen_func.pen_log=pen_log,inputs.stroke_correction.checked?pen_func.ragtime=40:pen_func.ragtime=18,u(e))}u(e)}}),!1),inputs.history.addEventListener("change",(function(e){var t=this.selectedIndex,n=this.options[t];tt.moveLog(parseInt(n.value))})),document.addEventListener("keyup",(function(e){switch(e.keyCode,e.keyCode){case 81:f&&(f.checked=!0,f=null);break;case 87:inputs.selected_layer_only.checked=!1,Ae.refreshPreview(1)}}));var f=null;document.addEventListener("keydown",(function(e){if(e.ctrlKey,"INPUT"!==e.target.tagName||"text"!==e.target.type){for(var t=0;t<brushes.length;t++){var n=brushes[t];if(n.shortcut&&n.shortcut.toUpperCase().charCodeAt(0)===e.keyCode)return void n.select()}switch(e.keyCode){case 70:inputs.fill.checked=!0,Tr("tools");break;case 84:inputs.translate.checked=!0,Tr("tools");break;case 81:f||(f=document.querySelector("input[name='tool']:checked")),inputs.color_picker.checked=!0;break;case 82:Ae.compositeAll();break;case 90:e.ctrlKey&&(e.shiftKey?redo():Xe.undo()),e.preventDefault();break;case 46:if(1===selected_layer.type)break;Xe.executeCommand("clear",{layer_id:selected_layer.id});break;case 87:inputs.selected_layer_only.checked=!0,Ae.refreshPreview(1)}}})),inputs.color_A.addEventListener("change",(function(){Pr(null)})),document.getElementById("post_effect").addEventListener("change",(function(e){"bloom_power"===e.target.id&&Ae.refreshPreview(1),"ch_bloom"!==e.target.id&&"bloom_size"!==e.target.id||Ae.refreshPreview(0),"ch_gamma"!==e.target.id&&"gamma"!==e.target.id&&"ev"!==e.target.id||(Ae.refreshPreview(2),ze.eachLayers((function(e){e.registRefreshThumbnail()})))})),document.getElementById("tools").addEventListener("change",(function(e){Tr("tools")}));var d=function(){var e=parseInt(inputs.canvas_width.value),t=parseInt(inputs.canvas_height.value);Xe.executeCommand("resizeCanvas",{width:e,height:t})};inputs.canvas_width.addEventListener("change",d),inputs.canvas_height.addEventListener("change",d),inputs.btn_resize_layer.addEventListener("click",(function(e){var t=parseInt(preview.width),n=parseInt(preview.height);Xe.executeCommand("resizeLayer",{layer_id:selected_layer.id,width:t,height:n})})),inputs.btn_resize_layers.addEventListener("click",(function(e){var t=parseInt(preview.width),n=parseInt(preview.height);Xe.executeCommand("resizeLayer",{layer_id:-1,width:t,height:n})})),inputs.open_layer.addEventListener("change",(function(e){var t=this.files[0];t&&Xe.loadImageFile_(t),this.value=null})),document.getElementById("open_hpd").addEventListener("click",(function(e){var t=inputs.file_hpd;return t.onchange=function(){var e=t.files[0];vt.loadHpd(e),t.value=null},t.click(),e.preventDefault(),!1})),document.getElementById("add_brush").addEventListener("click",(function(e){var t=inputs.file_hpd;return t.onchange=function(){var e=t.files[0];W.loadBinary(e,(function(e){addBrush(e)})),t.value=null},t.click(),e.preventDefault(),!1})),inputs.down_layer.addEventListener("click",(function(e){if(selected_layer){var t=selected_layer.parent,n=t.children.indexOf(selected_layer);n<=0||Xe.executeCommand("moveLayer",{layer_id:selected_layer.id,parent_layer_id:t.id,position:n-1})}})),inputs.up_layer.addEventListener("click",(function(e){var t=selected_layer.parent,n=t.children,r=n.indexOf(selected_layer);r+1>=n.length||Xe.executeCommand("moveLayer",{layer_id:selected_layer.id,parent_layer_id:t.id,position:r+1})})),inputs.join_layer.addEventListener("click",(function(e){if(1!==selected_layer.type){var t=selected_layer.parent,n=t.children.indexOf(selected_layer);if(0!==n&&1!==t.children[n-1].type){var r=t.children[n-1].id;Xe.executeCommand("joinLayer",{layer_id:r,layer_id2:selected_layer.id})}}else Xe.executeCommand("composite",{layer_id:selected_layer.id})})),inputs.delete_layer.addEventListener("click",(function(e){Xe.executeCommand("deleteLayer",{layer_id:selected_layer.id})}));var h=new k;(y=document.getElementById("canvas_field")).addEventListener("pointerdown",(function(e){4&e.buttons&&(h[0]=e.pageX,h[1]=e.pageY,e.preventDefault())})),document.getElementById("canvas_field").addEventListener("pointermove",(function(e){if(4&e.buttons){doc.canvas_pos[0]+=e.pageX-h[0],doc.canvas_pos[1]+=e.pageY-h[1];var t=document.getElementById("canvas_field");document.getElementById("spcaer"),doc.canvas_pos[0]<0&&(t.scrollLeft-=doc.canvas_pos[0],doc.canvas_pos[0]=0),doc.canvas_pos[1]<0&&(doc.canvas_pos[1]=0),preview.style.left=doc.canvas_pos[0]+"px",preview.style.top=doc.canvas_pos[1]+"px",h[0]=e.pageX,h[1]=e.pageY}})),document.getElementById("canvas_area").addEventListener("wheel",(function(e){e.ctrlKey&&(e.preventDefault(),4&e.buttons||(event.deltaY>0?doc.scale<=100?doc.scale/=2:doc.scale-=100:doc.scale<=100?doc.scale*=2:doc.scale+=100,doc.scale<25&&(doc.scale=25),doc.scale>2e3&&(doc.scale=2e3),doc.scale>100?preview.style.imageRendering="pixelated":preview.style.imageRendering="auto",y.scrollX,y.clientWidth,y.scrollY,y.clientHeight,preview.style.width=preview.width*doc.scale/100+"px",preview.style.height=preview.height*doc.scale/100+"px",refreshPreviewStatus(e)))}));var p=document.getElementById("save_hpd");p.addEventListener("contextmenu",vt.saveHpd),p.addEventListener("click",vt.saveHpd),(p=document.getElementById("save_ldr")).addEventListener("contextmenu",vt.saveLdr),p.addEventListener("click",vt.saveLdr),(p=document.getElementById("save_hdr")).addEventListener("contextmenu",vt.saveHdr),p.addEventListener("click",vt.saveHdr);var v=location.search.substring(1,location.search.length).split("&");for(I.set(doc.draw_col,.8,.2,.2,1),Pr(null),r=v.length;r--;){var m=v[r].split("=");m.length>1&&(a=m[0],isNaN(m[1])||""==m[1]||m[1].length>1&&"0"==m[1].indexOf(0)?globalParam[a]=m[1]:globalParam[a]=+m[1]),inputs.hasOwnProperty(a)&&("checkbox"!=inputs[a].type&&"radio"!=inputs[a].type||!globalParam[a]?inputs[a].value=globalParam[a]:inputs[a].checked=!0,W.fireEvent(inputs[a],"input"))}if(mt.func(),globalParam.hasOwnProperty("file"))vt.loadHpd(globalParam.file);else{root_layer=ze.create(new Me(1,1),1),Xe.executeCommand("resizeCanvas",{width:512,height:512}),Xe.executeCommand("createNewLayer",{position:0,parent:root_layer.id,width:preview.width,height:preview.height}),document.querySelector("#canvas_area");var y=document.querySelector("#canvas_field");doc.canvas_pos[0]=y.clientWidth-512>>1,doc.canvas_pos[1]=y.clientHeight-512>>1,preview.style.left=doc.canvas_pos[0]+"px",preview.style.top=doc.canvas_pos[1]+"px";var g=root_layer.children[0],b=g.img.data;for(r=0;r<b.length;r++)b[r]=1;g.name="background",g.refreshDiv(),g.registRefreshThumbnail(),tt.reset(),Xe.executeCommand("createNewLayer",{position:1,parent:root_layer.id,width:preview.width,height:preview.height}),(g=root_layer.children[1]).name="default",g.refreshDiv(),g.registRefreshThumbnail(),root_layer.refreshDiv()}ut.init(),ze.init();var w=ut.create(),_=w;w.name="ペン",w.shortcut="a",w.weight_pressure_effect=!0,w.stroke_correction=!0,w.weight=5,brushes.push(w),w.refresh(),(w=ut.create()).name="消しゴム",w.eraser=!0,w.shortcut="s",w.weight=10,brushes.push(w),w.refresh(),ut.refreshBrush(),_.select()}}}()}();